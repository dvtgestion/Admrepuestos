<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Inventario ‚Äî Autopartes</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
      --primary:#1f6feb; --danger:#ef4444; --radius:12px;
      --shadow:0 1px 2px rgba(0,0,0,.04),0 6px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
    .app.no-sidebar{ grid-template-columns:1fr; min-height:100dvh; }
    .sidebar{border-right:1px solid var(--border); background:#fafafa; padding:16px; display:flex; flex-direction:column; gap:16px;}
    .hidden{display:none !important}

    .brand{display:flex; align-items:center; gap:12px; padding:8px 6px}
    .brand .logo{font-size:28px}
    .nav{display:flex; flex-direction:column; gap:6px}
    .nav-btn{ text-align:left; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .nav-btn:hover{border-color:#d1d5db}
    .sidebar-foot{ margin-top:auto; display:flex; flex-direction:column; gap:8px; }
    .user-label{font-size:12px; color:var(--muted)}

    .view{padding:24px; max-width:1200px; width:100%}

    .center{
      display:flex; align-items:center; justify-content:center;
      min-height:100dvh;
      padding:clamp(16px, 5vw, 48px);
      padding-top:calc(env(safe-area-inset-top,0px) + clamp(16px, 5vw, 48px));
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + clamp(16px, 5vw, 48px));
    }
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px;}
    .card-max{width:min(100%, 420px)}
    .title{margin:0 0 8px}
    .muted{color:var(--muted)}
    .xs{font-size:12px}

    .form{display:flex; flex-direction:column; gap:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field input, .field select, .input{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      width:100%;
      height:44px;
      font-size:16px;
    }
    .field input:focus, .field select:focus, .input:focus{outline:2px solid rgba(31,111,235,.25)}
    .btn{ border:1px solid var(--border); background:#fff; border-radius:10px; padding:10px 14px; cursor:pointer; height:44px; font-size:16px; }
    .btn-primary{background:var(--primary); color:#fff; border-color:transparent}
    .btn-ghost{background:transparent}
    .btn-danger{background:var(--danger); color:#fff; border-color:transparent}

    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .toolbar .right{display:flex; gap:8px; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:12px}

    .table-wrap{width:100%; overflow:auto}
    .table{width:100%; border-collapse:separate; border-spacing:0}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border)}
    .table th{font-weight:600; text-align:left; white-space:nowrap}
    .table td.num,.table th.num{text-align:right}

    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border);}
    .badge.low{background:#fff5f5; color:#b91c1c; border-color:#fecaca}

    .row-actions{display:flex; gap:8px; align-items:center}

    .grid{ display:grid; grid-template-columns:repeat(4, minmax(0, 1fr)); gap:12px; }
    .grid .field{min-width:0}

    .kpis{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
    .kpis .card h3{margin:0 0 6px; font-size:14px; color:var(--muted)}
    .kpis .card strong{font-size:20px}

    @media (max-width:1100px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width:900px){
      .app{grid-template-columns:1fr}
      .sidebar{position:sticky; top:0; z-index:10}
      .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    @media (max-width:600px){
      .view{padding:16px}
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr;}
      .toolbar .right{gap:6px}
    }

    #cam{width:1px;height:1px;position:absolute;left:-9999px;top:-9999px}
  </style>
</head>
<body>
  <div id="app" class="app no-sidebar">
    <aside id="sidebar" class="sidebar hidden" aria-hidden="true">
      <div class="brand">
        <div class="logo" aria-hidden="true">üîß</div>
        <div><strong>Autopartes</strong><small> Inventario</small></div>
      </div>
      <nav class="nav" aria-label="Navegaci√≥n principal">
        <button class="nav-btn" data-route="dashboard">Dashboard</button>
        <button class="nav-btn" data-route="inventario">Inventario</button>
        <button class="nav-btn" data-route="movimientos">Movimientos</button>
        <button class="nav-btn" data-route="sugerencias">Sugerencias</button>
        <button class="nav-btn" data-route="historial">Historial precios</button>
        <button class="nav-btn" data-route="ajustes">Ajustes</button>
      </nav>
      <div class="sidebar-foot">
        <span id="userLabel" class="user-label"></span>
        <button id="logoutBtn" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
    </aside>
    <main id="view" class="view"></main>
  </div>

  <!-- Templates -->
  <template id="tpl-login">
    <section class="center">
      <div class="card card-max" role="dialog" aria-labelledby="loginTitle">
        <h1 id="loginTitle" class="title" style="text-align:center">Iniciar sesi√≥n</h1>
        <p class="muted" style="text-align:center">Acceso interno ‚Äî Gesti√≥n de inventario de autopartes.</p>
        <form id="loginForm" class="form">
          <label class="field"><span>Correo</span>
            <input type="email" name="email" placeholder="admin@empresa.com" required autocomplete="username" />
          </label>
          <label class="field"><span>Contrase√±a</span>
            <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password" />
          </label>
          <button class="btn btn-primary" type="submit">Entrar</button>
          <p class="muted xs" style="text-align:center">Cree usuarios en Supabase ‚Üí Auth ‚Üí Users</p>
          <button id="clearCacheBtn" type="button" class="btn" title="Limpia empresa seleccionada y cierra sesi√≥n">Limpiar cach√© local</button>
        </form>
      </div>
    </section>
  </template>

  <template id="tpl-inventario">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Inventario</h2><p class="muted">Piezas registradas y estado de stock.</p></div>
        <div class="right">
          <select id="filterAlmacen" class="input" title="Filtrar por almac√©n"></select>
          <input id="searchParts" class="input" placeholder="Buscar por c√≥digo, nombre o categor√≠a‚Ä¶" />
          <label class="btn" for="importCSV">Importar CSV</label>
          <input id="importCSV" type="file" accept=".csv" style="display:none" />
          <button id="addPartBtn" class="btn btn-primary">A√±adir pieza</button>
        </div>
      </header>
      <details id="partFormWrap" class="card">
        <summary id="partFormSummary">Nueva pieza</summary>
        <form id="partForm" class="grid">
          <input type="hidden" name="id" />
          <label class="field"><span>C√≥digo</span>
            <div style="display:flex; gap:8px">
              <input name="codigo" required placeholder="ABC-123" style="flex:1" />
              <button type="button" id="scanBtn" class="btn">Escanear</button>
            </div>
            <video id="cam" playsinline></video>
          </label>
          <label class="field"><span>Nombre</span><input name="nombre" required placeholder="Filtro de aceite" /></label>
          <label class="field"><span>Categor√≠a</span><input name="categoria" placeholder="Motor, Suspensi√≥n, Frenos‚Ä¶" /></label>
          <label class="field"><span>Ubicaci√≥n</span><input name="ubicacion" placeholder="Estante A3" /></label>

          <!-- Almac√©n com sugest√µes + escrita livre -->
          <label class="field"><span>Almac√©n</span>
            <input name="almacen" list="almacenesList" placeholder="Central, Sucursal 1‚Ä¶" />
            <datalist id="almacenesList"></datalist>
          </label>

          <!-- Proveedor com sugest√µes + escrita livre -->
          <label class="field"><span>Proveedor</span>
            <input name="proveedor" list="proveedoresList" placeholder="Proveedor principal" />
            <datalist id="proveedoresList"></datalist>
          </label>

          <label class="field"><span>Lead time (d√≠as)</span><input name="leadTimeDias" type="number" min="0" step="1" value="0" /></label>

          <!-- Consumo diario / Stock m√≠nimo agora autom√°ticos (n√£o edit√°veis) -->
          <label class="field"><span style="opacity:.7">Consumo diario (auto)</span>
            <input name="consumoDiario" type="number" min="0" step="1" value="0" disabled />
          </label>
          <label class="field"><span style="opacity:.7">Stock m√≠nimo (auto)</span>
            <input name="stockMin" type="number" min="0" step="1" value="0" disabled />
          </label>

          <label class="field"><span>Costo unitario (Bs)</span><input name="costo" type="number" min="0" step="0.01" value="0" /></label>
          <label class="field"><span>Precio venta (Bs)</span><input name="precio" type="number" min="0" step="0.01" value="0" /></label>
          <div class="row-actions"><button class="btn btn-primary" type="submit">Guardar</button><button type="button" id="cancelEdit" class="btn btn-ghost">Cancelar</button></div>
        </form>
      </details>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="partsTable">
            <thead><tr>
              <th>C√≥digo</th><th>Nombre</th><th>Categor√≠a</th><th>Almac√©n</th><th>Ubicaci√≥n</th>
              <th class="num">Stock</th><th class="num">M√≠n (auto)</th><th class="num">Costo (Bs)</th><th class="num">Precio (Bs)</th><th></th>
            </tr></thead>
            <tbody id="partsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-movimientos">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Movimientos</h2><p class="muted">Entradas y salidas que afectan el stock.</p></div>
        <div class="right">
          <select id="moveAlmacenFilter" class="input" title="Filtrar piezas por almac√©n"></select>
          <button id="undoLast" class="btn">Deshacer √∫ltimo</button>
          <button id="exportCSV" class="btn">Exportar inventario (CSV)</button>
        </div>
      </header>
      <div class="card">
        <h3>Registrar movimiento</h3>
        <form id="moveForm" class="grid">
          <label class="field"><span>Pieza</span><select name="piezaId" id="movePart" required></select></label>
          <label class="field"><span>Tipo</span><select name="tipo" required><option value="entrada">Entrada</option><option value="salida">Salida</option></select></label>
          <label class="field"><span>Cantidad</span><input name="cantidad" type="number" min="1" step="1" required /></label>
          <label class="field"><span>Referencia</span><input name="referencia" placeholder="Factura, orden, motivo‚Ä¶" /></label>
          <div class="row-actions"><button type="submit" class="btn btn-primary">Aplicar</button></div>
        </form>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="movesTable">
            <thead><tr>
              <th>Fecha</th><th>C√≥digo</th><th>Nombre</th><th>Almac√©n</th><th>Tipo</th>
              <th class="num">Cantidad</th><th>Referencia</th><th>Usuario</th>
            </tr></thead>
            <tbody id="movesTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-sugerencias">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Sugerencias de compra</h2><p class="muted">Basado en consumo (30 d√≠as), lead time y stock m√≠nimo (auto).</p></div>
        <div class="right"><select id="sugAlmacenFilter" class="input" title="Filtrar por almac√©n"></select></div>
      </header>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="sugTable">
            <thead><tr>
              <th>C√≥digo</th><th>Nombre</th><th>Proveedor</th><th>Almac√©n</th>
              <th class="num">Stock</th><th class="num">CD</th><th class="num">LT</th>
              <th class="num">M√≠n (auto)</th><th class="num">Punto pedido</th><th class="num">Sugerido</th>
            </tr></thead>
            <tbody id="sugTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-ajustes">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Ajustes</h2><p class="muted">Empresa, backup y restauraci√≥n.</p></div>
        <div class="right">
          <button id="backupBtn" class="btn">Backup JSON</button>
          <label class="btn" for="restoreFile">Restaurar JSON</label>
          <input id="restoreFile" type="file" accept="application/json" style="display:none"/>
          <button id="resetBtn" class="btn btn-danger">Vaciar datos (empresa actual)</button>
        </div>
      </header>

      <div class="card" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <strong>Empresa actual:</strong>
        <span id="orgName">‚Äî</span>
        <select id="orgSelect" class="input"></select>
        <button id="orgNewBtn" class="btn">Nueva empresa</button>
      </div>
    </section>
  </template>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* =======================
       CONFIG SUPABASE + DEMANDA
    ======================= */
    const SUPABASE_URL = 'https://zbqshivafjhbghksuhkz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXNoaXZhZmpoYmdoa3N1aGt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MjAzMTEsImV4cCI6MjA3NTI5NjMxMX0.t89MkdRDYHTSs8-pk7gzglZMNlXxGG-VKIQl7Hu8vtE';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Par√¢metros de c√°lculo autom√°tico
    const DEMAND = {
      WINDOW_DAYS: 30,
      SAFETY_DAYS_FLOOR: 2,
      SERVICE_Z: 1.28
    };

    /* ===== Helpers ===== */
    function fmtMoney(n){ n = Number(n||0); return n.toLocaleString('es-BO', {style:'currency', currency:'BOB'}); }
    function fmtDate(d){ return new Date(d).toLocaleString(undefined, {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}); }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function csvCell(v){ const needsQuote = /[",\n]/.test(String(v)); const esc = String(v).replace(/"/g,'""'); return needsQuote ? `"${esc}"` : String(v); }
    function parseCSVLine(s){ const out=[]; let cur=''; let q=false; for(let i=0;i<s.length;i++){ const c=s[i]; if(c==='"'){ if(q && s[i+1]==='"'){cur+='"'; i++;} else {q=!q;} continue; } if(c===',' && !q){ out.push(cur); cur=''; continue; } cur+=c; } out.push(cur); return out; }

    /* ===== Auth ===== */
    const Auth = (() => {
      let cache = null; // {id,email}
      function set(user){
        cache = user ? { id:user.id, email:user.email } : null;
        if(cache) localStorage.setItem('authedUser', JSON.stringify(cache));
        else localStorage.removeItem('authedUser');
      }
      async function init(){
        const { data:{ user } } = await sb.auth.getUser();
        set(user || null);
        sb.auth.onAuthStateChange((_event, session)=>{
          set(session?.user || null);
          route();
        });
      }
      const isAuthed = () => !!cache;
      const currentUser = () => cache;
      async function login(email, password){
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) return { ok:false, error: error.message };
        return { ok:true };
      }
      async function logout(){ await sb.auth.signOut(); }
      return { init, isAuthed, currentUser, login, logout };
    })();

    /* ===== Empresa (Org) ===== */
    const Org = (() => {
      let currentId = localStorage.getItem('currentOrgId') || null;
      let currentName = localStorage.getItem('currentOrgName') || null;

      const get = () => ({ id: currentId, nombre: currentName });
      const set = (org) => {
        currentId = org?.id || null;
        currentName = org?.nombre || null;
        if (currentId) localStorage.setItem('currentOrgId', currentId); else localStorage.removeItem('currentOrgId');
        if (currentName) localStorage.setItem('currentOrgName', currentName); else localStorage.removeItem('currentOrgName');
      };

      async function myOrgs() {
        const { data:{ user } } = await sb.auth.getUser();
        const uid = user?.id;
        if(!uid) return [];
        const { data: mems, error } = await sb.from('org_members').select('org_id').eq('user_id', uid);
        if(error) throw error;
        if(!mems?.length) return [];
        const ids = mems.map(m=>m.org_id);
        const { data: orgs, error: e2 } = await sb.from('orgs').select('id, nombre').in('id', ids).order('nombre');
        if(e2) throw e2;
        return orgs;
      }

      async function ensureCurrent() {
        const orgs = await myOrgs();
        if (!orgs.length) {
          const nombre = prompt('Nombre de la empresa (crearemos una nueva ahora):');
          if(!nombre) throw new Error('Necesita crear/seleccionar una empresa para continuar.');
          const { data:{ user } } = await sb.auth.getUser();
          const { data: created, error } = await sb.from('orgs').insert({ nombre, created_by: user?.id }).select().maybeSingle();
          if (error) throw error;
          const { error: e2 } = await sb.from('org_members').insert({ org_id: created.id, user_id: user?.id });
          if (e2) throw e2;
          set(created);
          return created;
        }
        const found = orgs.find(o => o.id === currentId) || orgs[0];
        set(found);
        return found;
      }

      return { get, set, myOrgs, ensureCurrent };
    })();

    /* ===== DB ===== */
    const DB = (() => {
      function orgId(){ const o = Org.get(); if(!o?.id) throw new Error('Empresa no seleccionada'); return o.id; }

      async function listParts(){
        const { data, error } = await sb.from('parts').select('*').eq('org_id', orgId()).order('nombre',{ascending:true});
        if(error) throw error;
        return (data||[]).map(r => ({
          id:r.id, codigo:r.codigo, nombre:r.nombre, categoria:r.categoria, ubicacion:r.ubicacion,
          almacen:r.almacen, proveedor:r.proveedor,
          leadTimeDias:Number(r.lead_time_dias||0), consumoDiario:Number(r.consumo_diario||0),
          stock:Number(r.stock||0), stockMin:Number(r.stock_min||0),
          costo:Number(r.costo||0), precio:Number(r.precio||0)
        }));
      }

      async function upsertPart(part){
        const row = {
          org_id: orgId(),
          codigo: part.codigo, nombre: part.nombre,
          categoria: part.categoria || null, ubicacion: part.ubicacion || null,
          almacen: part.almacen || null, proveedor: part.proveedor || null,
          lead_time_dias: Number(part.leadTimeDias||0),
          consumo_diario: 0,         // <- sempre 0 (auto)
          stock_min: 0,              // <- sempre 0 (auto)
          stock: Number(part.stock||0),
          costo: Number(part.costo||0), precio: Number(part.precio||0)
        };
        if(part.id){
          const { error } = await sb.from('parts').update(row).eq('id', part.id).eq('org_id', orgId());
          if(error) throw error;
        }else{
          const { error } = await sb.from('parts').insert(row);
          if(error) throw error;
        }
      }

      async function deletePart(id){
        const { error } = await sb.from('parts').delete().eq('id', id).eq('org_id', orgId());
        if(error) throw error;
      }

      async function getPartById(id){
        const { data, error } = await sb.from('parts').select('*').eq('id', id).eq('org_id', orgId()).maybeSingle();
        if(error) throw error;
        return data;
      }

      async function listMoves(limit=5000){
        const { data, error } = await sb.from('movements').select('*').eq('org_id', orgId()).order('fecha',{ascending:false}).limit(limit);
        if(error) throw error; return data||[];
      }

      async function applyMovement({piezaId, tipo, cantidad, referencia, usuarioEmail}){
        const { data: p, error: e1 } = await sb.from('parts').select('*').eq('id', piezaId).eq('org_id', orgId()).maybeSingle();
        if(e1) throw e1;
        if(!p) throw new Error('Pieza no encontrada');
        cantidad = Number(cantidad||0);
        if(!(cantidad>0)) throw new Error('Cantidad inv√°lida');
        if(tipo === 'salida' && Number(p.stock) < cantidad) throw new Error('Stock insuficiente para la salida');

        const newStock = (tipo === 'salida') ? Number(p.stock) - cantidad : Number(p.stock) + cantidad;
        const { error: upErr } = await sb.from('parts').update({ stock: newStock }).eq('id', piezaId).eq('org_id', orgId());
        if(upErr) throw upErr;

        const { error: insErr } = await sb.from('movements').insert({
          org_id: orgId(),
          pieza_id: piezaId, codigo: p.codigo, nombre: p.nombre,
          almacen: p.almacen || '', tipo, cantidad,
          referencia: referencia || '', usuario: usuarioEmail || ''
        });
        if(insErr) throw insErr;
      }

      async function undoLastMovement(){
        const { data: last, error } = await sb.from('movements').select('*').eq('org_id', orgId()).order('fecha',{ascending:false}).limit(1).maybeSingle();
        if(error) throw error;
        if(!last) throw new Error('Sin movimientos');

        const { data: p, error: e1 } = await sb.from('parts').select('*').eq('id', last.pieza_id).eq('org_id', orgId()).maybeSingle();
        if(e1) throw e1;

        if(p){
          const newStock = last.tipo === 'entrada' ? Math.max(0, Number(p.stock) - Number(last.cantidad))
                                                  : Number(p.stock) + Number(last.cantidad);
          const { error: upErr } = await sb.from('parts').update({ stock: newStock }).eq('id', p.id).eq('org_id', orgId());
          if(upErr) throw upErr;
        }
        const { error: delErr } = await sb.from('movements').delete().eq('id', last.id).eq('org_id', orgId());
        if(delErr) throw delErr;
      }

      async function listPriceHistory(limit=500){
        const { data, error } = await sb.from('price_history').select('*').eq('org_id', orgId()).order('fecha',{ascending:false}).limit(limit);
        if(error) throw error;
        return (data||[]).map(h=>({
          fecha:h.fecha, codigo:h.codigo, nombre:h.nombre,
          costoAntes:h.costo_antes, costoDespues:h.costo_despues,
          precioAntes:h.precio_antes, precioDespues:h.precio_despues,
          usuario:h.usuario
        }));
      }

      async function addPriceHistory(entry){
        const row = {
          org_id: orgId(),
          pieza_id: entry.piezaId || null, codigo: entry.codigo, nombre: entry.nombre,
          costo_antes: Number(entry.costoAntes||0), costo_despues: Number(entry.costoDespues||0),
          precio_antes: Number(entry.precioAntes||0), precio_despues: Number(entry.precioDespues||0),
          usuario: entry.usuario || ''
        };
        const { error } = await sb.from('price_history').insert(row);
        if(error) throw error;
      }

      async function backupAll(){
        const [parts, moves, hist] = await Promise.all([listParts(), listMoves(10000), listPriceHistory(10000)]);
        return { parts, moves, priceHistory: hist };
      }

      async function restoreAll(jsonDump){
        if(Array.isArray(jsonDump.parts)){
          for(const p of jsonDump.parts){
            await upsertPart(p);
          }
        }
      }

      async function wipeCurrentOrg(){
        const oid = orgId();
        await sb.from('price_history').delete().eq('org_id', oid);
        await sb.from('movements').delete().eq('org_id', oid);
        await sb.from('parts').delete().eq('org_id', oid);
      }

      return { listParts, upsertPart, deletePart, getPartById, listMoves, applyMovement, undoLastMovement, listPriceHistory, addPriceHistory, backupAll, restoreAll, wipeCurrentOrg };
    })();

    /* ===== Demanda/Estoque m√≠nimo autom√°ticos (cliente) ===== */
    function buildMetrics(parts, moves){
      // janela de dias
      const days = DEMAND.WINDOW_DAYS;
      const end = new Date();
      const start = new Date(end); start.setDate(end.getDate() - (days - 1));
      const keyOf = d => d.toISOString().slice(0,10);

      // cria vetor de datas na janela
      const dayKeys = [];
      for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) dayKeys.push(keyOf(d));

      // mapa: partId -> vetor consumo di√°rio (somente SA√çDAS)
      const usage = new Map();
      for(const p of parts) usage.set(p.id, new Array(dayKeys.length).fill(0));

      for(const m of moves){
        if(m.tipo !== 'salida') continue;
        const didx = dayKeys.indexOf(keyOf(new Date(m.fecha)));
        if(didx === -1) continue;
        const arr = usage.get(m.pieza_id) || usage.get(m.piezaId);
        if(!arr) continue;
        arr[didx] += Number(m.cantidad||0);
      }

      const out = new Map();
      for(const p of parts){
        const arr = usage.get(p.id) || new Array(dayKeys.length).fill(0);
        const n = arr.length || 1;
        const mean = arr.reduce((a,b)=>a+b,0) / n;
        // desvio padr√£o amostral
        const variance = arr.reduce((s,x)=> s + Math.pow(x-mean,2), 0) / (n>1 ? (n-1) : 1);
        const sd = Math.sqrt(variance);
        const lt = Math.max(0, Number(p.leadTimeDias||0));
        const smVar = DEMAND.SERVICE_Z * sd * Math.sqrt(lt);
        const smFloor = mean * DEMAND.SAFETY_DAYS_FLOOR;
        const sm = Math.ceil(Math.max(smVar, smFloor));
        const rop = Math.ceil(mean * lt + sm);
        out.set(p.id, { cd: mean, sd, sm, rop });
      }
      return out;
    }

    /* ===== App / Roteamento ===== */
    const app = document.getElementById('app');
    const view = document.getElementById('view');
    const sidebar = document.getElementById('sidebar');
    const userLabel = document.getElementById('userLabel');
    const logoutBtn = document.getElementById('logoutBtn');
    const PUBLIC_ROUTES = ['login'];

    async function init(){
      await Auth.init();
      if(logoutBtn){
        logoutBtn.addEventListener('click', async () => { await Auth.logout(); location.hash = '#/login'; await route(); });
      }
      if(!Auth.isAuthed()) location.hash = '#/login';
      window.addEventListener('hashchange', route);
      await route();
    }

    function setNavActive(path){
      document.querySelectorAll('.nav-btn').forEach(btn=>{
        btn.classList.toggle('btn-primary', btn.dataset.route === path);
        btn.onclick = ()=>{ location.hash = '#/' + btn.dataset.route; };
      });
    }

    async function route(){
      const hash = location.hash || '#/login';
      const path = (hash.startsWith('#/')) ? hash.slice(2) : 'login';
      const authed = Auth.isAuthed();

      if(authed){
        try { await Org.ensureCurrent(); } catch(e){ /* ignore */ }
        sidebar.classList.remove('hidden'); sidebar.setAttribute('aria-hidden','false'); app.classList.remove('no-sidebar');
        const u = Auth.currentUser(); const org = Org.get();
        userLabel.textContent = u ? `Conectado como: ${u.email} ‚Äî Empresa: ${org?.nombre||'‚Äî'}` : '';
      }else{
        sidebar.classList.add('hidden'); sidebar.setAttribute('aria-hidden','true'); app.classList.add('no-sidebar');
      }

      if(!authed && !PUBLIC_ROUTES.includes(path)){ await renderLogin(); return; }

      switch(path){
        case 'login': await renderLogin(); break;
        case 'dashboard': await renderDashboard(); break;
        case 'inventario': await renderInventario(); break;
        case 'movimientos': await renderMovimientos(); break;
        case 'sugerencias': await renderSugerencias(); break;
        case 'ajustes': await renderAjustes(); break;
        case 'historial': await renderHistorial(); break;
        default:
          location.hash = authed ? '#/dashboard' : '#/login'; return;
      }
      if(authed) setNavActive(path);
    }

    /* --------- Vistas --------- */
    async function renderLogin(){
      const tpl = document.getElementById('tpl-login').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const form = document.getElementById('loginForm');
      const clearBtn = document.getElementById('clearCacheBtn');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const email = fd.get('email'); const password = fd.get('password');
        const res = await Auth.login(email, password);
        if(!res.ok){ alert(res.error || 'Error al iniciar sesi√≥n'); return; }
        location.hash = '#/dashboard'; await route();
      });

      clearBtn.addEventListener('click', async ()=>{
        localStorage.removeItem('currentOrgId');
        localStorage.removeItem('currentOrgName');
        await Auth.logout();
        alert('Cach√© local limpiada. Inicie sesi√≥n nuevamente.');
        location.hash = '#/login'; await route();
      });
    }

    async function renderDashboard(){
      const parts = await DB.listParts();
      const moves = await DB.listMoves();
      const metrics = buildMetrics(parts, moves);

      const valor = parts.reduce((s,p)=> s + Number(p.costo||0)*Number(p.stock||0), 0);
      const bajos = parts.filter(p => {
        const m = metrics.get(p.id) || { sm:0 };
        return Number(p.stock) < Number(m.sm||0);
      }).length;

      const hoy = new Date().toDateString();
      const movHoy = moves.filter(m => new Date(m.fecha).toDateString()===hoy).length;

      view.innerHTML = `
        <section class="stack">
          <div class="kpis">
            <div class="card"><h3>Valor inventario</h3><strong>${fmtMoney(valor)}</strong></div>
            <div class="card"><h3>√çtems bajo m√≠nimo</h3><strong>${bajos}</strong></div>
            <div class="card"><h3>Total SKUs</h3><strong>${parts.length}</strong></div>
            <div class="card"><h3>Movimientos hoy</h3><strong>${movHoy}</strong></div>
          </div>
          <div class="card"><p class="muted">Revise <strong>Sugerencias</strong> para reposici√≥n (c√°lculo autom√°tico con 30 d√≠as de historial, LT y buffer).</p></div>
        </section>`;
    }

    async function renderInventario(){
      const tpl = document.getElementById('tpl-inventario').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('partsTbody');
      const search = document.getElementById('searchParts');
      const addBtn = document.getElementById('addPartBtn');
      const formWrap = document.getElementById('partFormWrap');
      const form = document.getElementById('partForm');
      const summary = document.getElementById('partFormSummary');
      const cancelBtn = document.getElementById('cancelEdit');
      const importCSV = document.getElementById('importCSV');
      const filterAlm = document.getElementById('filterAlmacen');

      let parts = await DB.listParts();
      let moves = await DB.listMoves();
      let metrics = buildMetrics(parts, moves);

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        filterAlm.innerHTML = Array.from(set).map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      function populateDatalists(){
        const almSet = new Set(); const provSet = new Set();
        parts.forEach(p=>{ if(p.almacen) almSet.add(p.almacen.trim()); if(p.proveedor) provSet.add(p.proveedor.trim()); });
        document.getElementById('almacenesList').innerHTML = Array.from(almSet).map(a=>`<option value="${escapeHtml(a)}"></option>`).join('');
        document.getElementById('proveedoresList').innerHTML = Array.from(provSet).map(a=>`<option value="${escapeHtml(a)}"></option>`).join('');
      }
      buildAlmacenOptions();
      populateDatalists();

      function matchesFilters(p){
        const q = (search.value||'').toLowerCase().trim();
        const alm = filterAlm.value || '(Todos)';
        const tokens = [p.codigo, p.nombre, p.categoria, p.proveedor, p.almacen].map(x=>String(x||'').toLowerCase());
        const passQ = !q || tokens.some(t=>t.includes(q));
        const passA = alm === '(Todos)' || String(p.almacen||'').toLowerCase() === alm.toLowerCase();
        return passQ && passA;
      }

      async function paint(){
        tbody.innerHTML = '';
        parts.filter(matchesFilters).forEach(p=>{
          const m = metrics.get(p.id) || { sm:0 };
          const low = Number(p.stock) < Number(m.sm||0);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(p.codigo)}</td>
            <td>${escapeHtml(p.nombre)} ${low ? '<span class="badge low" title="Bajo stock respecto al m√≠nimo auto">Bajo stock</span>' : ''}</td>
            <td>${escapeHtml(p.categoria||'')}</td>
            <td>${escapeHtml(p.almacen||'')}</td>
            <td>${escapeHtml(p.ubicacion||'')}</td>
            <td class="num">${p.stock}</td>
            <td class="num" title="Calculado de movimientos">${m.sm||0}</td>
            <td class="num">${fmtMoney(p.costo)}</td>
            <td class="num">${fmtMoney(p.precio)}</td>
            <td class="num">
              <button class="btn btn-ghost" data-act="edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-danger" data-act="del" data-id="${p.id}">Eliminar</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }
      await paint();

      search.addEventListener('input', paint);
      filterAlm.addEventListener('change', paint);
      addBtn.addEventListener('click', ()=>{ form.reset(); form.querySelector('input[name="id"]').value = ''; summary.textContent = 'Nueva pieza'; formWrap.open = true; });
      cancelBtn.addEventListener('click', ()=>{ form.reset(); form.querySelector('input[name="id"]').value = ''; summary.textContent = 'Nueva pieza'; formWrap.open = false; });
      document.getElementById('scanBtn').addEventListener('click', startScan);

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const part = {
          id: fd.get('id') || undefined,
          codigo: String(fd.get('codigo')).trim(),
          nombre: String(fd.get('nombre')).trim(),
          categoria: String(fd.get('categoria')||'').trim(),
          ubicacion: String(fd.get('ubicacion')||'').trim(),
          almacen: String(fd.get('almacen')||'').trim(),
          proveedor: String(fd.get('proveedor')||'').trim(),
          leadTimeDias: Number(fd.get('leadTimeDias')||0),
          // consumoDiario / stockMin ignorados (auto)
          stock: Number(fd.get('stock')||0),
          costo: Number(fd.get('costo')||0),
          precio: Number(fd.get('precio')||0),
        };
        if(!part.codigo || !part.nombre){ alert('C√≥digo y nombre son obligatorios'); return; }

        try{
          await DB.upsertPart(part);
          parts = await DB.listParts(); moves = await DB.listMoves(); metrics = buildMetrics(parts, moves);
          buildAlmacenOptions(); populateDatalists(); await paint();
          form.reset(); form.querySelector('input[name="id"]').value = ''; summary.textContent = 'Nueva pieza'; formWrap.open = false;
        }catch(err){ alert(err.message || 'No se pudo guardar'); }
      });

      tbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-act]'); if(!btn) return;
        const id = btn.dataset.id; const act = btn.dataset.act;
        if(act === 'edit'){
          const p = parts.find(x => x.id === id) || await DB.getPartById(id); if(!p) return;
          formWrap.open = true; summary.textContent = `Editar: ${p.nombre}`;
          form.querySelector('input[name="id"]').value = p.id;
          form.querySelector('input[name="codigo"]').value = p.codigo;
          form.querySelector('input[name="nombre"]').value = p.nombre;
          form.querySelector('input[name="categoria"]').value = p.categoria || '';
          form.querySelector('input[name="ubicacion"]').value = p.ubicacion || '';
          form.querySelector('input[name="almacen"]').value = p.almacen || '';
          form.querySelector('input[name="proveedor"]').value = p.proveedor || '';
          form.querySelector('input[name="leadTimeDias"]').value = p.leadTimeDias || 0;
          form.querySelector('input[name="stock"]').value = p.stock;
          form.querySelector('input[name="costo"]').value = p.costo;
          form.querySelector('input[name="precio"]').value = p.precio;
        }
        if(act === 'del'){
          if(!confirm('¬øEliminar esta pieza? Esta acci√≥n no se puede deshacer.')) return;
          try{
            await DB.deletePart(id);
            parts = await DB.listParts(); moves = await DB.listMoves(); metrics = buildMetrics(parts, moves);
            buildAlmacenOptions(); populateDatalists(); await paint();
          }catch(err){ alert(err.message || 'No se pudo eliminar'); }
        }
      });

      importCSV.addEventListener('change', ()=>{
        const f = importCSV.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          try{
            const lines = String(reader.result||'').split(/\r?\n/).filter(Boolean);
            if(!lines.length){ alert('CSV vac√≠o'); return; }
            const head = lines.shift().split(',').map(h=>h.trim());
            for(const line of lines){
              const cells = parseCSVLine(line);
              const obj = Object.fromEntries(head.map((h,i)=>[h, (cells[i]??'').trim()]));
              const part = {
                codigo: obj.codigo, nombre: obj.nombre, categoria: obj.categoria,
                ubicacion: obj.ubicacion, almacen: obj.almacen, proveedor: obj.proveedor,
                leadTimeDias: Number(obj.leadTimeDias||0),
                stock: Number(obj.stock||0),
                costo: Number(obj.costo_Bs||obj.costo||0), precio: Number(obj.precio_Bs||obj.precio||0)
              };
              await DB.upsertPart(part);
            }
            parts = await DB.listParts(); moves = await DB.listMoves(); metrics = buildMetrics(parts, moves);
            buildAlmacenOptions(); populateDatalists(); await paint();
            alert('Importaci√≥n completa');
          }catch(e){ alert(e.message || 'Error al importar'); }
          importCSV.value = '';
        };
        reader.readAsText(f);
      });
    }

    async function renderMovimientos(){
      const tpl = document.getElementById('tpl-movimientos').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const moveForm = document.getElementById('moveForm');
      const partSel = document.getElementById('movePart');
      const tbody = document.getElementById('movesTbody');
      const exportBtn = document.getElementById('exportCSV');
      const undoBtn = document.getElementById('undoLast');
      const almFilter = document.getElementById('moveAlmacenFilter');

      let parts = await DB.listParts();
      let moves = await DB.listMoves();

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        almFilter.innerHTML = Array.from(set).map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      buildAlmacenOptions();

      function fillPartOptions(){
        const alm = almFilter.value || '(Todos)';
        const list = parts.filter(p => alm === '(Todos)' || String(p.almacen||'').toLowerCase()===alm.toLowerCase());
        partSel.innerHTML = list.map(p=>(
          `<option value="${p.id}">${escapeHtml(p.codigo)} ‚Äî ${escapeHtml(p.nombre)} (${escapeHtml(p.almacen||'')})</option>`
        )).join('');
      }
      fillPartOptions();

      function paintMoves(){
        tbody.innerHTML = '';
        moves.forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(m.fecha)}</td>
            <td>${escapeHtml(m.codigo)}</td>
            <td>${escapeHtml(m.nombre)}</td>
            <td>${escapeHtml(m.almacen||'')}</td>
            <td>${m.tipo === 'entrada' ? 'Entrada' : 'Salida'}</td>
            <td class="num">${m.cantidad}</td>
            <td>${escapeHtml(m.referencia||'')}</td>
            <td>${escapeHtml(m.usuario||'')}</td>`;
          tbody.appendChild(tr);
        });
      }
      paintMoves();

      almFilter.addEventListener('change', fillPartOptions);

      moveForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(moveForm);
        const piezaId = fd.get('piezaId'); const tipo = fd.get('tipo'); const cantidad = Number(fd.get('cantidad')); const referencia = String(fd.get('referencia')||'').trim();
        if(!piezaId || !tipo || !(cantidad>0)){ alert('Complete los campos del movimiento'); return; }
        try{
          const u = Auth.currentUser();
          await DB.applyMovement({piezaId, tipo, cantidad, referencia, usuarioEmail: u?u.email:''});
          parts = await DB.listParts(); moves = await DB.listMoves();
          paintMoves(); fillPartOptions();
          alert('Movimiento registrado');
        }catch(err){ alert(err.message || 'Error al aplicar movimiento'); }
      });

      exportBtn.addEventListener('click', async ()=>{
        const p = await DB.listParts();
        const head = ['id','codigo','nombre','categoria','almacen','proveedor','leadTimeDias','ubicacion','stock','costo_Bs','precio_Bs'];
        const rows = p.map(pt=>{
          const row = { id:pt.id, codigo:pt.codigo, nombre:pt.nombre, categoria:pt.categoria, almacen:pt.almacen, proveedor:pt.proveedor, leadTimeDias:pt.leadTimeDias, ubicacion:pt.ubicacion, stock:pt.stock, costo_Bs:pt.costo, precio_Bs:pt.precio };
          return head.map(k=>csvCell(row[k] ?? '')).join(',');
        });
        const csv = head.join(',') + '\n' + rows.join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = url; a.download = `inventario_${stamp}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      });

      undoBtn.addEventListener('click', async ()=>{
        try{ await DB.undoLastMovement(); moves = await DB.listMoves(); paintMoves(); alert('Movimiento deshecho'); }
        catch(e){ alert(e.message || 'No se pudo deshacer'); }
      });
    }

    async function renderSugerencias(){
      const tpl = document.getElementById('tpl-sugerencias').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('sugTbody');
      const almFilter = document.getElementById('sugAlmacenFilter');
      let parts = await DB.listParts();
      let moves = await DB.listMoves();
      let metrics = buildMetrics(parts, moves);

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        almFilter.innerHTML = Array.from(set).map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      buildAlmacenOptions();

      function calcular(){
        const alm = almFilter.value || '(Todos)';
        const base = parts.filter(p => alm === '(Todos)' || String(p.almacen||'').toLowerCase()===alm.toLowerCase());
        return base.map(p=>{
          const m = metrics.get(p.id) || { cd:0, sm:0, rop:0 };
          const sug = Math.max(0, (m.rop||0) - Number(p.stock||0));
          return {...p, cd: m.cd, sm: m.sm, rop: m.rop, sugerido: sug};
        }).filter(x=>x.sugerido>0);
      }

      function paint(){
        const list = calcular();
        tbody.innerHTML = '';
        list.forEach(p=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(p.codigo)}</td>
            <td>${escapeHtml(p.nombre)}</td>
            <td>${escapeHtml(p.proveedor||'')}</td>
            <td>${escapeHtml(p.almacen||'')}</td>
            <td class="num">${p.stock}</td>
            <td class="num">${(p.cd||0).toFixed(2)}</td>
            <td class="num">${p.leadTimeDias||0}</td>
            <td class="num">${p.sm||0}</td>
            <td class="num">${p.rop||0}</td>
            <td class="num">${p.sugerido||0}</td>`;
          tbody.appendChild(tr);
        });
      }
      almFilter.addEventListener('change', paint); paint();
    }

    async function renderAjustes(){
      const tpl = document.getElementById('tpl-ajustes').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const backupBtn = document.getElementById('backupBtn');
      const restoreFile = document.getElementById('restoreFile');
      const resetBtn = document.getElementById('resetBtn');

      const orgName = document.getElementById('orgName');
      const orgSelect = document.getElementById('orgSelect');
      const orgNewBtn = document.getElementById('orgNewBtn');

      (async ()=>{
        const orgs = await Org.myOrgs();
        const cur = Org.get();
        orgName.textContent = cur?.nombre || '‚Äî';
        orgSelect.innerHTML = orgs.map(o => `<option value="${o.id}" ${o.id===cur.id?'selected':''}>${escapeHtml(o.nombre)}</option>`).join('');
      })();

      orgSelect.addEventListener('change', async ()=>{
        const id = orgSelect.value;
        const { data, error } = await sb.from('orgs').select('id,nombre').eq('id', id).maybeSingle();
        if(error || !data){ alert('No se pudo cambiar de empresa'); return; }
        Org.set(data);
        alert('Empresa cambiada a: ' + data.nombre);
        location.hash = '#/dashboard'; await route();
      });

      orgNewBtn.addEventListener('click', async ()=>{
        const nombre = prompt('Nombre de la nueva empresa:'); if(!nombre) return;
        const { data:{ user } } = await sb.auth.getUser();
        const { data: org, error: e1 } = await sb.from('orgs').insert({ nombre, created_by: user?.id }).select().maybeSingle();
        if(e1){ alert(e1.message); return; }
        const { error: e2 } = await sb.from('org_members').insert({ org_id: org.id, user_id: user?.id });
        if(e2){ alert(e2.message); return; }
        Org.set(org);
        alert('Empresa creada y seleccionada: ' + org.nombre);
        location.hash = '#/dashboard'; await route();
      });

      backupBtn.addEventListener('click', async ()=>{
        try{
          const dump = await DB.backupAll();
          const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_inventario.json'; a.click();
        }catch(e){ alert(e.message || 'No se pudo hacer backup'); }
      });

      restoreFile.addEventListener('change', async ()=>{
        const f = restoreFile.files[0]; if(!f) return;
        try{
          const data = JSON.parse(await f.text());
          await DB.restoreAll(data);
          alert('Restauraci√≥n completa'); location.hash = '#/dashboard'; await route();
        }catch(e){ alert('Archivo inv√°lido / restauraci√≥n fall√≥'); }
        finally{ restoreFile.value = ''; }
      });

      resetBtn.addEventListener('click', async ()=>{
        if(!confirm('Esto borrar√° TODAS las piezas, movimientos e historial de la EMPRESA ACTUAL. ¬øContinuar?')) return;
        try{ await DB.wipeCurrentOrg(); alert('Datos borrados de la empresa actual'); location.hash = '#/dashboard'; await route(); }
        catch(e){ alert(e.message || 'No se pudo borrar'); }
      });
    }

    async function renderHistorial(){
      const tpl = document.getElementById('tpl-historial').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('histTbody');
      const hist = await DB.listPriceHistory();
      tbody.innerHTML = '';
      hist.forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(h.fecha)}</td>
          <td>${escapeHtml(h.codigo)}</td>
          <td>${escapeHtml(h.nombre)}</td>
          <td class="num">${fmtMoney(h.costoAntes)} ‚ûù ${fmtMoney(h.costoDespues)}</td>
          <td class="num">${fmtMoney(h.precioAntes)} ‚ûù ${fmtMoney(h.precioDespues)}</td>
          <td>${escapeHtml(h.usuario||'')}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* --------- Esc√°ner (opcional) --------- */
    async function startScan(){
      try{
        if(!('BarcodeDetector' in window)){ alert('Esc√°ner no soportado; ingrese el c√≥digo manualmente.'); return; }
        const video = document.getElementById('cam');
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
        video.srcObject = stream; await video.play();
        const det = new BarcodeDetector({formats:['code_128','ean_13','ean_8','qr_code','upc_a','upc_e']});
        const codeInput = document.querySelector('input[name="codigo"]');
        let running = true;
        const stop = ()=>{ running=false; if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); } video.srcObject=null; };
        const tick = async ()=>{
          if(!running) return;
          try{ const codes = await det.detect(video);
            if(codes.length){ codeInput.value = codes[0].rawValue || ''; stop(); alert('C√≥digo detectado: ' + codeInput.value); return; }
          }catch(e){}
          requestAnimationFrame(tick);
        };
        tick();
      }catch(err){ alert('No se pudo abrir la c√°mara'); }
    }

    // Boot
    init();
  </script>
</body>
</html>