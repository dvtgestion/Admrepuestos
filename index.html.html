<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Inventario ‚Äî Autopartes</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
      --primary:#1f6feb; --danger:#ef4444; --radius:12px;
      --shadow:0 1px 2px rgba(0,0,0,.04),0 6px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
    .app.no-sidebar{ grid-template-columns:1fr; min-height:100dvh; }
    .sidebar{border-right:1px solid var(--border); background:#fafafa; padding:16px; display:flex; flex-direction:column; gap:16px;}
    .hidden{display:none !important}

    .brand{display:flex; align-items:center; gap:12px; padding:8px 6px}
    .brand .logo{font-size:28px}
    .nav{display:flex; flex-direction:column; gap:6px}
    .nav-btn{ text-align:left; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .nav-btn:hover{border-color:#d1d5db}
    .sidebar-foot{ margin-top:auto; display:flex; flex-direction:column; gap:8px; }
    .user-label{font-size:12px; color:var(--muted)}

    .view{padding:24px; max-width:1200px; width:100%}

    .center{
      display:flex; align-items:center; justify-content:center;
      min-height:100dvh;
      padding:clamp(16px, 5vw, 48px);
      padding-top:calc(env(safe-area-inset-top,0px) + clamp(16px, 5vw, 48px));
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + clamp(16px, 5vw, 48px));
    }
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px;}
    .card-max{width:min(100%, 420px)}
    .title{margin:0 0 8px}
    .muted{color:var(--muted)}
    .xs{font-size:12px}

    .form{display:flex; flex-direction:column; gap:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field input, .field select, .input{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      width:100%;
      height:44px;
      font-size:16px;
    }
    .field input[readonly]{ background:#f8fafc; }
    .field input:focus, .field select:focus, .input:focus{outline:2px solid rgba(31,111,235,.25)}

    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:10px 14px;
      cursor:pointer;
      height:44px;
      font-size:16px;
    }
    .btn-primary{background:var(--primary); color:#fff; border-color:transparent}
    .btn-ghost{background:transparent}
    .btn-danger{background:var(--danger); color:#fff; border-color:transparent}

    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .toolbar .right{display:flex; gap:8px; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:12px}

    .table-wrap{width:100%; overflow:auto}
    .table{width:100%; border-collapse:separate; border-spacing:0}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border)}
    .table th{font-weight:600; text-align:left; white-space:nowrap}
    .table td.num,.table th.num{text-align:right}

    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border);}
    .badge.low{background:#fff5f5; color:#b91c1c; border-color:#fecaca}

    .row-actions{display:flex; gap:8px; align-items:center}

    .grid{ display:grid; grid-template-columns:repeat(4, minmax(0, 1fr)); gap:12px; }
    .grid .field{min-width:0}

    .kpis{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
    .kpis .card h3{margin:0 0 6px; font-size:14px; color:var(--muted)}
    .kpis .card strong{font-size:20px}

    /* chips de sugest√£o */
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }
    .chip { border:1px solid var(--border); background:#fff; border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer; }
    .chip:hover { border-color:#d1d5db }

    @media (max-width:1100px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width:900px){
      .app{grid-template-columns:1fr}
      .sidebar{position:sticky; top:0; z-index:10}
      .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    @media (max-width:600px){
      .view{padding:16px}
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr;}
      .toolbar .right{gap:6px}
    }

    #cam{width:1px;height:1px;position:absolute;left:-9999px;top:-9999px}

    /* ===== AJUSTES VISUAIS ADICIONADOS ===== */
    /* Inventario mais compacto e alinhado */
    #partsTable.table--compact{ font-size:14px; }
    #partsTable.table--compact th,
    #partsTable.table--compact td{ padding:6px 8px; }
    #partsTable th, #partsTable td{ vertical-align:middle; }
    #partsTable .num{ font-variant-numeric: tabular-nums; }
    .col-code{ max-width:140px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .col-name{ max-width:280px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
    .col-ubic{ max-width:140px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .col-actions{ white-space:nowrap; }
    .btn-xs{ height:28px; padding:4px 8px; font-size:12px; border-radius:8px; }
    .lot-subrow td{ background:#f9fafb; }
    .lot-subtable{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px; }
    .lot-subtable th,.lot-subtable td{ padding:6px 8px; border-bottom:1px solid var(--border); }
  </style>
</head>
<body>
  <div id="app" class="app no-sidebar">
    <aside id="sidebar" class="sidebar hidden" aria-hidden="true">
      <div class="brand">
        <div class="logo" aria-hidden="true">üîß</div>
        <div><strong>Autopartes</strong><small> Inventario</small></div>
      </div>
      <nav class="nav" aria-label="Navegaci√≥n principal">
        <button class="nav-btn" data-route="dashboard">Dashboard</button>
        <button class="nav-btn" data-route="inventario">Inventario</button>
        <button class="nav-btn" data-route="movimientos">Movimientos</button>
        <button class="nav-btn" data-route="sugerencias">Sugerencias</button>
        <button class="nav-btn" data-route="historial">Historial precios</button>
        <button class="nav-btn" data-route="ajustes">Ajustes</button>
      </nav>
      <div class="sidebar-foot">
        <span id="userLabel" class="user-label"></span>
        <button id="logoutBtn" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
    </aside>
    <main id="view" class="view"></main>
  </div>

  <!-- Templates -->
  <template id="tpl-login">
    <section class="center">
      <div class="card card-max" role="dialog" aria-labelledby="loginTitle">
        <h1 id="loginTitle" class="title" style="text-align:center">Iniciar sesi√≥n</h1>
        <p class="muted" style="text-align:center">Acceso interno ‚Äî Gesti√≥n de inventario de autopartes.</p>
        <form id="loginForm" class="form">
          <label class="field"><span>Correo</span>
            <input type="email" name="email" placeholder="admin@empresa.com" required autocomplete="username" />
          </label>
          <label class="field"><span>Contrase√±a</span>
            <input type="password" name="password" placeholder="********" required autocomplete="current-password" />
          </label>
          <button class="btn btn-primary" type="submit">Entrar</button>
          <p class="muted xs" style="text-align:center">Cree usuarios en Supabase ‚Üí Auth ‚Üí Users</p>
          <button id="clearCacheBtn" type="button" class="btn" title="Limpia empresa seleccionada y cierra sesi√≥n">Limpiar cach√© local</button>
        </form>
      </div>
    </section>
  </template>

  <template id="tpl-inventario">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Inventario</h2><p class="muted">Piezas registradas y estado de stock.</p></div>
        <div class="right">
          <select id="filterAlmacen" class="input" title="Filtrar por almac√©n"></select>
          <input id="searchParts" class="input" placeholder="Buscar por c√≥digo, nombre o categor√≠a‚Ä¶" />
          <label class="btn" for="importCSV">Importar CSV</label>
          <input id="importCSV" type="file" accept=".csv" style="display:none" />
          <button id="addPartBtn" class="btn btn-primary">A√±adir pieza</button>
        </div>
      </header>
      <details id="partFormWrap" class="card">
        <summary id="partFormSummary">Nueva pieza</summary>
        <form id="partForm" class="grid">
          <input type="hidden" name="id" />
          <label class="field"><span>C√≥digo</span>
            <div style="display:flex; gap:8px">
              <input name="codigo" required placeholder="ABC-123" style="flex:1" />
              <button type="button" id="scanBtn" class="btn">Escanear</button>
            </div>
            <video id="cam" playsinline></video>
          </label>
          <label class="field"><span>Nombre</span><input name="nombre" required placeholder="Filtro de aceite" /></label>
          <label class="field"><span>Categor√≠a</span><input name="categoria" placeholder="Motor, Suspensi√≥n, Frenos‚Ä¶" /></label>
          <label class="field"><span>Ubicaci√≥n</span><input name="ubicacion" placeholder="Estante A3" /></label>

          <!-- Almac√©n con datalist + chips -->
          <label class="field"><span>Almac√©n</span>
            <input name="almacen" placeholder="Central, Sucursal 1‚Ä¶" list="dlAlmacenes" />
            <datalist id="dlAlmacenes"></datalist>
            <div class="chips" id="almacenChips"></div>
            <span class="xs muted">Tip: puedes escribir libremente o hacer clic en un chip.</span>
          </label>

          <!-- Proveedor con datalist + chips -->
          <label class="field"><span>Proveedor</span>
            <input name="proveedor" placeholder="Proveedor principal" list="dlProveedores" />
            <datalist id="dlProveedores"></datalist>
            <div class="chips" id="proveedorChips"></div>
          </label>

          <label class="field"><span>Lead time (d√≠as)</span>
            <input name="leadTimeDias" type="number" min="0" step="1" value="0" />
          </label>

          <!-- AUTOM√ÅTICOS (solo lectura) -->
          <label class="field"><span>Consumo diario (auto)</span>
            <input name="consumoDiario" type="number" min="0" step="0.01" value="0" readonly
              title="Calculado autom√°ticamente por movimientos (√∫ltimos 30 d√≠as)" />
          </label>
          <label class="field"><span>Stock m√≠nimo (auto)</span>
            <input name="stockMin" type="number" min="0" step="1" value="0" readonly
              title="ceil(CD √ó d√≠as de seguridad)" />
          </label>

          <label class="field"><span>Stock</span><input name="stock" type="number" min="0" step="1" value="0" required /></label>
          <label class="field"><span>Costo unitario (Bs)</span><input name="costo" type="number" min="0" step="0.01" value="0" /></label>
          <label class="field"><span>Precio venta (Bs)</span><input name="precio" type="number" min="0" step="0.01" value="0" /></label>
          <div class="row-actions">
            <button class="btn btn-primary" type="submit">Guardar</button>
            <button type="button" id="cancelEdit" class="btn btn-ghost">Cancelar</button>
          </div>
        </form>
        <p class="muted xs">
          C√°lculo: CD = salidas/30d. Stock m√≠nimo = ceil(CD √ó <span id="safetyDaysHint"></span>).
          ROP = ceil(CD √ó (LT + <span id="safetyDaysHint2"></span>)).
        </p>
      </details>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="partsTable">
            <thead><tr>
              <th>C√≥digo</th><th>Nombre</th><th>Categor√≠a</th><th>Almac√©n</th><th>Ubicaci√≥n</th>
              <th class="num">Stock</th><th class="num">M√≠n</th>
              <th class="num">Costo (Bs)</th><th class="num">Precio (Bs)</th>
              <th class="num">Costo lote</th><th class="num">Precio lote</th>
              <th>Lotes</th><th></th>
            </tr></thead>
            <tbody id="partsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-movimientos">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Movimientos</h2><p class="muted">Entradas y salidas que afectan el stock.</p></div>
        <div class="right">
          <select id="moveAlmacenFilter" class="input" title="Filtrar piezas por almac√©n"></select>
          <button id="undoLast" class="btn btn-danger">Deshacer √∫ltimo</button>
          <button id="exportCSV" class="btn">Exportar inventario (CSV)</button>
        </div>
      </header>
      <div class="card">
        <h3>Registrar movimiento</h3>
        <form id="moveForm" class="grid">
          <label class="field"><span>Pieza</span>
            <select name="piezaId" id="movePart" required></select>
          </label>

          <label class="field"><span>Tipo</span>
            <select name="tipo" id="moveTipo" required>
              <option value="entrada">Entrada</option>
              <option value="salida">Salida</option>
            </select>
          </label>

          <label class="field"><span>Cantidad</span>
            <input name="cantidad" type="number" min="1" step="1" required />
          </label>

          <!-- CAMPOS EXTRAS PARA ENTRADA -->
          <div id="entradaFields" class="field" style="grid-column: span 2; display:none">
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px">
              <label class="field"><span>Costo unitario (Bs)</span>
                <input id="entradaCosto" type="number" step="0.01" min="0" placeholder="Costo deste lote" />
              </label>
              <label class="field"><span>Precio unitario (Bs)</span>
                <input id="entradaPrecio" type="number" step="0.01" min="0" placeholder="Precio deste lote" />
              </label>
            </div>
            <span class="xs muted">Estos valores se guardan en el <strong>lote</strong> que est√° entrando y no cambian el precio/costo base de la pieza.</span>
          </div>

          <!-- CAMPOS EXTRAS PARA SALIDA -->
          <div id="salidaFields" class="field" style="grid-column: span 2; display:none">
            <label class="field"><span>Seleccionar lote para salida</span>
              <select id="salidaLote"></select>
            </label>
            <div id="salidaLotesInfo" class="muted xs"></div>
          </div>

          <label class="field"><span>Referencia</span><input name="referencia" placeholder="Factura, orden, motivo‚Ä¶" /></label>

          <div class="row-actions" style="grid-column: 1 / -1"><button type="submit" class="btn btn-primary">Aplicar</button></div>
        </form>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="movesTable">
            <thead><tr>
              <th>Fecha</th><th>C√≥digo</th><th>Nombre</th><th>Almac√©n</th><th>Tipo</th>
              <th class="num">Cantidad</th><th>Referencia</th><th>Usuario</th><th></th>
            </tr></thead>
            <tbody id="movesTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-sugerencias">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Sugerencias de compra</h2><p class="muted">Basado en CD, lead time y stock m√≠nimo.</p></div>
        <div class="right"><select id="sugAlmacenFilter" class="input" title="Filtrar por almac√©n"></select></div>
      </header>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="sugTable">
            <thead><tr>
              <th>C√≥digo</th><th>Nombre</th><th>Proveedor</th><th>Almac√©n</th>
              <th class="num">Stock</th><th class="num">M√≠n</th><th class="num">CD</th><th class="num">LT</th>
              <th class="num">Punto pedido</th><th class="num">Sugerido</th>
            </tr></thead>
            <tbody id="sugTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-ajustes">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Ajustes</h2><p class="muted">Empresa, backup y restauraci√≥n.</p></div>
        <div class="right">
          <button id="backupBtn" class="btn">Backup JSON</button>
          <label class="btn" for="restoreFile">Restaurar JSON</label>
          <input id="restoreFile" type="file" accept="application/json" style="display:none"/>
          <button id="resetBtn" class="btn btn-danger">Vaciar datos (empresa actual)</button>
        </div>
      </header>

      <div class="card" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <strong>Empresa actual:</strong>
        <span id="orgName">‚Äî</span>
        <select id="orgSelect" class="input"></select>
        <button id="orgNewBtn" class="btn">Nueva empresa</button>
      </div>
    </section>
  </template>

  <template id="tpl-historial">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Historial de precios</h2><p class="muted">Cambios de costo y precio por pieza.</p></div>
        <div class="right"></div>
      </header>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="histTable">
            <thead><tr>
              <th>Fecha</th><th>C√≥digo</th><th>Nombre</th>
              <th class="num">Costo (antes ‚ûù despu√©s)</th><th class="num">Precio (antes ‚ûù despu√©s)</th><th>Usuario</th>
            </tr></thead>
            <tbody id="histTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* =======================
       CONFIG SUPABASE
    ======================= */
    const SUPABASE_URL = 'https://zbqshivafjhbghksuhkz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXNoaXZhZmpoYmdoa3N1aGt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MjAzMTEsImV4cCI6MjA3NTI5NjMxMX0.t89MkdRDYHTSs8-pk7gzglZMNlXxGG-VKIQl7Hu8vtE';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Par√¢metros do c√°lculo autom√°tico
    const CD_WINDOW_DAYS = 30;
    const SAFETY_DAYS   = 2; // d√≠as de seguridad (buffer al√©m do lead time)

    /* ===== Utils ===== */
    const fmtMoney = (n)=> Number(n||0).toLocaleString('es-BO', {style:'currency', currency:'BOB'});
    const fmtDate  = (d)=> new Date(d).toLocaleString(undefined, {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const escapeHtml = (s)=> String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const csvCell = (v)=> { const needsQuote = /[",\n]/.test(String(v)); const esc = String(v).replace(/"/g,'""'); return needsQuote ? `"${esc}"` : esc; };
    const parseCSVLine = (s)=>{ const out=[]; let cur=''; let q=false; for(let i=0;i<s.length;i++){ const c=s[i]; if(c==='"'){ if(q && s[i+1]==='"'){cur+='"'; i++;} else {q=!q;} continue; } if(c===',' && !q){ out.push(cur); cur=''; continue; } cur+=c; } out.push(cur); return out; };

    /* ===== Auth ===== */
    const Auth = (() => {
      let cache = null; // {id,email}
      function set(user){
        cache = user ? { id:user.id, email:user.email } : null;
        if(cache) localStorage.setItem('authedUser', JSON.stringify(cache));
        else localStorage.removeItem('authedUser');
      }
      async function init(){
        const { data:{ user } } = await sb.auth.getUser();
        set(user || null);
        sb.auth.onAuthStateChange((_event, session)=>{
          set(session?.user || null);
          route();
        });
      }
      const isAuthed = () => !!cache;
      const currentUser = () => cache;
      async function login(email, password){
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) return { ok:false, error: error.message };
        return { ok:true };
      }
      async function logout(){ await sb.auth.signOut(); }
      return { init, isAuthed, currentUser, login, logout };
    })();

    /* ===== Org ===== */
    const Org = (() => {
      let currentId = localStorage.getItem('currentOrgId') || null;
      let currentName = localStorage.getItem('currentOrgName') || null;

      const get = () => ({ id: currentId, nombre: currentName });
      const set = (org) => {
        currentId = org?.id || null;
        currentName = org?.nombre || null;
        if (currentId) localStorage.setItem('currentOrgId', currentId); else localStorage.removeItem('currentOrgId');
        if (currentName) localStorage.setItem('currentOrgName', currentName); else localStorage.removeItem('currentOrgName');
      };

      async function myOrgs() {
        const { data:{ user } } = await sb.auth.getUser();
        const uid = user?.id;
        if(!uid) return [];
        const { data: mems, error } = await sb.from('org_members').select('org_id').eq('user_id', uid);
        if(error) throw error;
        if(!mems?.length) return [];
        const ids = mems.map(m=>m.org_id);
        const { data: orgs, error: e2 } = await sb.from('orgs').select('id, nombre').in('id', ids).order('nombre');
        if(e2) throw e2;
        return orgs;
      }

      async function ensureCurrent() {
        const orgs = await myOrgs();
        if (!orgs.length) {
          const nombre = prompt('Nombre de la empresa (crearemos una nueva ahora):');
          if(!nombre) throw new Error('Necesita crear/seleccionar una empresa para continuar.');
          const { data:{ user } } = await sb.auth.getUser();
          const { data: created, error } = await sb.from('orgs').insert({ nombre, created_by: user?.id }).select().maybeSingle();
          if (error) throw error;
          const { error: e2 } = await sb.from('org_members').insert({ org_id: created.id, user_id: user?.id });
          if (e2) throw e2;
          set(created);
          return created;
        }
        const found = orgs.find(o => o.id === currentId) || orgs[0];
        set(found);
        return found;
      }

      return { get, set, myOrgs, ensureCurrent };
    })();
    
        /* ===== DB (Supabase) ===== */
    const DB = (() => {
      function orgId(){ const o = Org.get(); if(!o?.id) throw new Error('Empresa no seleccionada'); return o.id; }

      // ---- Parts ----
      async function listParts(){
        const { data, error } = await sb
          .from('parts')
          .select('id, org_id, codigo, nombre, categoria, ubicacion, almacen, proveedor, lead_time_dias, consumo_diario, stock, stock_min, costo, precio')
          .eq('org_id', orgId())
          .order('nombre',{ascending:true});
        if(error) throw error;
        return (data||[]).map(r => ({
          id:r.id, codigo:r.codigo, nombre:r.nombre, categoria:r.categoria||'',
          ubicacion:r.ubicacion||'', almacen:r.almacen||'', proveedor:r.proveedor||'',
          leadTimeDias:Number(r.lead_time_dias||0), consumoDiario:Number(r.consumo_diario||0),
          stock:Number(r.stock||0), stockMin:Number(r.stock_min||0),
          costo:Number(r.costo||0), precio:Number(r.precio||0)
        }));
      }

      async function getPartById(id){
        const { data, error } = await sb.from('parts')
          .select('id, org_id, codigo, nombre, categoria, ubicacion, almacen, proveedor, lead_time_dias, consumo_diario, stock, stock_min, costo, precio')
          .eq('id', id).eq('org_id', orgId()).maybeSingle();
        if(error) throw error;
        if(!data) return null;
        return {
          id:data.id, codigo:data.codigo, nombre:data.nombre, categoria:data.categoria||'',
          ubicacion:data.ubicacion||'', almacen:data.almacen||'', proveedor:data.proveedor||'',
          leadTimeDias:Number(data.lead_time_dias||0), consumoDiario:Number(data.consumo_diario||0),
          stock:Number(data.stock||0), stockMin:Number(data.stock_min||0),
          costo:Number(data.costo||0), precio:Number(data.precio||0)
        };
      }

      // ---- Movements ----
      async function listMoves(limit=500){
        const { data, error } = await sb.from('movements')
          .select('id, fecha, pieza_id, codigo, nombre, almacen, tipo, cantidad, referencia, usuario, costo_unit, precio_unit, lote_id')
          .eq('org_id', orgId())
          .order('fecha',{ascending:false})
          .limit(limit);
        if(error) throw error;
        return data||[];
      }

      // ---- Lotes ----
      async function listLots(partId){
        const { data, error } = await sb.from('part_lots')
          .select('id, qty, costo_unit, precio_unit')
          .eq('org_id', orgId())
          .eq('part_id', partId)
          .order('id', {ascending:true});
        if(error) throw error;
        return (data||[]).filter(l => Number(l.qty||0) > 0);
      }

      async function listAllLots(){
        const { data, error } = await sb.from('part_lots')
          .select('part_id, qty, costo_unit, precio_unit')
          .eq('org_id', orgId());
        if(error) throw error;
        return data||[];
      }

      async function inventoryValueFromLots(){
        const lots = await listAllLots();
        return lots.reduce((s,l)=> s + Number(l.qty||0)*Number(l.costo_unit||0), 0);
      }

      async function createLot({ partId, qty, costo_unit, precio_unit }){
        const { data, error } = await sb.from('part_lots')
          .insert({
            org_id: orgId(),
            part_id: partId,
            qty: Number(qty||0),
            costo_unit: Number(costo_unit||0),
            precio_unit: Number(precio_unit||0),
          })
          .select('id, qty, costo_unit, precio_unit')
          .maybeSingle();
        if(error) throw error;
        return data;
      }

      // Cria lote + movimento de ENTRADA para pe√ßa rec√©m-criada (estoque inicial)
      async function createInitialLotForPart({ partRow, qty, costo, precio }) {
        const q = Number(qty || 0);
        const c = Number(costo || 0);
        const p = Number(precio || 0);
        if (!(q > 0)) return;

        const { data: lot, error: e1 } = await sb
          .from('part_lots')
          .insert({
            org_id: orgId(),
            part_id: partRow.id,
            qty: q,
            costo_unit: c,
            precio_unit: p,
          })
          .select('id')
          .maybeSingle();
        if (e1) throw e1;

        const u = Auth.currentUser();
        const { error: e2 } = await sb.from('movements').insert({
          org_id: orgId(),
          pieza_id: partRow.id,
          codigo: partRow.codigo,
          nombre: partRow.nombre,
          almacen: partRow.almacen || '',
          tipo: 'entrada',
          cantidad: q,
          referencia: 'Entrada inicial (Inventario)',
          usuario: u ? u.email : '',
          costo_unit: c,
          precio_unit: p,
          lote_id: lot.id,
        });
        if (e2) throw e2;

        const { error: e3 } = await sb
          .from('parts')
          .update({ stock: q })
          .eq('id', partRow.id)
          .eq('org_id', orgId());
        if (e3) throw e3;
      }

      // Insert com lote-inicial; Update normal
      async function upsertPart(part){
        const base = {
          org_id: orgId(),
          codigo: part.codigo, nombre: part.nombre,
          categoria: part.categoria || null, ubicacion: part.ubicacion || null,
          almacen: part.almacen || null, proveedor: part.proveedor || null,
          lead_time_dias: Number(part.leadTimeDias||0),
          costo: Number(part.costo||0), precio: Number(part.precio||0),
        };

        if(part.id){
          const { error } = await sb.from('parts')
            .update(base)
            .eq('id', part.id).eq('org_id', orgId());
          if(error) throw error;
          return part.id;
        }else{
          const initialQty = Number(part.stock || 0);
          const rowInsert = {
            ...base,
            stock: 0,                 // come√ßa zerado; lote inicial ajusta
            consumo_diario: 0,
            stock_min: 0,
          };
          const { data: created, error } = await sb
            .from('parts')
            .insert(rowInsert)
            .select('id, codigo, nombre, almacen')
            .maybeSingle();
          if(error) throw error;

          if(initialQty > 0){
            await createInitialLotForPart({
              partRow: created,
              qty: initialQty,
              costo: part.costo,
              precio: part.precio
            });
          }
          return created.id;
        }
      }

      async function deletePart(id){
        // Deleta movimentos e lotes antes para evitar problemas de FK
        await sb.from('movements').delete().eq('org_id', orgId()).eq('pieza_id', id);
        await sb.from('part_lots').delete().eq('org_id', orgId()).eq('part_id', id);
        const { error } = await sb.from('parts').delete().eq('id', id).eq('org_id', orgId());
        if(error) throw error;
      }

      // ---- Aplicar movimento com lotes ----
      async function applyMovement({piezaId, tipo, cantidad, referencia, usuarioEmail, costoUnit, precioUnit, loteId}){
        const { data: p, error: e1 } = await sb.from('parts')
          .select('id, stock, codigo, nombre, almacen, costo, precio')
          .eq('id', piezaId).eq('org_id', orgId()).maybeSingle();
        if(e1) throw e1;
        if(!p) throw new Error('Pieza no encontrada');

        const q = Number(cantidad||0);
        if(!(q>0)) throw new Error('Cantidad inv√°lida');

        if(tipo === 'entrada'){
          const c = (costoUnit != null) ? Number(costoUnit) : Number(p.costo||0);
          const pr = (precioUnit != null) ? Number(precioUnit) : Number(p.precio||0);

          // cria novo lote com este custo/pre√ßo
          const lot = await createLot({ partId: p.id, qty: q, costo_unit: c, precio_unit: pr });

          // atualiza saldo da pe√ßa
          const { error: upErr } = await sb.from('parts')
            .update({ stock: Number(p.stock||0) + q })
            .eq('id', p.id).eq('org_id', orgId());
          if(upErr) throw upErr;

          // registra o movimento
          const { error: insErr } = await sb.from('movements').insert({
            org_id: orgId(),
            pieza_id: p.id, codigo: p.codigo, nombre: p.nombre,
            almacen: p.almacen || '', tipo: 'entrada', cantidad: q,
            referencia: referencia || '', usuario: usuarioEmail || '',
            costo_unit: c, precio_unit: pr, lote_id: lot.id
          });
          if(insErr) throw insErr;

        }else{ // SALIDA
          if(!loteId) throw new Error('Seleccione el lote para la salida');
          // buscar lote
          const { data: lot, error: el } = await sb.from('part_lots')
            .select('id, qty, costo_unit, precio_unit')
            .eq('org_id', orgId())
            .eq('id', loteId)
            .maybeSingle();
          if(el) throw el;
          if(!lot) throw new Error('Lote no encontrado');
          if(Number(lot.qty||0) < q) throw new Error('Cantidad supera el disponible del lote');

          // decrementa lote
          const { error: updLot } = await sb.from('part_lots')
            .update({ qty: Number(lot.qty||0) - q })
            .eq('id', lot.id).eq('org_id', orgId());
          if(updLot) throw updLot;

          // atualiza saldo da pe√ßa
          if(Number(p.stock||0) < q) throw new Error('Stock insuficiente para la salida');
          const { error: upErr2 } = await sb.from('parts')
            .update({ stock: Number(p.stock||0) - q })
            .eq('id', p.id).eq('org_id', orgId());
          if(upErr2) throw upErr2;

          // registra o movimento (com custo/pre√ßo do lote)
          const { error: insErr2 } = await sb.from('movements').insert({
            org_id: orgId(),
            pieza_id: p.id, codigo: p.codigo, nombre: p.nombre,
            almacen: p.almacen || '', tipo: 'salida', cantidad: q,
            referencia: referencia || '', usuario: usuarioEmail || '',
            costo_unit: Number(lot.costo_unit||0),
            precio_unit: Number(lot.precio_unit||0),
            lote_id: lot.id
          });
          if(insErr2) throw insErr2;
        }

        await recomputeMetrics(piezaId);
      }

      // ---- Desfazer √∫ltimo movimento (retrocompat√≠vel) ----
      async function undoLastMovement(){
        const { data: last, error } = await sb.from('movements')
          .select('id, pieza_id, tipo, cantidad, lote_id')
          .eq('org_id', orgId())
          .order('fecha',{ascending:false})
          .limit(1).maybeSingle();
        if(error) throw error;
        if(!last) throw new Error('Sin movimientos');
        await deleteMovementById(last.id);
      }

      // ---- Deshacer QUALQUER movimento pelo ID ----
      async function deleteMovementById(moveId){
        const { data: m, error } = await sb.from('movements')
          .select('id, pieza_id, tipo, cantidad, lote_id')
          .eq('org_id', orgId()).eq('id', moveId).maybeSingle();
        if(error) throw error;
        if(!m) throw new Error('Movimiento no encontrado');

        const q = Number(m.cantidad||0);

        const { data: p, error: ep } = await sb.from('parts')
          .select('id, stock').eq('id', m.pieza_id).eq('org_id', orgId()).maybeSingle();
        if(ep) throw ep;
        if(!p) throw new Error('Pieza no encontrada para el movimiento');

        if(m.tipo === 'entrada'){
          // Para deshacer entrada: precisamos que o lote ainda tenha pelo menos q dispon√≠vel
          if(m.lote_id){
            const { data: lot, error: el } = await sb.from('part_lots')
              .select('id, qty').eq('id', m.lote_id).eq('org_id', orgId()).maybeSingle();
            if(el) throw el;
            if(!lot) throw new Error('Lote de la entrada no encontrado');
            if(Number(lot.qty||0) < q) throw new Error('No se puede deshacer: parte del lote ya se consumi√≥');
            // reduzir lote e estoque
            const { error: upLot } = await sb.from('part_lots')
              .update({ qty: Number(lot.qty||0) - q })
              .eq('id', lot.id).eq('org_id', orgId());
            if(upLot) throw upLot;
          }
          // reduzir estoque da pe√ßa
          if(Number(p.stock||0) < q) throw new Error('No se puede deshacer: stock actual es menor que la entrada');
          const { error: upP } = await sb.from('parts')
            .update({ stock: Number(p.stock||0) - q })
            .eq('id', p.id).eq('org_id', orgId());
          if(upP) throw upP;
        }else{ // salida
          // devolver ao lote se existir
          if(m.lote_id){
            const { data: lot, error: el } = await sb.from('part_lots')
              .select('id, qty').eq('id', m.lote_id).eq('org_id', orgId()).maybeSingle();
            if(el) throw el;
            if(lot){
              const { error: upLot } = await sb.from('part_lots')
                .update({ qty: Number(lot.qty||0) + q })
                .eq('id', lot.id).eq('org_id', orgId());
              if(upLot) throw upLot;
            }
          }
          // somar no estoque da pe√ßa
          const { error: upP } = await sb.from('parts')
            .update({ stock: Number(p.stock||0) + q })
            .eq('id', p.id).eq('org_id', orgId());
          if(upP) throw upP;
        }

        // apaga o movimento
        const { error: delErr } = await sb.from('movements')
          .delete().eq('id', m.id).eq('org_id', orgId());
        if(delErr) throw delErr;

        await recomputeMetrics(m.pieza_id);
      }

      // ---- Historial de precios ----
      async function listPriceHistory(limit=500){
        const { data, error } = await sb.from('price_history')
          .select('fecha, codigo, nombre, costo_antes, costo_despues, precio_antes, precio_despues, usuario')
          .eq('org_id', orgId())
          .order('fecha',{ascending:false})
          .limit(limit);
        if(error) throw error;
        return (data||[]).map(h=>({
          fecha:h.fecha, codigo:h.codigo, nombre:h.nombre,
          costoAntes:h.costo_antes, costoDespues:h.costo_despues,
          precioAntes:h.precio_antes, precioDespues:h.precio_despues,
          usuario:h.usuario
        }));
      }

      async function addPriceHistory(entry){
        const row = {
          org_id: orgId(),
          pieza_id: entry.piezaId || null, codigo: entry.codigo, nombre: entry.nombre,
          costo_antes: Number(entry.costoAntes||0), costo_despues: Number(entry.costoDespues||0),
          precio_antes: Number(entry.precioAntes||0), precio_despues: Number(entry.precioDespues||0),
          usuario: entry.usuario || ''
        };
        const { error } = await sb.from('price_history').insert(row);
        if(error) throw error;
      }

      // ---- Backup simples ----
      async function backupAll(){
        const [parts, moves, hist] = await Promise.all([
          listParts(), listMoves(10000), listPriceHistory(10000)
        ]);
        return { parts, moves, priceHistory: hist };
      }

      async function restoreAll(jsonDump){
        if(Array.isArray(jsonDump.parts)){
          for(const p of jsonDump.parts){
            await upsertPart(p);
          }
        }
      }

      async function wipeCurrentOrg(){
        const oid = orgId();
        await sb.from('price_history').delete().eq('org_id', oid);
        await sb.from('movements').delete().eq('org_id', oid);
        await sb.from('part_lots').delete().eq('org_id', oid);
        await sb.from('parts').delete().eq('org_id', oid);
      }

      // ---- Recalcular m√©tricas autom√°ticas (CD e stock_min) ----
      async function recomputeMetrics(piezaId){
        const since = new Date(Date.now() - CD_WINDOW_DAYS*24*3600*1000).toISOString();
        const { data: outs, error } = await sb.from('movements')
          .select('cantidad')
          .eq('org_id', orgId())
          .eq('pieza_id', piezaId)
          .eq('tipo','salida')
          .gte('fecha', since);
        if(error) throw error;
        const totalOut = (outs||[]).reduce((s,m)=> s + Number(m.cantidad||0), 0);
        const cd = totalOut / CD_WINDOW_DAYS;
        const stockMin = Math.ceil(cd * SAFETY_DAYS);

        const { error: upErr } = await sb.from('parts')
          .update({ consumo_diario: cd, stock_min: stockMin })
          .eq('id', piezaId).eq('org_id', orgId());
        if(upErr) throw upErr;
      }

      return {
        listParts, getPartById, upsertPart, deletePart,
        listMoves, applyMovement, undoLastMovement, deleteMovementById,
        listLots, listAllLots, addPriceHistory, listPriceHistory,
        backupAll, restoreAll, wipeCurrentOrg, inventoryValueFromLots,
        recomputeMetrics
      };
    })();

    /* ===== App / Navega√ß√£o ===== */
    const appEl = document.getElementById('app');
    const view = document.getElementById('view');
    const sidebar = document.getElementById('sidebar');
    const userLabel = document.getElementById('userLabel');
    const logoutBtn = document.getElementById('logoutBtn');
    const PUBLIC_ROUTES = ['login'];

    async function init(){
      await Auth.init();
      if(logoutBtn){
        logoutBtn.addEventListener('click', async () => { await Auth.logout(); location.hash = '#/login'; await route(); });
      }
      if(!Auth.isAuthed()) location.hash = '#/login';
      window.addEventListener('hashchange', route);
      await route();
    }

    function setNavActive(path){
      document.querySelectorAll('.nav-btn').forEach(btn=>{
        btn.classList.toggle('btn-primary', btn.dataset.route === path);
        btn.onclick = ()=>{ location.hash = '#/' + btn.dataset.route; };
      });
    }

    async function route(){
      const hash = location.hash || '#/login';
      const path = (hash.startsWith('#/')) ? hash.slice(2) : 'login';
      const authed = Auth.isAuthed();

      if(authed){
        try { await Org.ensureCurrent(); } catch(e){ /* ignore */ }
        sidebar.classList.remove('hidden'); sidebar.setAttribute('aria-hidden','false'); appEl.classList.remove('no-sidebar');
        const u = Auth.currentUser(); const org = Org.get();
        userLabel.textContent = u ? `Conectado como: ${u.email} ‚Äî Empresa: ${org?.nombre||'‚Äî'}` : '';
      }else{
        sidebar.classList.add('hidden'); sidebar.setAttribute('aria-hidden','true'); appEl.classList.add('no-sidebar');
      }

      if(!authed && !PUBLIC_ROUTES.includes(path)){ await renderLogin(); return; }

      switch(path){
        case 'login': await renderLogin(); break;
        case 'dashboard': await renderDashboard(); break;
        case 'inventario': await renderInventario(); break;
        case 'movimientos': await renderMovimientos(); break;
        case 'sugerencias': await renderSugerencias(); break;
        case 'ajustes': await renderAjustes(); break;
        case 'historial': await renderHistorial(); break;
        default:
          location.hash = authed ? '#/dashboard' : '#/login';
          return;
      }
      if(authed) setNavActive(path);
    }

    /* ===== Vistas ===== */
    async function renderLogin(){
      const tpl = document.getElementById('tpl-login').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const form = document.getElementById('loginForm');
      const clearBtn = document.getElementById('clearCacheBtn');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const email = fd.get('email'); const password = fd.get('password');
        const res = await Auth.login(email, password);
        if(!res.ok){ alert(res.error || 'Error al iniciar sesi√≥n'); return; }
        location.hash = '#/dashboard'; await route();
      });

      clearBtn.addEventListener('click', async ()=>{
        localStorage.removeItem('currentOrgId');
        localStorage.removeItem('currentOrgName');
        await Auth.logout();
        alert('Cach√© local limpiada. Inicie sesi√≥n nuevamente.');
        location.hash = '#/login'; await route();
      });
    }

    async function renderDashboard(){
      const [parts, moves] = await Promise.all([DB.listParts(), DB.listMoves(5000)]);
      const valor = await DB.inventoryValueFromLots(); // **valor correto baseado nos lotes**

      const bajos = parts.filter(p => Number(p.stock)<Number(p.stockMin)).length;
      const hoyKey = new Date().toDateString();
      const movHoy = moves.filter(m => new Date(m.fecha).toDateString()===hoyKey).length;

      const partsMap = new Map(parts.map(p=>[p.id, p]));
      let bruto = 0, cogs = 0;
      for(const m of moves){
        if(m.tipo === 'salida'){
          const p = partsMap.get(m.pieza_id);
          const precio = (m.precio_unit != null) ? Number(m.precio_unit) : Number(p?.precio||0);
          const costo  = (m.costo_unit  != null) ? Number(m.costo_unit ) : Number(p?.costo ||0);
          bruto += precio * Number(m.cantidad||0);
          cogs  +=  costo * Number(m.cantidad||0);
        }
      }
      const liquida = bruto - cogs;

      view.innerHTML = `
        <section class="stack">
          <div class="kpis">
            <div class="card"><h3>Valor inventario</h3><strong>${fmtMoney(valor)}</strong></div>
            <div class="card"><h3>√çtems bajo m√≠nimo</h3><strong>${bajos}</strong></div>
            <div class="card"><h3>Total SKUs</h3><strong>${parts.length}</strong></div>
            <div class="card"><h3>Movimientos hoy</h3><strong>${movHoy}</strong></div>
          </div>
          <div class="kpis">
            <div class="card"><h3>Ventas brutas (salidas)</h3><strong>${fmtMoney(bruto)}</strong></div>
            <div class="card"><h3>COGS (costo de ventas)</h3><strong>${fmtMoney(cogs)}</strong></div>
            <div class="card"><h3>Ganancia l√≠quida</h3><strong>${fmtMoney(liquida)}</strong></div>
            <div class="card"><h3>D√≠as de seguridad</h3><strong>${SAFETY_DAYS}</strong></div>
          </div>
          <div class="card"><p class="muted">Los totales usan <strong>costo/precio por movimiento</strong> (lote). Si faltan, se usa el costo/precio actual de la pieza. El valor de inventario es la suma de (qty √ó costo del lote).</p></div>
        </section>`;
    }

    async function renderInventario(){
      const tpl = document.getElementById('tpl-inventario').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const table = document.getElementById('partsTable');
      table.classList.add('table--compact'); // visual mais ajustado

      const tbody = document.getElementById('partsTbody');
      const search = document.getElementById('searchParts');
      const addBtn = document.getElementById('addPartBtn');
      const formWrap = document.getElementById('partFormWrap');
      const form = document.getElementById('partForm');
      const summary = document.getElementById('partFormSummary');
      const cancelBtn = document.getElementById('cancelEdit');
      const importCSV = document.getElementById('importCSV');
      const filterAlm = document.getElementById('filterAlmacen');
      const safety1 = document.getElementById('safetyDaysHint');
      const safety2 = document.getElementById('safetyDaysHint2');
      if(safety1) safety1.textContent = SAFETY_DAYS;
      if(safety2) safety2.textContent = SAFETY_DAYS;

      let parts = await DB.listParts();

      function buildFilters(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        filterAlm.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }

      function buildSuggestors(){
        const dlAlm = document.getElementById('dlAlmacenes');
        const almChips = document.getElementById('almacenChips');
        const dlProv = document.getElementById('dlProveedores');
        const provChips = document.getElementById('proveedorChips');

        const almacenes = Array.from(new Set(parts.map(p=> (p.almacen||'').trim()).filter(Boolean))).sort();
        const proveedores = Array.from(new Set(parts.map(p=> (p.proveedor||'').trim()).filter(Boolean))).sort();

        dlAlm.innerHTML = almacenes.map(a=>`<option value="${escapeHtml(a)}">`).join('');
        almChips.innerHTML = almacenes.map(a=>`<button type="button" class="chip" data-v="${escapeHtml(a)}">${escapeHtml(a)}</button>`).join('');

        dlProv.innerHTML = proveedores.map(p=>`<option value="${escapeHtml(p)}">`).join('');
        provChips.innerHTML = proveedores.map(p=>`<button type="button" class="chip" data-v="${escapeHtml(p)}">${escapeHtml(p)}</button>`).join('');

        almChips.onclick = (e)=>{ const b = e.target.closest('.chip'); if(!b) return; form.querySelector('[name="almacen"]').value = b.dataset.v; };
        provChips.onclick = (e)=>{ const b = e.target.closest('.chip'); if(!b) return; form.querySelector('[name="proveedor"]').value = b.dataset.v; };
      }

      function matchesFilters(p){
        const q = (search.value||'').toLowerCase().trim();
        const alm = filterAlm.value || '(Todos)';
        const tokens = [p.codigo, p.nombre, p.categoria, p.proveedor, p.almacen].map(x=>String(x||'').toLowerCase());
        const passQ = !q || tokens.some(t=>t.includes(q));
        const passA = alm === '(Todos)' || String(p.almacen||'').toLowerCase() === alm.toLowerCase();
        return passQ && passA;
      }

      async function computeLotRange(partId){
        const lots = await DB.listLots(partId);
        if(!lots.length) return { costoTxt:'‚Äî', precioTxt:'‚Äî', lots:[] };
        const cmin = Math.min(...lots.map(l=>Number(l.costo_unit||0)));
        const cmax = Math.max(...lots.map(l=>Number(l.costo_unit||0)));
        const pmin = Math.min(...lots.map(l=>Number(l.precio_unit||0)));
        const pmax = Math.max(...lots.map(l=>Number(l.precio_unit||0)));
        const costoTxt = (cmin===cmax)? fmtMoney(cmin) : `${fmtMoney(cmin)}‚Äì${fmtMoney(cmax)}`;
        const precioTxt= (pmin===pmax)? fmtMoney(pmin): `${fmtMoney(pmin)}‚Äì${fmtMoney(pmax)}`;
        return { costoTxt, precioTxt, lots };
      }

      function renderLotSubtable(lots){
        if(!lots.length){
          return `<div class="muted xs">Sin lotes disponibles.</div>`;
        }
        const rows = lots.map((l,i)=>{
          const val = Number(l.qty||0)*Number(l.costo_unit||0);
          return `<tr>
            <td>#${i+1}</td>
            <td class="num">${l.qty}</td>
            <td class="num">${fmtMoney(l.costo_unit)}</td>
            <td class="num">${fmtMoney(l.precio_unit)}</td>
            <td class="num">${fmtMoney(val)}</td>
          </tr>`;
        }).join('');
        const totalQty = lots.reduce((s,l)=> s+Number(l.qty||0),0);
        const totalVal = lots.reduce((s,l)=> s+Number(l.qty||0)*Number(l.costo_unit||0),0);
        return `<table class="lot-subtable">
          <thead><tr><th>Lote</th><th class="num">Disp.</th><th class="num">Costo</th><th class="num">Precio</th><th class="num">Valor</th></tr></thead>
          <tbody>${rows}</tbody>
          <tfoot><tr><th>Total</th><th class="num">${totalQty}</th><th></th><th></th><th class="num">${fmtMoney(totalVal)}</th></tr></tfoot>
        </table>`;
      }

      async function paint(){
        tbody.innerHTML = '';
        const rows = parts.filter(matchesFilters);
        for(const p of rows){
          const low = Number(p.stock) < Number(p.stockMin);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="col-code">${escapeHtml(p.codigo)}</td>
            <td class="col-name">${escapeHtml(p.nombre)} ${low ? '<span class="badge low">Bajo stock</span>' : ''}</td>
            <td>${escapeHtml(p.categoria||'')}</td>
            <td>${escapeHtml(p.almacen||'')}</td>
            <td class="col-ubic">${escapeHtml(p.ubicacion||'')}</td>
            <td class="num">${p.stock}</td>
            <td class="num">${p.stockMin}</td>
            <td class="num">${fmtMoney(p.costo)}</td>
            <td class="num">${fmtMoney(p.precio)}</td>
            <td class="num" data-col="costoLote">‚Ä¶</td>
            <td class="num" data-col="precioLote">‚Ä¶</td>
            <td class="col-actions">
              <button class="btn btn-xs" data-act="toggleLots" data-id="${p.id}">Ver lotes</button>
            </td>
            <td class="col-actions">
              <button class="btn btn-ghost btn-xs" data-act="edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-danger btn-xs" data-act="del" data-id="${p.id}">Eliminar</button>
            </td>`;
          tbody.appendChild(tr);

          // Preencher range de lotes ass√≠ncrono
          (async ()=>{
            const { costoTxt, precioTxt } = await computeLotRange(p.id);
            const row = tr;
            const cCell = row.querySelector('[data-col="costoLote"]');
            const pCell = row.querySelector('[data-col="precioLote"]');
            if(cCell) cCell.textContent = costoTxt;
            if(pCell) pCell.textContent = precioTxt;
          })();
        }
      }

      buildFilters();
      buildSuggestors();
      paint();

      search.addEventListener('input', paint);
      filterAlm.addEventListener('change', paint);
      addBtn.addEventListener('click', ()=>{
        form.reset();
        form.querySelector('input[name="id"]').value = '';
        summary.textContent = 'Nueva pieza';
        formWrap.open = true;
      });
      cancelBtn.addEventListener('click', ()=>{
        form.reset();
        form.querySelector('input[name="id"]').value = '';
        summary.textContent = 'Nueva pieza';
        formWrap.open = false;
      });
      document.getElementById('scanBtn').addEventListener('click', startScan);

      // Toggle lotes (sub-fila)
      tbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-act="toggleLots"]');
        if(!btn) return;
        const tr = btn.closest('tr');
        const next = tr.nextElementSibling;
        if(next && next.classList.contains('lot-subrow')){ next.remove(); return; }
        const id = btn.dataset.id;
        const lots = await DB.listLots(id);
        const sub = document.createElement('tr');
        sub.className = 'lot-subrow';
        const cols = tr.children.length;
        sub.innerHTML = `<td colspan="${cols}">${renderLotSubtable(lots)}</td>`;
        tr.after(sub);
      });

      // Submit do form
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const part = {
          id: fd.get('id') || undefined,
          codigo: String(fd.get('codigo')).trim(),
          nombre: String(fd.get('nombre')).trim(),
          categoria: String(fd.get('categoria')||'').trim(),
          ubicacion: String(fd.get('ubicacion')||'').trim(),
          almacen: String(fd.get('almacen')||'').trim(),
          proveedor: String(fd.get('proveedor')||'').trim(),
          leadTimeDias: Number(fd.get('leadTimeDias')||0),
          stock: Number(fd.get('stock')||0), // estoque inicial -> lote inicial
          costo: Number(fd.get('costo')||0),
          precio: Number(fd.get('precio')||0),
        };
        if(!part.codigo || !part.nombre){ alert('C√≥digo y nombre son obligatorios'); return; }

        let prev = null; if(part.id){ prev = parts.find(x=>x.id===part.id); }
        try{
          const newId = await DB.upsertPart(part);
          const finalId = part.id || newId;

          // historial de precio si alterou base (edi√ß√£o)
          if(prev && (Number(prev.costo)!==Number(part.costo) || Number(prev.precio)!==Number(part.precio))){
            const u = Auth.currentUser();
            await DB.addPriceHistory({
              piezaId: finalId,
              codigo: prev.codigo, nombre: prev.nombre,
              costoAntes: Number(prev.costo)||0, costoDespues: Number(part.costo)||0,
              precioAntes: Number(prev.precio)||0, precioDespues: Number(part.precio)||0,
              usuario: u ? u.email : ''
            });
          }

          parts = await DB.listParts();
          buildFilters(); buildSuggestors(); await paint();

          form.reset(); form.querySelector('input[name="id"]').value = ''; summary.textContent = 'Nueva pieza'; formWrap.open = false;
        }catch(err){ alert(err.message || 'No se pudo guardar'); }
      });

      // A√ß√µes de linha (editar/deletar)
      tbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-act]'); if(!btn) return;
        const id = btn.dataset.id; const act = btn.dataset.act;
        if(act === 'edit'){
          const p = parts.find(x => x.id === id) || await DB.getPartById(id); if(!p) return;
          formWrap.open = true; summary.textContent = `Editar: ${p.nombre}`;
          form.querySelector('input[name="id"]').value = p.id;
          form.querySelector('input[name="codigo"]').value = p.codigo;
          form.querySelector('input[name="nombre"]').value = p.nombre;
          form.querySelector('input[name="categoria"]').value = p.categoria || '';
          form.querySelector('input[name="ubicacion"]').value = p.ubicacion || '';
          form.querySelector('input[name="almacen"]').value = p.almacen || '';
          form.querySelector('input[name="proveedor"]').value = p.proveedor || '';
          form.querySelector('input[name="leadTimeDias"]').value = p.leadTimeDias || 0;
          form.querySelector('input[name="consumoDiario"]').value = p.consumoDiario || 0;
          form.querySelector('input[name="stockMin"]').value = p.stockMin || 0;
          form.querySelector('input[name="stock"]').value = p.stock;
          form.querySelector('input[name="costo"]').value = p.costo;
          form.querySelector('input[name="precio"]').value = p.precio;
        }
        if(act === 'del'){
          if(!confirm('¬øEliminar esta pieza? Esto borrar√° tambi√©n sus lotes y movimientos.')) return;
          try{
            await DB.deletePart(id);
            parts = await DB.listParts(); buildFilters(); buildSuggestors(); await paint();
          }catch(err){ alert(err.message || 'No se pudo eliminar'); }
        }
      });

      importCSV.addEventListener('change', ()=>{
        const f = document.getElementById('importCSV').files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          try{
            const lines = String(reader.result||'').split(/\r?\n/).filter(Boolean);
            if(!lines.length){ alert('CSV vac√≠o'); return; }
            const head = lines.shift().split(',').map(h=>h.trim());
            for(const line of lines){
              const cells = parseCSVLine(line);
              const obj = Object.fromEntries(head.map((h,i)=>[h, (cells[i]??'').trim()]));
              const part = {
                codigo: obj.codigo, nombre: obj.nombre, categoria: obj.categoria,
                ubicacion: obj.ubicacion, almacen: obj.almacen, proveedor: obj.proveedor,
                leadTimeDias: Number(obj.leadTimeDias||0),
                stock: Number(obj.stock||0),                      // vira lote inicial
                costo: Number(obj.costo_Bs||obj.costo||0),
                precio: Number(obj.precio_Bs||obj.precio||0)
              };
              await DB.upsertPart(part);
            }
            parts = await DB.listParts(); buildFilters(); buildSuggestors(); await paint();
            alert('Importaci√≥n completa');
          }catch(e){ alert(e.message || 'Error al importar'); }
          document.getElementById('importCSV').value = '';
        };
        reader.readAsText(f);
      });
    }

    async function renderMovimientos(){
      const tpl = document.getElementById('tpl-movimientos').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const moveForm = document.getElementById('moveForm');
      const partSel = document.getElementById('movePart');
      const tipoSel = document.getElementById('moveTipo');
      const entradaFields = document.getElementById('entradaFields');
      const entradaCosto = document.getElementById('entradaCosto');
      const entradaPrecio = document.getElementById('entradaPrecio');
      const salidaFields = document.getElementById('salidaFields');
      const salidaLoteSel = document.getElementById('salidaLote');
      const salidaLotesInfo = document.getElementById('salidaLotesInfo');
      const tbody = document.getElementById('movesTbody');
      const exportBtn = document.getElementById('exportCSV');
      const undoBtn = document.getElementById('undoLast');
      const almFilter = document.getElementById('moveAlmacenFilter');
      const applyBtn = moveForm.querySelector('button[type="submit"]');

      let parts = await DB.listParts();
      let moves = await DB.listMoves(2000);

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        almFilter.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      buildAlmacenOptions();

      function fillPartOptions(){
        const alm = almFilter.value || '(Todos)';
        const list = parts.filter(p => alm === '(Todos)' || String(p.almacen||'').toLowerCase()===alm.toLowerCase());
        partSel.innerHTML = list.map(p=>(
          `<option value="${p.id}">${escapeHtml(p.codigo)} ‚Äî ${escapeHtml(p.nombre)} (${escapeHtml(p.almacen||'')})</option>`
        )).join('');
      }
      fillPartOptions();

      async function fillMoveLots(){
        if(tipoSel.value !== 'salida'){ salidaFields.style.display='none'; return; }
        const partId = partSel.value;
        if(!partId){ salidaLoteSel.innerHTML = ''; salidaLotesInfo.textContent = ''; return; }
        const lots = await DB.listLots(partId);
        if(!lots.length){
          salidaLoteSel.innerHTML = '';
          salidaLotesInfo.textContent = 'Sin lotes disponibles para esta pieza.';
          applyBtn.disabled = true;
          return;
        }
        applyBtn.disabled = false;
        salidaLoteSel.innerHTML = lots.map((l,idx)=>{
          return `<option value="${l.id}">Lote ${idx+1} ‚Äî Disp: ${l.qty} ‚Äî C: ${fmtMoney(l.costo_unit)} ‚Äî P: ${fmtMoney(l.precio_unit)}</option>`;
        }).join('');
        const totalDisp = lots.reduce((s,x)=>s+Number(x.qty||0),0);
        salidaLotesInfo.textContent = `Lotes: ${lots.length} | Disponible total: ${totalDisp}`;
      }

      function toggleMoveFields(){
        const t = tipoSel.value;
        if(t==='entrada'){
          entradaFields.style.display = '';
          salidaFields.style.display = 'none';
          applyBtn.disabled = false;
        }else{
          entradaFields.style.display = 'none';
          salidaFields.style.display = '';
          fillMoveLots();
        }
      }
      toggleMoveFields();

      function paintMoves(){
        tbody.innerHTML = '';
        moves.forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(m.fecha)}</td>
            <td>${escapeHtml(m.codigo)}</td>
            <td>${escapeHtml(m.nombre)}</td>
            <td>${escapeHtml(m.almacen||'')}</td>
            <td>${m.tipo === 'entrada' ? 'Entrada' : 'Salida'}</td>
            <td class="num">${m.cantidad}</td>
            <td>${escapeHtml(m.referencia||'')}</td>
            <td>${escapeHtml(m.usuario||'')}</td>
            <td class="col-actions"><button class="btn btn-danger btn-xs" data-act="undo" data-id="${m.id}">Deshacer</button></td>`;
          tbody.appendChild(tr);
        });
      }
      paintMoves();

      almFilter.addEventListener('change', ()=>{ fillPartOptions(); if(tipoSel.value==='salida') fillMoveLots(); });
      partSel.addEventListener('change', ()=>{ if(tipoSel.value==='salida') fillMoveLots(); });
      tipoSel.addEventListener('change', toggleMoveFields);

      moveForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(moveForm);
        const piezaId = fd.get('piezaId'); const tipo = fd.get('tipo');
        const cantidad = Number(fd.get('cantidad')); const referencia = String(fd.get('referencia')||'').trim();
        if(!piezaId || !tipo || !(cantidad>0)){ alert('Complete los campos del movimiento'); return; }
        try{
          const u = Auth.currentUser();
          const payload = { piezaId, tipo, cantidad, referencia, usuarioEmail: u?u.email:'' };

          if(tipo==='entrada'){
            payload.costoUnit = (entradaCosto.value !== '') ? Number(entradaCosto.value) : null;
            payload.precioUnit = (entradaPrecio.value !== '') ? Number(entradaPrecio.value) : null;
          }else{ // salida
            const loteId = salidaLoteSel.value;
            if(!loteId){ alert('Seleccione un lote para la salida'); return; }
            payload.loteId = loteId;
          }

          await DB.applyMovement(payload);
          parts = await DB.listParts(); moves = await DB.listMoves(2000); paintMoves();
          alert('Movimiento registrado');
          moveForm.reset(); fillPartOptions(); toggleMoveFields();
        }catch(err){ alert(err.message || 'Error al aplicar movimiento'); }
      });

      // Deshacer √∫ltimo (bot√£o vermelho j√° aplicado no template)
      undoBtn.addEventListener('click', async ()=>{
        try{ await DB.undoLastMovement(); moves = await DB.listMoves(2000); paintMoves(); alert('Movimiento deshecho'); toggleMoveFields(); }
        catch(e){ alert(e.message || 'No se pudo deshacer'); }
      });

      // Deshacer qualquer movimento (linha)
      tbody.addEventListener('click', async (e)=>{
        const b = e.target.closest('button[data-act="undo"]'); if(!b) return;
        const id = Number(b.dataset.id);
        if(!confirm('¬øDeshacer este movimiento?')) return;
        try{
          await DB.deleteMovementById(id);
          parts = await DB.listParts(); moves = await DB.listMoves(2000); paintMoves();
          alert('Movimiento deshecho');
        }catch(err){ alert(err.message || 'No se pudo deshacer este movimiento'); }
      });

      exportBtn.addEventListener('click', async ()=>{
        const p = await DB.listParts();
        const head = ['id','codigo','nombre','categoria','almacen','proveedor','leadTimeDias','consumoDiario','ubicacion','stock','stockMin','costo_Bs','precio_Bs'];
        const rows = p.map(pt=>{
          const row = { id:pt.id, codigo:pt.codigo, nombre:pt.nombre, categoria:pt.categoria, almacen:pt.almacen, proveedor:pt.proveedor, leadTimeDias:pt.leadTimeDias, consumoDiario:pt.consumoDiario, ubicacion:pt.ubicacion, stock:pt.stock, stockMin:pt.stockMin, costo_Bs:pt.costo, precio_Bs:pt.precio };
          return head.map(k=>csvCell(row[k] ?? '')).join(',');
        });
        const csv = head.join(',') + '\n' + rows.join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = url; a.download = `inventario_${stamp}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      });
    }

    async function renderSugerencias(){
      const tpl = document.getElementById('tpl-sugerencias').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('sugTbody');
      const almFilter = document.getElementById('sugAlmacenFilter');
      let parts = await DB.listParts();

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        almFilter.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      buildAlmacenOptions();

      function calcularSugerencias(){
        const alm = almFilter.value || '(Todos)';
        const base = parts.filter(p => alm === '(Todos)' || String(p.almacen||'').toLowerCase()===alm.toLowerCase());
        return base.map(p=>{
          const cd = Number(p.consumoDiario||0);
          const lt = Number(p.leadTimeDias||0);
          const min = Number(p.stockMin||0);
          const stk = Number(p.stock||0);
          const rop = Math.ceil(cd * (lt + SAFETY_DAYS));
          const sug = Math.max(0, rop - stk);
          return {...p, rop, sugerido:sug};
        }).filter(x=>x.sugerido>0);
      }

      function paint(){
        const list = calcularSugerencias();
        tbody.innerHTML = '';
        list.forEach(p=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(p.codigo)}</td>
            <td>${escapeHtml(p.nombre)}</td>
            <td>${escapeHtml(p.proveedor||'')}</td>
            <td>${escapeHtml(p.almacen||'')}</td>
            <td class="num">${p.stock}</td>
            <td class="num">${p.stockMin}</td>
            <td class="num">${p.consumoDiario||0}</td>
            <td class="num">${p.leadTimeDias||0}</td>
            <td class="num">${p.rop}</td>
            <td class="num">${p.sugerido}</td>`;
          tbody.appendChild(tr);
        });
      }
      almFilter.addEventListener('change', paint); paint();
    }

    async function renderAjustes(){
      const tpl = document.getElementById('tpl-ajustes').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const backupBtn = document.getElementById('backupBtn');
      const restoreFile = document.getElementById('restoreFile');
      const resetBtn = document.getElementById('resetBtn');

      const orgName = document.getElementById('orgName');
      const orgSelect = document.getElementById('orgSelect');
      const orgNewBtn = document.getElementById('orgNewBtn');

      (async ()=>{
        const orgs = await Org.myOrgs();
        const cur = Org.get();
        orgName.textContent = cur?.nombre || '‚Äî';
        orgSelect.innerHTML = orgs.map(o => `<option value="${o.id}" ${o.id===cur.id?'selected':''}>${escapeHtml(o.nombre)}</option>`).join('');
      })();

      orgSelect.addEventListener('change', async ()=>{
        const id = orgSelect.value;
        const { data, error } = await sb.from('orgs').select('id,nombre').eq('id', id).maybeSingle();
        if(error || !data){ alert('No se pudo cambiar de empresa'); return; }
        Org.set(data);
        alert('Empresa cambiada a: ' + data.nombre);
        location.hash = '#/dashboard'; await route();
      });

      orgNewBtn.addEventListener('click', async ()=>{
        const nombre = prompt('Nombre de la nueva empresa:'); if(!nombre) return;
        const { data:{ user } } = await sb.auth.getUser();
        const { data: org, error: e1 } = await sb.from('orgs').insert({ nombre, created_by: user?.id }).select().maybeSingle();
        if(e1){ alert(e1.message); return; }
        const { error: e2 } = await sb.from('org_members').insert({ org_id: org.id, user_id: user?.id });
        if(e2){ alert(e2.message); return; }
        Org.set(org);
        alert('Empresa creada y seleccionada: ' + org.nombre);
        location.hash = '#/dashboard'; await route();
      });

      backupBtn.addEventListener('click', async ()=>{
        try{
          const dump = await DB.backupAll();
          const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_inventario.json'; a.click();
        }catch(e){ alert(e.message || 'No se pudo hacer backup'); }
      });

      restoreFile.addEventListener('change', async ()=>{
        const f = restoreFile.files[0]; if(!f) return;
        try{
          const data = JSON.parse(await f.text());
          await DB.restoreAll(data);
          alert('Restauraci√≥n completa'); location.hash = '#/dashboard'; await route();
        }catch(e){ alert('Archivo inv√°lido / restauraci√≥n fall√≥'); }
        finally{ restoreFile.value = ''; }
      });

      resetBtn.addEventListener('click', async ()=>{
        if(!confirm('Esto borrar√° TODAS las piezas, lotes, movimientos e historial de la EMPRESA ACTUAL. ¬øContinuar?')) return;
        try{ await DB.wipeCurrentOrg(); alert('Datos borrados de la empresa actual'); location.hash = '#/dashboard'; await route(); }
        catch(e){ alert(e.message || 'No se pudo borrar'); }
      });
    }

    async function renderHistorial(){
      const tpl = document.getElementById('tpl-historial').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('histTbody');
      const hist = await DB.listPriceHistory();
      tbody.innerHTML = '';
      hist.forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(h.fecha)}</td>
          <td>${escapeHtml(h.codigo)}</td>
          <td>${escapeHtml(h.nombre)}</td>
          <td class="num">${fmtMoney(h.costoAntes)} ‚ûù ${fmtMoney(h.costoDespues)}</td>
          <td class="num">${fmtMoney(h.precioAntes)} ‚ûù ${fmtMoney(h.precioDespues)}</td>
          <td>${escapeHtml(h.usuario||'')}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* --------- Esc√°ner (opcional) --------- */
    async function startScan(){
      try{
        if(!('BarcodeDetector' in window)){ alert('Esc√°ner no soportado; ingrese el c√≥digo manualmente.'); return; }
        const video = document.getElementById('cam');
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
        video.srcObject = stream; await video.play();
        const det = new BarcodeDetector({formats:['code_128','ean_13','ean_8','qr_code','upc_a','upc_e']});
        const codeInput = document.querySelector('input[name="codigo"]');
        let running = true;
        const stop = ()=>{ running=false; if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); } video.srcObject=null; };
        const tick = async ()=>{
          if(!running) return;
          try{ const codes = await det.detect(video);
            if(codes.length){ codeInput.value = codes[0].rawValue || ''; stop(); alert('C√≥digo detectado: ' + codeInput.value); return; }
          }catch(e){}
          requestAnimationFrame(tick);
        };
        tick();
      }catch(err){ alert('No se pudo abrir la c√°mara'); }
    }

    // Boot
    init();
  </script>
</body>
</html>

