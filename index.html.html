<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gesti√≥n de Inventario ‚Äî Autopartes</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
      --primary:#1f6feb; --danger:#ef4444; --radius:12px;
      --shadow:0 1px 2px rgba(0,0,0,.04),0 6px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
    .app.no-sidebar{ grid-template-columns:1fr; min-height:100dvh; }
    .sidebar{border-right:1px solid var(--border); background:#fafafa; padding:16px; display:flex; flex-direction:column; gap:16px;}
    .hidden{display:none !important}

    .brand{display:flex; align-items:center; gap:12px; padding:8px 6px}
    .brand .logo{font-size:28px}
    .nav{display:flex; flex-direction:column; gap:6px}
    .nav-btn{ text-align:left; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .nav-btn:hover{border-color:#d1d5db}
    .sidebar-foot{ margin-top:auto; display:flex; flex-direction:column; gap:8px; }
    .user-label{font-size:12px; color:var(--muted)}

    .view{padding:24px; max-width:1200px; width:100%}

    .center{
      display:flex; align-items:center; justify-content:center;
      min-height:100dvh;
      padding:clamp(16px, 5vw, 48px);
      padding-top:calc(env(safe-area-inset-top,0px) + clamp(16px, 5vw, 48px));
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + clamp(16px, 5vw, 48px));
    }
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px;}
    .card-max{width:min(100%, 420px)}
    .title{margin:0 0 8px}
    .muted{color:var(--muted)}
    .xs{font-size:12px}

    .form{display:flex; flex-direction:column; gap:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field input, .field select, .input{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      width:100%;
      height:44px;
      font-size:16px;
    }
    .field input[readonly]{ background:#f8fafc; }
    .field input:focus, .field select:focus, .input:focus{outline:2px solid rgba(31,111,235,.25)}

    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:10px 14px;
      cursor:pointer;
      height:44px;
      font-size:16px;
    }
    .btn-primary{background:var(--primary); color:#fff; border-color:transparent}
    .btn-ghost{background:transparent}
    .btn-danger{background:var(--danger); color:#fff; border-color:transparent}

    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .toolbar .right{display:flex; gap:8px; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:12px}

    .table-wrap{width:100%; overflow:auto}
    .table{width:100%; border-collapse:separate; border-spacing:0}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border)}
    .table th{font-weight:600; text-align:left; white-space:nowrap}
    .table td.num,.table th.num{text-align:right}

    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border);}
    .badge.low{background:#fff5f5; color:#b91c1c; border-color:#fecaca}

    .row-actions{display:flex; gap:8px; align-items:center}

    .grid{ display:grid; grid-template-columns:repeat(4, minmax(0, 1fr)); gap:12px; }
    .grid .field{min-width:0}

    .kpis{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
    .kpis .card h3{margin:0 0 6px; font-size:14px; color:var(--muted)}
    .kpis .card strong{font-size:20px}

    /* chips de sugest√£o */
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }
    .chip { border:1px solid var(--border); background:#fff; border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer; }
    .chip:hover { border-color:#d1d5db }

    @media (max-width:1100px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width:900px){
      .app{grid-template-columns:1fr}
      .sidebar{position:sticky; top:0; z-index:10}
      .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
    }
    @media (max-width:600px){
      .view{padding:16px}
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr;}
      .toolbar .right{gap:6px}
    }

    #cam{width:1px;height:1px;position:absolute;left:-9999px;top:-9999px}
  </style>
</head>
<body>
  <div id="app" class="app no-sidebar">
    <aside id="sidebar" class="sidebar hidden" aria-hidden="true">
      <div class="brand">
        <div class="logo" aria-hidden="true">üîß</div>
        <div><strong>Autopartes</strong><small> Inventario</small></div>
      </div>
      <nav class="nav" aria-label="Navegaci√≥n principal">
        <button class="nav-btn" data-route="dashboard">Dashboard</button>
        <button class="nav-btn" data-route="inventario">Inventario</button>
        <button class="nav-btn" data-route="movimientos">Movimientos</button>
        <button class="nav-btn" data-route="sugerencias">Sugerencias</button>
        <button class="nav-btn" data-route="historial">Historial precios</button>
        <button class="nav-btn" data-route="ajustes">Ajustes</button>
      </nav>
      <div class="sidebar-foot">
        <span id="userLabel" class="user-label"></span>
        <button id="logoutBtn" class="btn btn-ghost">Cerrar sesi√≥n</button>
      </div>
    </aside>
    <main id="view" class="view"></main>
  </div>

  <!-- Templates -->
  <template id="tpl-login">
    <section class="center">
      <div class="card card-max" role="dialog" aria-labelledby="loginTitle">
        <h1 id="loginTitle" class="title" style="text-align:center">Iniciar sesi√≥n</h1>
        <p class="muted" style="text-align:center">Acceso interno ‚Äî Gesti√≥n de inventario de autopartes.</p>
        <form id="loginForm" class="form">
          <label class="field"><span>Correo</span>
            <input type="email" name="email" placeholder="admin@empresa.com" required autocomplete="username" />
          </label>
          <label class="field"><span>Contrase√±a</span>
            <input type="password" name="password" placeholder="********" required autocomplete="current-password" />
          </label>
          <button class="btn btn-primary" type="submit">Entrar</button>
          <p class="muted xs" style="text-align:center">Cree usuarios en Supabase ‚Üí Auth ‚Üí Users</p>
          <button id="clearCacheBtn" type="button" class="btn" title="Limpia empresa seleccionada y cierra sesi√≥n">Limpiar cach√© local</button>
        </form>
      </div>
    </section>
  </template>

  <template id="tpl-inventario">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Inventario</h2><p class="muted">Piezas registradas y estado de stock.</p></div>
        <div class="right">
          <select id="filterAlmacen" class="input" title="Filtrar por almac√©n"></select>
          <input id="searchParts" class="input" placeholder="Buscar por c√≥digo, nombre o categor√≠a‚Ä¶" />
          <label class="btn" for="importCSV">Importar CSV</label>
          <input id="importCSV" type="file" accept=".csv" style="display:none" />
          <button id="addPartBtn" class="btn btn-primary">A√±adir pieza</button>
        </div>
      </header>
      <details id="partFormWrap" class="card">
        <summary id="partFormSummary">Nueva pieza</summary>
        <form id="partForm" class="grid">
          <input type="hidden" name="id" />
          <label class="field"><span>C√≥digo</span>
            <div style="display:flex; gap:8px">
              <input name="codigo" required placeholder="ABC-123" style="flex:1" />
              <button type="button" id="scanBtn" class="btn">Escanear</button>
            </div>
            <video id="cam" playsinline></video>
          </label>
          <label class="field"><span>Nombre</span><input name="nombre" required placeholder="Filtro de aceite" /></label>
          <label class="field"><span>Categor√≠a</span><input name="categoria" placeholder="Motor, Suspensi√≥n, Frenos‚Ä¶" /></label>
          <label class="field"><span>Ubicaci√≥n</span><input name="ubicacion" placeholder="Estante A3" /></label>

          <!-- Almac√©n con datalist + chips -->
          <label class="field"><span>Almac√©n</span>
            <input name="almacen" placeholder="Central, Sucursal 1‚Ä¶" list="dlAlmacenes" />
            <datalist id="dlAlmacenes"></datalist>
            <div class="chips" id="almacenChips"></div>
            <span class="xs muted">Tip: puedes escribir libremente o hacer clic en un chip.</span>
          </label>

          <!-- Proveedor con datalist + chips -->
          <label class="field"><span>Proveedor</span>
            <input name="proveedor" placeholder="Proveedor principal" list="dlProveedores" />
            <datalist id="dlProveedores"></datalist>
            <div class="chips" id="proveedorChips"></div>
          </label>

          <label class="field"><span>Lead time (d√≠as)</span>
            <input name="leadTimeDias" type="number" min="0" step="1" value="0" />
          </label>

          <!-- AUTOM√ÅTICOS (solo lectura) -->
          <label class="field"><span>Consumo diario (auto)</span>
            <input name="consumoDiario" type="number" min="0" step="0.01" value="0" readonly
              title="Calculado autom√°ticamente por movimientos (√∫ltimos 30 d√≠as)" />
          </label>
          <label class="field"><span>Stock m√≠nimo (auto)</span>
            <input name="stockMin" type="number" min="0" step="1" value="0" readonly
              title="ceil(CD √ó d√≠as de seguridad)" />
          </label>

          <label class="field"><span>Stock</span><input name="stock" type="number" min="0" step="1" value="0" required /></label>
          <label class="field"><span>Costo unitario (Bs)</span><input name="costo" type="number" min="0" step="0.01" value="0" /></label>
          <label class="field"><span>Precio venta (Bs)</span><input name="precio" type="number" min="0" step="0.01" value="0" /></label>
          <div class="row-actions">
            <button class="btn btn-primary" type="submit">Guardar</button>
            <button type="button" id="cancelEdit" class="btn btn-ghost">Cancelar</button>
          </div>
        </form>
        <p class="muted xs">
          C√°lculo: CD = salidas/30d. Stock m√≠nimo = ceil(CD √ó <span id="safetyDaysHint"></span>).
          ROP = ceil(CD √ó (LT + <span id="safetyDaysHint2"></span>)).
        </p>
      </details>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="partsTable">
            <thead><tr>
              <th>C√≥digo</th><th>Nombre</th><th>Categor√≠a</th><th>Almac√©n</th><th>Ubicaci√≥n</th>
              <th class="num">Stock</th><th class="num">M√≠n</th><th class="num">Costo (Bs)</th><th class="num">Precio (Bs)</th><th></th>
            </tr></thead>
            <tbody id="partsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-movimientos">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Movimientos</h2><p class="muted">Entradas y salidas que afectan el stock.</p></div>
        <div class="right">
          <select id="moveAlmacenFilter" class="input" title="Filtrar piezas por almac√©n"></select>
          <button id="undoLast" class="btn">Deshacer √∫ltimo</button>
          <button id="exportCSV" class="btn">Exportar inventario (CSV)</button>
        </div>
      </header>
      <div class="card">
        <h3>Registrar movimiento</h3>
        <form id="moveForm" class="grid">
          <label class="field"><span>Pieza</span><select name="piezaId" id="movePart" required></select></label>
          <label class="field"><span>Tipo</span>
            <select name="tipo" id="moveTipo" required>
              <option value="entrada">Entrada</option>
              <option value="salida">Salida</option>
            </select>
          </label>

          <!-- Campos vis√≠veis somente em ENTRADA -->
          <label class="field" data-show-entrada><span>Costo unitario (Bs)</span>
            <input name="movCosto" type="number" min="0" step="0.01" />
          </label>
          <label class="field" data-show-entrada><span>Precio unitario (Bs)</span>
            <input name="movPrecio" type="number" min="0" step="0.01" />
          </label>

          <!-- Quantidade geral (entrada usa; sa√≠da ser√° a soma das linhas do lote) -->
          <label class="field"><span>Cantidad</span>
            <input name="cantidad" id="moveCantidad" type="number" min="1" step="1" required />
            <span class="xs muted" id="lotSumHint" style="display:none"></span>
          </label>

          <label class="field"><span>Referencia</span><input name="referencia" placeholder="Factura, orden, motivo‚Ä¶" /></label>
          <div class="row-actions"><button type="submit" class="btn btn-primary" id="applyMoveBtn">Aplicar</button></div>
        </form>
      </div>

      <!-- Picker de lotes para SA√çDA -->
      <div class="card" id="lotPicker" style="display:none">
        <h3>Lotes disponibles para salida</h3>
        <div class="table-wrap">
          <table class="table">
            <thead><tr>
              <th>Lote</th><th class="num">Disponible</th><th class="num">Costo</th><th class="num">Precio</th><th class="num">Retirar</th>
            </tr></thead>
            <tbody id="lotRows"></tbody>
          </table>
        </div>
        <p class="muted xs" id="lotSumInfo">Seleccione cantidades por lote. La suma definir√° la cantidad total de la salida.</p>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table class="table" id="movesTable">
            <thead><tr>
              <th>Fecha</th><th>C√≥digo</th><th>Nombre</th><th>Almac√©n</th><th>Tipo</th>
              <th class="num">Cantidad</th><th>Referencia</th><th>Usuario</th>
            </tr></thead>
            <tbody id="movesTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-sugerencias">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Sugerencias de compra</h2><p class="muted">Basado en CD, lead time y stock m√≠nimo.</p></div>
        <div class="right"><select id="sugAlmacenFilter" class="input" title="Filtrar por almac√©n"></select></div>
      </header>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="sugTable">
            <thead><tr>
              <th>C√≥digo</th><th>Nombre</th><th>Proveedor</th><th>Almac√©n</th>
              <th class="num">Stock</th><th class="num">M√≠n</th><th class="num">CD</th><th class="num">LT</th>
              <th class="num">Punto pedido</th><th class="num">Sugerido</th>
            </tr></thead>
            <tbody id="sugTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-ajustes">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Ajustes</h2><p class="muted">Empresa, backup y restauraci√≥n.</p></div>
        <div class="right">
          <button id="backupBtn" class="btn">Backup JSON</button>
          <label class="btn" for="restoreFile">Restaurar JSON</label>
          <input id="restoreFile" type="file" accept="application/json" style="display:none"/>
          <button id="resetBtn" class="btn btn-danger">Vaciar datos (empresa actual)</button>
        </div>
      </header>

      <div class="card" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <strong>Empresa actual:</strong>
        <span id="orgName">‚Äî</span>
        <select id="orgSelect" class="input"></select>
        <button id="orgNewBtn" class="btn">Nueva empresa</button>
      </div>
    </section>
  </template>

  <template id="tpl-historial">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Historial de precios</h2><p class="muted">Cambios de costo y precio por pieza.</p></div>
        <div class="right"></div>
      </header>
      <div class="card">
        <div class="table-wrap">
          <table class="table" id="histTable">
            <thead><tr>
              <th>Fecha</th><th>C√≥digo</th><th>Nombre</th>
              <th class="num">Costo (antes ‚ûù despu√©s)</th><th class="num">Precio (antes ‚ûù despu√©s)</th><th>Usuario</th>
            </tr></thead>
            <tbody id="histTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    /* =======================
       CONFIG SUPABASE
    ======================= */
    const SUPABASE_URL = 'https://zbqshivafjhbghksuhkz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXNoaXZhZmpoYmdoa3N1aGt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MjAzMTEsImV4cCI6MjA3NTI5NjMxMX0.t89MkdRDYHTSs8-pk7gzglZMNlXxGG-VKIQl7Hu8vtE';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Par√¢metros do c√°lculo autom√°tico
    const CD_WINDOW_DAYS = 30;
    const SAFETY_DAYS   = 2; // d√≠as de seguridad

    /* ===== Utils ===== */
    const fmtMoney = (n)=> Number(n||0).toLocaleString('es-BO', {style:'currency', currency:'BOB'});
    const fmtDate  = (d)=> new Date(d).toLocaleString(undefined, {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const escapeHtml = (s)=> String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const csvCell = (v)=> { const needsQuote = /[",\n]/.test(String(v)); const esc = String(v).replace(/"/g,'""'); return needsQuote ? `"${esc}"` : esc; };
    const parseCSVLine = (s)=>{ const out=[]; let cur=''; let q=false; for(let i=0;i<s.length;i++){ const c=s[i]; if(c==='"'){ if(q && s[i+1]==='"'){cur+='"'; i++;} else {q=!q;} continue; } if(c===',' && !q){ out.push(cur); cur=''; continue; } cur+=c; } out.push(cur); return out; };
    const uuidv4 = ()=> (crypto?.randomUUID?.() || ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    ));

    /* ===== Auth ===== */
    const Auth = (() => {
      let cache = null; // {id,email}
      function set(user){
        cache = user ? { id:user.id, email:user.email } : null;
        if(cache) localStorage.setItem('authedUser', JSON.stringify(cache));
        else localStorage.removeItem('authedUser');
      }
      async function init(){
        const { data:{ user } } = await sb.auth.getUser();
        set(user || null);
        sb.auth.onAuthStateChange((_event, session)=>{
          set(session?.user || null);
          route();
        });
      }
      const isAuthed = () => !!cache;
      const currentUser = () => cache;
      async function login(email, password){
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) return { ok:false, error: error.message };
        return { ok:true };
      }
      async function logout(){ await sb.auth.signOut(); }
      return { init, isAuthed, currentUser, login, logout };
    })();

    /* ===== Org ===== */
    const Org = (() => {
      let currentId = localStorage.getItem('currentOrgId') || null;
      let currentName = localStorage.getItem('currentOrgName') || null;

      const get = () => ({ id: currentId, nombre: currentName });
      const set = (org) => {
        currentId = org?.id || null;
        currentName = org?.nombre || null;
        if (currentId) localStorage.setItem('currentOrgId', currentId); else localStorage.removeItem('currentOrgId');
        if (currentName) localStorage.setItem('currentOrgName', currentName); else localStorage.removeItem('currentOrgName');
      };

      async function myOrgs() {
        const { data:{ user } } = await sb.auth.getUser();
        const uid = user?.id;
        if(!uid) return [];
        const { data: mems, error } = await sb.from('org_members').select('org_id').eq('user_id', uid);
        if(error) throw error;
        if(!mems?.length) return [];
        const ids = mems.map(m=>m.org_id);
        const { data: orgs, error: e2 } = await sb.from('orgs').select('id, nombre').in('id', ids).order('nombre');
        if(e2) throw e2;
        return orgs;
      }

      async function ensureCurrent() {
        const orgs = await myOrgs();
        if (!orgs.length) {
          const nombre = prompt('Nombre de la empresa (crearemos una nueva ahora):');
          if(!nombre) throw new Error('Necesita crear/seleccionar una empresa para continuar.');
          const { data:{ user } } = await sb.auth.getUser();
          const { data: created, error } = await sb.from('orgs').insert({ nombre, created_by: user?.id }).select().maybeSingle();
          if (error) throw error;
          const { error: e2 } = await sb.from('org_members').insert({ org_id: created.id, user_id: user?.id });
          if (e2) throw e2;
          set(created);
          return created;
        }
        const found = orgs.find(o => o.id === currentId) || orgs[0];
        set(found);
        return found;
      }

      return { get, set, myOrgs, ensureCurrent };
    })();

    /* ===== DB (Supabase) ===== */
    const DB = (() => {
      function orgId(){ const o = Org.get(); if(!o?.id) throw new Error('Empresa no seleccionada'); return o.id; }

      // ---- Parts ----
      async function listParts(){
        const { data, error } = await sb
          .from('parts')
          .select('id, org_id, codigo, nombre, categoria, ubicacion, almacen, proveedor, lead_time_dias, consumo_diario, stock, stock_min, costo, precio')
          .eq('org_id', orgId())
          .order('nombre',{ascending:true});
        if(error) throw error;
        return (data||[]).map(r => ({
          id:r.id, codigo:r.codigo, nombre:r.nombre, categoria:r.categoria||'',
          ubicacion:r.ubicacion||'', almacen:r.almacen||'', proveedor:r.proveedor||'',
          leadTimeDias:Number(r.lead_time_dias||0), consumoDiario:Number(r.consumo_diario||0),
          stock:Number(r.stock||0), stockMin:Number(r.stock_min||0),
          costo:Number(r.costo||0), precio:Number(r.precio||0)
        }));
      }

      async function getPartById(id){
        const { data, error } = await sb.from('parts')
          .select('id, org_id, codigo, nombre, categoria, ubicacion, almacen, proveedor, lead_time_dias, consumo_diario, stock, stock_min, costo, precio')
          .eq('id', id).eq('org_id', orgId()).maybeSingle();
        if(error) throw error;
        if(!data) return null;
        return {
          id:data.id, codigo:data.codigo, nombre:data.nombre, categoria:data.categoria||'',
          ubicacion:data.ubicacion||'', almacen:data.almacen||'', proveedor:data.proveedor||'',
          leadTimeDias:Number(data.lead_time_dias||0), consumoDiario:Number(data.consumo_diario||0),
          stock:Number(data.stock||0), stockMin:Number(data.stock_min||0),
          costo:Number(data.costo||0), precio:Number(data.precio||0)
        };
      }

      // Insert garante 0 em consumo/stock_min; Update n√£o mexe neles (s√£o calculados por movimentos)
      async function upsertPart(part){
        const base = {
          org_id: orgId(),
          codigo: part.codigo, nombre: part.nombre,
          categoria: part.categoria || null, ubicacion: part.ubicacion || null,
          almacen: part.almacen || null, proveedor: part.proveedor || null,
          lead_time_dias: Number(part.leadTimeDias||0),
          stock: Number(part.stock||0),
          costo: Number(part.costo||0), precio: Number(part.precio||0)
        };
        if(part.id){
          const { error } = await sb.from('parts')
            .update(base)
            .eq('id', part.id).eq('org_id', orgId());
          if(error) throw error;
          return part.id;
        }else{
          const rowInsert = { ...base, consumo_diario: 0, stock_min: 0 };
          const { data, error } = await sb.from('parts').insert(rowInsert).select('id').maybeSingle();
          if(error) throw error;
          return data?.id;
        }
      }

      async function deletePart(id){
        const { error } = await sb.from('parts').delete().eq('id', id).eq('org_id', orgId());
        if(error) throw error;
      }

      // ---- Movements (com custo/pre√ßo por lote) ----
      async function listMoves(limit=500){
        const { data, error } = await sb.from('movements')
          .select('id, fecha, pieza_id, codigo, nombre, almacen, tipo, cantidad, referencia, usuario, costo_unit, precio_unit, lote_id')
          .eq('org_id', orgId())
          .order('fecha',{ascending:false})
          .limit(limit);
        if(error) throw error;
        return data||[];
      }

      // Calcula disponibilidade por lote da pe√ßa (inclui lote null como "SIN-LOTE" se houver saldo)
      async function getLots(piezaId){
        const { data: movs, error } = await sb.from('movements')
          .select('tipo, cantidad, lote_id, costo_unit, precio_unit')
          .eq('org_id', orgId())
          .eq('pieza_id', piezaId)
          .order('fecha', { ascending: true });
        if(error) throw error;

        // Mapa por lote_id
        const byLot = new Map();
        for(const m of (movs||[])){
          const key = m.lote_id || 'SIN-LOTE';
          if(!byLot.has(key)) byLot.set(key, { entradas:0, salidas:0, costo:null, precio:null });
          const acc = byLot.get(key);
          if(m.tipo === 'entrada'){
            acc.entradas += Number(m.cantidad||0);
            if(acc.costo===null && m.costo_unit!=null) acc.costo = Number(m.costo_unit);
            if(acc.precio===null && m.precio_unit!=null) acc.precio = Number(m.precio_unit);
          }else{
            acc.salidas += Number(m.cantidad||0);
          }
        }
        const part = await getPartById(piezaId);
        const lots = [];
        for(const [key, v] of byLot.entries()){
          const disp = (v.entradas - v.salidas);
          if(disp > 0){
            lots.push({
              lote_id: key==='SIN-LOTE' ? null : key,
              label: key==='SIN-LOTE' ? 'SIN-LOTE' : key,
              disponible: disp,
              costo_unit: (v.costo!=null ? v.costo : Number(part?.costo||0)),
              precio_unit: (v.precio!=null ? v.precio : Number(part?.precio||0)),
              legacy: key==='SIN-LOTE'
            });
          }
        }
        return lots.sort((a,b)=> (a.legacy===b.legacy ? 0 : a.legacy?1:-1)); // mostra lotes reais primeiro
      }

      async function applyEntry({piezaId, cantidad, referencia, usuarioEmail, costoUnit, precioUnit}){
        const { data: p, error: e1 } = await sb.from('parts')
          .select('id, stock, codigo, nombre, almacen, costo, precio')
          .eq('id', piezaId).eq('org_id', orgId()).maybeSingle();
        if(e1) throw e1;
        if(!p) throw new Error('Pieza no encontrada');

        cantidad = Number(cantidad||0);
        if(!(cantidad>0)) throw new Error('Cantidad inv√°lida');

        // custo/pre√ßo do lote: usa input ou fallback da pe√ßa
        const cu = (costoUnit!=null && costoUnit!=='') ? Number(costoUnit) : Number(p.costo||0);
        const pu = (precioUnit!=null && precioUnit!=='') ? Number(precioUnit) : Number(p.precio||0);

        const newStock = Number(p.stock) + cantidad;
        const { error: upErr } = await sb.from('parts')
          .update({ stock: newStock })
          .eq('id', piezaId).eq('org_id', orgId());
        if(upErr) throw upErr;

        const loteId = uuidv4();
        const { error: insErr } = await sb.from('movements').insert({
          org_id: orgId(),
          pieza_id: piezaId,
          codigo: p.codigo, nombre: p.nombre, almacen: p.almacen || '',
          tipo: 'entrada', cantidad, referencia: referencia || '', usuario: usuarioEmail || '',
          costo_unit: cu, precio_unit: pu, lote_id: loteId
        });
        if(insErr) throw insErr;

        // Recalcular m√©tricas (consumo/stock_min n√£o mudam com entrada, mas ok manter consist√™ncia)
        await recomputeMetrics(piezaId);
      }

      async function applyExit({piezaId, referencia, usuarioEmail, selections}){
        // selections: [{ lote_id|null, cantidad, costo_unit, precio_unit }]
        if(!Array.isArray(selections) || !selections.length) throw new Error('Selecci√≥n de lotes vac√≠a');
        const total = selections.reduce((s,x)=> s + Number(x.cantidad||0), 0);
        if(!(total>0)) throw new Error('Cantidad total inv√°lida');

        const { data: p, error: e1 } = await sb.from('parts')
          .select('id, stock, codigo, nombre, almacen')
          .eq('id', piezaId).eq('org_id', orgId()).maybeSingle();
        if(e1) throw e1;
        if(!p) throw new Error('Pieza no encontrada');
        if(Number(p.stock) < total) throw new Error('Stock insuficiente para la salida (total)');

        const newStock = Number(p.stock) - total;
        const { error: upErr } = await sb.from('parts')
          .update({ stock: newStock })
          .eq('id', piezaId).eq('org_id', orgId());
        if(upErr) throw upErr;

        // grava N movimentos (um por lote)
        const rows = selections
          .filter(s => Number(s.cantidad)>0)
          .map(s => ({
            org_id: orgId(),
            pieza_id: piezaId, codigo: p.codigo, nombre: p.nombre,
            almacen: p.almacen || '', tipo: 'salida', cantidad: Number(s.cantidad),
            referencia: referencia || '', usuario: usuarioEmail || '',
            costo_unit: Number(s.costo_unit||0), precio_unit: Number(s.precio_unit||0),
            lote_id: s.lote_id || null
          }));
        const { error: insErr } = await sb.from('movements').insert(rows);
        if(insErr) throw insErr;

        await recomputeMetrics(piezaId);
      }

      async function applyMovement(payload){
        if(payload.tipo === 'entrada'){
          return applyEntry(payload);
        }else{
          return applyExit(payload);
        }
      }

      // ---- Historial de precios ----
      async function listPriceHistory(limit=500){
        const { data, error } = await sb.from('price_history')
          .select('fecha, codigo, nombre, costo_antes, costo_despues, precio_antes, precio_despues, usuario')
          .eq('org_id', orgId())
          .order('fecha',{ascending:false})
          .limit(limit);
        if(error) throw error;
        return (data||[]).map(h=>({
          fecha:h.fecha, codigo:h.codigo, nombre:h.nombre,
          costoAntes:h.costo_antes, costoDespues:h.costo_despues,
          precioAntes:h.precio_antes, precioDespues:h.precio_despues,
          usuario:h.usuario
        }));
      }

      async function addPriceHistory(entry){
        const row = {
          org_id: orgId(),
          pieza_id: entry.piezaId || null, codigo: entry.codigo, nombre: entry.nombre,
          costo_antes: Number(entry.costoAntes||0), costo_despues: Number(entry.costoDespues||0),
          precio_antes: Number(entry.precioAntes||0), precio_despues: Number(entry.precioDespues||0),
          usuario: entry.usuario || ''
        };
        const { error } = await sb.from('price_history').insert(row);
        if(error) throw error;
      }

      // ---- Backup simples ----
      async function backupAll(){
        const [parts, moves, hist] = await Promise.all([
          listParts(), listMoves(10000), listPriceHistory(10000)
        ]);
        return { parts, moves, priceHistory: hist };
      }

      async function restoreAll(jsonDump){
        if(Array.isArray(jsonDump.parts)){
          for(const p of jsonDump.parts){
            await upsertPart(p);
          }
        }
      }

      async function wipeCurrentOrg(){
        const oid = orgId();
        await sb.from('price_history').delete().eq('org_id', oid);
        await sb.from('movements').delete().eq('org_id', oid);
        await sb.from('parts').delete().eq('org_id', oid);
      }

      // ---- Recalcular m√©tricas autom√°ticas (consumo_diario e stock_min) ----
      async function recomputeMetrics(piezaId){
        const since = new Date(Date.now() - CD_WINDOW_DAYS*24*3600*1000).toISOString();
        const { data: outs, error } = await sb.from('movements')
          .select('cantidad')
          .eq('org_id', orgId())
          .eq('pieza_id', piezaId)
          .eq('tipo','salida')
          .gte('fecha', since);
        if(error) throw error;
        const totalOut = (outs||[]).reduce((s,m)=> s + Number(m.cantidad||0), 0);
        const cd = totalOut / CD_WINDOW_DAYS;                  // m√©dia di√°ria 30d
        const stockMin = Math.ceil(cd * SAFETY_DAYS);          // buffer de seguran√ßa

        const { error: upErr } = await sb.from('parts')
          .update({ consumo_diario: cd, stock_min: stockMin })
          .eq('id', piezaId).eq('org_id', orgId());
        if(upErr) throw upErr;
      }

      return {
        listParts, getPartById, upsertPart, deletePart,
        listMoves, applyMovement, applyEntry, applyExit, getLots,
        listPriceHistory, addPriceHistory,
        backupAll, restoreAll, wipeCurrentOrg,
        recomputeMetrics
      };
    })();

/* ==== CONTINUA NA PARTE 2/2 ABAIXO ==== */
/* ==== PARTE 2/2 ==== */

    /* ===== App / Navega√ß√£o ===== */
    const appEl = document.getElementById('app');
    const view = document.getElementById('view');
    const sidebar = document.getElementById('sidebar');
    const userLabel = document.getElementById('userLabel');
    const logoutBtn = document.getElementById('logoutBtn');
    const PUBLIC_ROUTES = ['login'];

    async function init(){
      await Auth.init();
      if(logoutBtn){
        logoutBtn.addEventListener('click', async () => { await Auth.logout(); location.hash = '#/login'; await route(); });
      }
      if(!Auth.isAuthed()) location.hash = '#/login';
      window.addEventListener('hashchange', route);
      await route();
    }

    function setNavActive(path){
      document.querySelectorAll('.nav-btn').forEach(btn=>{
        btn.classList.toggle('btn-primary', btn.dataset.route === path);
        btn.onclick = ()=>{ location.hash = '#/' + btn.dataset.route; };
      });
    }

    async function route(){
      const hash = location.hash || '#/login';
      const path = (hash.startsWith('#/')) ? hash.slice(2) : 'login';
      const authed = Auth.isAuthed();

      if(authed){
        try { await Org.ensureCurrent(); } catch(e){ /* mostra login se falhar selecionar org */ }
        sidebar.classList.remove('hidden'); sidebar.setAttribute('aria-hidden','false'); appEl.classList.remove('no-sidebar');
        const u = Auth.currentUser(); const org = Org.get();
        userLabel.textContent = u ? `Conectado como: ${u.email} ‚Äî Empresa: ${org?.nombre||'‚Äî'}` : '';
      }else{
        sidebar.classList.add('hidden'); sidebar.setAttribute('aria-hidden','true'); appEl.classList.add('no-sidebar');
      }

      if(!authed && !PUBLIC_ROUTES.includes(path)){ await renderLogin(); return; }

      switch(path){
        case 'login': await renderLogin(); break;
        case 'dashboard': await renderDashboard(); break;
        case 'inventario': await renderInventario(); break;
        case 'movimientos': await renderMovimientos(); break;
        case 'sugerencias': await renderSugerencias(); break;
        case 'ajustes': await renderAjustes(); break;
        case 'historial': await renderHistorial(); break;
        default:
          location.hash = authed ? '#/dashboard' : '#/login';
          return;
      }
      if(authed) setNavActive(path);
    }

    /* ===== Vistas ===== */
    async function renderLogin(){
      const tpl = document.getElementById('tpl-login').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const form = document.getElementById('loginForm');
      const clearBtn = document.getElementById('clearCacheBtn');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const email = fd.get('email'); const password = fd.get('password');
        const res = await Auth.login(email, password);
        if(!res.ok){ alert(res.error || 'Error al iniciar sesi√≥n'); return; }
        location.hash = '#/dashboard'; await route();
      });

      clearBtn.addEventListener('click', async ()=>{
        localStorage.removeItem('currentOrgId');
        localStorage.removeItem('currentOrgName');
        await Auth.logout();
        alert('Cach√© local limpiada. Inicie sesi√≥n nuevamente.');
        location.hash = '#/login'; await route();
      });
    }

    async function renderDashboard(){
      const parts = await DB.listParts();
      const moves = await DB.listMoves(5000);

      const valor = parts.reduce((s,p)=> s + Number(p.costo||0)*Number(p.stock||0), 0);
      const bajos = parts.filter(p => Number(p.stock)<Number(p.stockMin)).length;
      const hoyKey = new Date().toDateString();
      const movHoy = moves.filter(m => new Date(m.fecha).toDateString()===hoyKey).length;

      // Mapa para fallback de pre√ßo/custo quando o movimento antigo n√£o tem valor por lote
      const partsMap = new Map(parts.map(p=>[p.id, p]));
      let bruto = 0, cogs = 0;
      for(const m of moves){
        if(m.tipo === 'salida'){
          const p = partsMap.get(m.pieza_id);
          const price = (m.precio_unit!=null) ? Number(m.precio_unit) : Number(p?.precio||0);
          const cost  = (m.costo_unit !=null) ? Number(m.costo_unit)  : Number(p?.costo ||0);
          bruto += price * Number(m.cantidad||0);
          cogs  += cost  * Number(m.cantidad||0);
        }
      }
      const liquida = bruto - cogs;

      view.innerHTML = `
        <section class="stack">
          <div class="kpis">
            <div class="card"><h3>Valor inventario</h3><strong>${fmtMoney(valor)}</strong></div>
            <div class="card"><h3>√çtems bajo m√≠nimo</h3><strong>${bajos}</strong></div>
            <div class="card"><h3>Total SKUs</h3><strong>${parts.length}</strong></div>
            <div class="card"><h3>Movimientos hoy</h3><strong>${movHoy}</strong></div>
          </div>
          <div class="kpis">
            <div class="card"><h3>Ventas brutas (salidas)</h3><strong>${fmtMoney(bruto)}</strong></div>
            <div class="card"><h3>COGS (costo de ventas)</h3><strong>${fmtMoney(cogs)}</strong></div>
            <div class="card"><h3>Ganancia l√≠quida</h3><strong>${fmtMoney(liquida)}</strong></div>
            <div class="card"><h3>Par√°metros</h3><strong>CD: ${CD_WINDOW_DAYS}d ¬∑ Seguridad: ${SAFETY_DAYS}d</strong></div>
          </div>
          <div class="card"><p class="muted">Bruto/COGS/L√≠quida calculados sobre todas las <strong>salidas</strong> usando el costo/precio del <strong>lote</strong> (si existe); si no, se usa el de la pieza.</p></div>
        </section>`;
    }

    async function renderInventario(){
      const tpl = document.getElementById('tpl-inventario').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('partsTbody');
      const search = document.getElementById('searchParts');
      const addBtn = document.getElementById('addPartBtn');
      const formWrap = document.getElementById('partFormWrap');
      const form = document.getElementById('partForm');
      const summary = document.getElementById('partFormSummary');
      const cancelBtn = document.getElementById('cancelEdit');
      const importCSV = document.getElementById('importCSV');
      const filterAlm = document.getElementById('filterAlmacen');
      const safety1 = document.getElementById('safetyDaysHint');
      const safety2 = document.getElementById('safetyDaysHint2');
      if(safety1) safety1.textContent = SAFETY_DAYS;
      if(safety2) safety2.textContent = SAFETY_DAYS;

      let parts = await DB.listParts();

      function buildFilters(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        filterAlm.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }

      function buildSuggestors(){
        const dlAlm = document.getElementById('dlAlmacenes');
        const almChips = document.getElementById('almacenChips');
        const dlProv = document.getElementById('dlProveedores');
        const provChips = document.getElementById('proveedorChips');

        const almacenes = Array.from(new Set(parts.map(p=> (p.almacen||'').trim()).filter(Boolean))).sort();
        const proveedores = Array.from(new Set(parts.map(p=> (p.proveedor||'').trim()).filter(Boolean))).sort();

        dlAlm.innerHTML = almacenes.map(a=>`<option value="${escapeHtml(a)}">`).join('');
        almChips.innerHTML = almacenes.map(a=>`<button type="button" class="chip" data-v="${escapeHtml(a)}">${escapeHtml(a)}</button>`).join('');

        dlProv.innerHTML = proveedores.map(p=>`<option value="${escapeHtml(p)}">`).join('');
        provChips.innerHTML = proveedores.map(p=>`<button type="button" class="chip" data-v="${escapeHtml(p)}">${escapeHtml(p)}</button>`).join('');

        almChips.onclick = (e)=>{ const b = e.target.closest('.chip'); if(!b) return; form.querySelector('[name="almacen"]').value = b.dataset.v; };
        provChips.onclick = (e)=>{ const b = e.target.closest('.chip'); if(!b) return; form.querySelector('[name="proveedor"]').value = b.dataset.v; };
      }

      function matchesFilters(p){
        const q = (search.value||'').toLowerCase().trim();
        const alm = filterAlm.value || '(Todos)';
        const tokens = [p.codigo, p.nombre, p.categoria, p.proveedor, p.almacen].map(x=>String(x||'').toLowerCase());
        const passQ = !q || tokens.some(t=>t.includes(q));
        const passA = alm === '(Todos)' || String(p.almacen||'').toLowerCase() === alm.toLowerCase();
        return passQ && passA;
      }

      function paint(){
        tbody.innerHTML = '';
        parts.filter(matchesFilters).forEach(p=>{
          const low = Number(p.stock) < Number(p.stockMin);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(p.codigo)}</td>
            <td>${escapeHtml(p.nombre)} ${low ? '<span class="badge low">Bajo stock</span>' : ''}</td>
            <td>${escapeHtml(p.categoria||'')}</td>
            <td>${escapeHtml(p.almacen||'')}</td>
            <td>${escapeHtml(p.ubicacion||'')}</td>
            <td class="num">${p.stock}</td>
            <td class="num">${p.stockMin}</td>
            <td class="num">${fmtMoney(p.costo)}</td>
            <td class="num">${fmtMoney(p.precio)}</td>
            <td class="num">
              <button class="btn btn-ghost" data-act="edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-danger" data-act="del" data-id="${p.id}">Eliminar</button>
            </td>`;
          tbody.appendChild(tr);
        });
      }

      buildFilters();
      buildSuggestors();
      paint();

      search.addEventListener('input', paint);
      filterAlm.addEventListener('change', paint);
      addBtn.addEventListener('click', ()=>{
        form.reset();
        form.querySelector('input[name="id"]').value = '';
        summary.textContent = 'Nueva pieza';
        formWrap.open = true;
      });
      cancelBtn.addEventListener('click', ()=>{
        form.reset();
        form.querySelector('input[name="id"]').value = '';
        summary.textContent = 'Nueva pieza';
        formWrap.open = false;
      });
      document.getElementById('scanBtn').addEventListener('click', startScan);

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const part = {
          id: fd.get('id') || undefined,
          codigo: String(fd.get('codigo')).trim(),
          nombre: String(fd.get('nombre')).trim(),
          categoria: String(fd.get('categoria')||'').trim(),
          ubicacion: String(fd.get('ubicacion')||'').trim(),
          almacen: String(fd.get('almacen')||'').trim(),
          proveedor: String(fd.get('proveedor')||'').trim(),
          leadTimeDias: Number(fd.get('leadTimeDias')||0),
          stock: Number(fd.get('stock')||0),
          costo: Number(fd.get('costo')||0),
          precio: Number(fd.get('precio')||0),
        };
        if(!part.codigo || !part.nombre){ alert('C√≥digo y nombre son obligatorios'); return; }

        let prev = null; if(part.id){ prev = (await DB.getPartById(part.id)); }
        try{
          const newId = await DB.upsertPart(part);
          const finalId = part.id || newId;

          // historial de precio (se o usu√°rio alterou custo ou pre√ßo na edi√ß√£o da pe√ßa)
          if(prev && (Number(prev.costo)!==Number(part.costo) || Number(prev.precio)!==Number(part.precio))){
            const u = Auth.currentUser();
            await DB.addPriceHistory({
              piezaId: finalId,
              codigo: prev.codigo, nombre: prev.nombre,
              costoAntes: Number(prev.costo)||0, costoDespues: Number(part.costo)||0,
              precioAntes: Number(prev.precio)||0, precioDespues: Number(part.precio)||0,
              usuario: u ? u.email : ''
            });
          }

          parts = await DB.listParts();
          buildFilters(); buildSuggestors(); paint();

          form.reset(); form.querySelector('input[name="id"]').value = ''; summary.textContent = 'Nueva pieza'; formWrap.open = false;
        }catch(err){ alert(err.message || 'No se pudo guardar'); }
      });

      tbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-act]'); if(!btn) return;
        const id = btn.dataset.id; const act = btn.dataset.act;
        if(act === 'edit'){
          const p = (await DB.getPartById(id)); if(!p) return;
          formWrap.open = true; summary.textContent = `Editar: ${p.nombre}`;
          form.querySelector('input[name="id"]').value = p.id;
          form.querySelector('input[name="codigo"]').value = p.codigo;
          form.querySelector('input[name="nombre"]').value = p.nombre;
          form.querySelector('input[name="categoria"]').value = p.categoria || '';
          form.querySelector('input[name="ubicacion"]').value = p.ubicacion || '';
          form.querySelector('input[name="almacen"]').value = p.almacen || '';
          form.querySelector('input[name="proveedor"]').value = p.proveedor || '';
          form.querySelector('input[name="leadTimeDias"]').value = p.leadTimeDias || 0;
          form.querySelector('input[name="consumoDiario"]').value = p.consumoDiario || 0;
          form.querySelector('input[name="stockMin"]').value = p.stockMin || 0;
          form.querySelector('input[name="stock"]').value = p.stock;
          form.querySelector('input[name="costo"]').value = p.costo;
          form.querySelector('input[name="precio"]').value = p.precio;
        }
        if(act === 'del'){
          if(!confirm('¬øEliminar esta pieza? Esta acci√≥n no se puede deshacer.')) return;
          try{
            await DB.deletePart(id);
            parts = await DB.listParts(); buildFilters(); buildSuggestors(); paint();
          }catch(err){ alert(err.message || 'No se pudo eliminar'); }
        }
      });

      importCSV.addEventListener('change', ()=>{
        const f = importCSV.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          try{
            const lines = String(reader.result||'').split(/\r?\n/).filter(Boolean);
            if(!lines.length){ alert('CSV vac√≠o'); return; }
            const head = lines.shift().split(',').map(h=>h.trim());
            for(const line of lines){
              const cells = parseCSVLine(line);
              const obj = Object.fromEntries(head.map((h,i)=>[h, (cells[i]??'').trim()]));
              const part = {
                codigo: obj.codigo, nombre: obj.nombre, categoria: obj.categoria,
                ubicacion: obj.ubicacion, almacen: obj.almacen, proveedor: obj.proveedor,
                leadTimeDias: Number(obj.leadTimeDias||0),
                stock: Number(obj.stock||0),
                costo: Number(obj.costo_Bs||obj.costo||0),
                precio: Number(obj.precio_Bs||obj.precio||0)
              };
              await DB.upsertPart(part);
            }
            parts = await DB.listParts(); buildFilters(); buildSuggestors(); paint();
            alert('Importaci√≥n completa');
          }catch(e){ alert(e.message || 'Error al importar'); }
          importCSV.value = '';
        };
        reader.readAsText(f);
      });
    }

    async function renderMovimientos(){
      const tpl = document.getElementById('tpl-movimientos').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const moveForm = document.getElementById('moveForm');
      const partSel  = document.getElementById('movePart');
      const tipoSel  = document.getElementById('moveTipo');
      const qtyInput = document.getElementById('moveCantidad');
      const tbody    = document.getElementById('movesTbody');
      const exportBtn= document.getElementById('exportCSV');
      const undoBtn  = document.getElementById('undoLast');
      const almFilter= document.getElementById('moveAlmacenFilter');
      const lotPicker= document.getElementById('lotPicker');
      const lotRows  = document.getElementById('lotRows');
      const lotSumHint = document.getElementById('lotSumHint');

      // campos de ENTRADA
      const entradaFields = Array.from(moveForm.querySelectorAll('[data-show-entrada]'));
      const costoIn = moveForm.querySelector('[name="movCosto"]');
      const precioIn= moveForm.querySelector('[name="movPrecio"]');

      let parts = await DB.listParts();
      let moves = await DB.listMoves(2000);

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        almFilter.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      buildAlmacenOptions();

      function fillPartOptions(){
        const alm = almFilter.value || '(Todos)';
        const list = parts.filter(p => alm === '(Todos)' || String(p.almacen||'').toLowerCase()===alm.toLowerCase());
        partSel.innerHTML = list.map(p=>(
          `<option value="${p.id}">${escapeHtml(p.codigo)} ‚Äî ${escapeHtml(p.nombre)} (${escapeHtml(p.almacen||'')})</option>`
        )).join('');
      }
      fillPartOptions();

      function paintMoves(){
        tbody.innerHTML = '';
        moves.forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(m.fecha)}</td>
            <td>${escapeHtml(m.codigo)}</td>
            <td>${escapeHtml(m.nombre)}</td>
            <td>${escapeHtml(m.almacen||'')}</td>
            <td>${m.tipo === 'entrada' ? 'Entrada' : 'Salida'}</td>
            <td class="num">${m.cantidad}</td>
            <td>${escapeHtml(m.referencia||'')}</td>
            <td>${escapeHtml(m.usuario||'')}</td>`;
          tbody.appendChild(tr);
        });
      }
      paintMoves();

      // Mostrar/ocultar controles conforme o tipo
      function syncTipoUI(){
        const isEntrada = (tipoSel.value === 'entrada');
        entradaFields.forEach(el => el.style.display = isEntrada ? '' : 'none');
        // quantidade: em sa√≠da ser√° controlada pela soma dos lotes
        qtyInput.readOnly = !isEntrada;
        lotPicker.style.display = isEntrada ? 'none' : '';
        lotSumHint.style.display = isEntrada ? 'none' : '';
      }
      syncTipoUI();

      almFilter.addEventListener('change', ()=>{ fillPartOptions(); refreshLotUI(); });
      partSel.addEventListener('change', refreshLotUI);
      tipoSel.addEventListener('change', ()=>{ syncTipoUI(); refreshLotUI(); });

      async function refreshLotUI(){
        if(tipoSel.value !== 'salida'){ // entrada n√£o usa lotes
          lotRows.innerHTML = '';
          return;
        }
        const piezaId = partSel.value;
        if(!piezaId){ lotRows.innerHTML=''; return; }
        const lots = await DB.getLots(piezaId);

        lotRows.innerHTML = '';
        if(!lots.length){
          lotRows.innerHTML = `<tr><td colspan="5" class="muted">No hay lotes con stock disponible para esta pieza.</td></tr>`;
          qtyInput.value = 0;
          return;
        }
        for(const lt of lots){
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(lt.label)}</td>
            <td class="num">${lt.disponible}</td>
            <td class="num">${fmtMoney(lt.costo_unit)}</td>
            <td class="num">${fmtMoney(lt.precio_unit)}</td>
            <td class="num">
              <input type="number" min="0" max="${lt.disponible}" step="1"
                     data-lote="${lt.lote_id || ''}" data-cost="${lt.costo_unit}" data-price="${lt.precio_unit}" class="input" style="width:120px" />
            </td>`;
          lotRows.appendChild(tr);
        }
        updateLotSum();
        lotRows.addEventListener('input', updateLotSum);
      }

      function updateLotSum(){
        const inputs = Array.from(lotRows.querySelectorAll('input[type="number"]'));
        let sum = 0;
        inputs.forEach(i => { const v = Number(i.value||0); if(v>0) sum += v; });
        qtyInput.value = sum || 0;
        lotSumHint.textContent = `Suma de lotes: ${sum}`;
        lotSumHint.style.display = '';
      }

      moveForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(moveForm);
        const piezaId = fd.get('piezaId');
        const tipo = fd.get('tipo');
        const referencia = String(fd.get('referencia')||'').trim();

        if(!piezaId || !tipo){ alert('Complete los campos del movimiento'); return; }

        try{
          const u = Auth.currentUser();

          if(tipo === 'entrada'){
            const cantidad = Number(fd.get('cantidad'));
            if(!(cantidad>0)){ alert('Cantidad inv√°lida'); return; }
            const costoUnit  = fd.get('movCosto');
            const precioUnit = fd.get('movPrecio');
            await DB.applyEntry({
              piezaId, cantidad, referencia, usuarioEmail: u?u.email:'',
              costoUnit: costoUnit===''?null:Number(costoUnit),
              precioUnit:precioUnit===''?null:Number(precioUnit)
            });
          }else{
            // sa√≠da: coletar sele√ß√µes por lote
            const inputs = Array.from(lotRows.querySelectorAll('input[type="number"]'));
            const selections = inputs
              .map(i => ({
                lote_id: i.dataset.lote || null,
                cantidad: Number(i.value||0),
                costo_unit: Number(i.dataset.cost||0),
                precio_unit: Number(i.dataset.price||0)
              }))
              .filter(x => x.cantidad>0);

            const total = selections.reduce((s,x)=> s+x.cantidad, 0);
            if(total<=0){ alert('Seleccione cantidades en al menos un lote'); return; }

            await DB.applyExit({
              piezaId, referencia, usuarioEmail: u?u.email:'', selections
            });
          }

          // Refresh
          const [partsNew, movesNew] = await Promise.all([DB.listParts(), DB.listMoves(2000)]);
          parts = partsNew; moves = movesNew; paintMoves();
          alert('Movimiento registrado');

          // reset form
          moveForm.reset();
          syncTipoUI();
          fillPartOptions();
          lotRows.innerHTML = '';
          qtyInput.value = 0;

        }catch(err){ alert(err.message || 'Error al aplicar movimiento'); }
      });

      exportBtn.addEventListener('click', async ()=>{
        const p = await DB.listParts();
        const head = ['id','codigo','nombre','categoria','almacen','proveedor','leadTimeDias','consumoDiario','ubicacion','stock','stockMin','costo_Bs','precio_Bs'];
        const rows = p.map(pt=>{
          const row = { id:pt.id, codigo:pt.codigo, nombre:pt.nombre, categoria:pt.categoria, almacen:pt.almacen, proveedor:pt.proveedor, leadTimeDias:pt.leadTimeDias, consumoDiario:pt.consumoDiario, ubicacion:pt.ubicacion, stock:pt.stock, stockMin:pt.stockMin, costo_Bs:pt.costo, precio_Bs:pt.precio };
          return head.map(k=>csvCell(row[k] ?? '')).join(',');
        });
        const csv = head.join(',') + '\n' + rows.join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = url; a.download = `inventario_${stamp}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      });

      undoBtn.addEventListener('click', async ()=>{
        try{ await DB.undoLastMovement(); moves = await DB.listMoves(2000); paintMoves(); alert('Movimiento deshecho'); }
        catch(e){ alert(e.message || 'No se pudo deshacer'); }
      });
    }

    async function renderSugerencias(){
      const tpl = document.getElementById('tpl-sugerencias').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('sugTbody');
      const almFilter = document.getElementById('sugAlmacenFilter');
      let parts = await DB.listParts();

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        almFilter.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      buildAlmacenOptions();

      function calcularSugerencias(){
        const alm = almFilter.value || '(Todos)';
        const base = parts.filter(p => alm === '(Todos)' || String(p.almacen||'').toLowerCase()===alm.toLowerCase());
        return base.map(p=>{
          const cd = Number(p.consumoDiario||0);
          const lt = Number(p.leadTimeDias||0);
          const min = Number(p.stockMin||0);
          const stk = Number(p.stock||0);
          const rop = Math.ceil(cd * (lt + SAFETY_DAYS));
          const sug = Math.max(0, rop - stk);
          return {...p, rop, sugerido:sug};
        }).filter(x=>x.sugerido>0);
      }

      function paint(){
        const list = calcularSugerencias();
        tbody.innerHTML = '';
        list.forEach(p=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(p.codigo)}</td>
            <td>${escapeHtml(p.nombre)}</td>
            <td>${escapeHtml(p.proveedor||'')}</td>
            <td>${escapeHtml(p.almacen||'')}</td>
            <td class="num">${p.stock}</td>
            <td class="num">${p.stockMin}</td>
            <td class="num">${p.consumoDiario||0}</td>
            <td class="num">${p.leadTimeDias||0}</td>
            <td class="num">${p.rop}</td>
            <td class="num">${p.sugerido}</td>`;
          tbody.appendChild(tr);
        });
      }
      almFilter.addEventListener('change', paint); paint();
    }

    async function renderAjustes(){
      const tpl = document.getElementById('tpl-ajustes').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const backupBtn = document.getElementById('backupBtn');
      const restoreFile = document.getElementById('restoreFile');
      const resetBtn = document.getElementById('resetBtn');

      const orgName = document.getElementById('orgName');
      const orgSelect = document.getElementById('orgSelect');
      const orgNewBtn = document.getElementById('orgNewBtn');

      (async ()=>{
        const orgs = await Org.myOrgs();
        const cur = Org.get();
        orgName.textContent = cur?.nombre || '‚Äî';
        orgSelect.innerHTML = orgs.map(o => `<option value="${o.id}" ${o.id===cur.id?'selected':''}>${escapeHtml(o.nombre)}</option>`).join('');
      })();

      orgSelect.addEventListener('change', async ()=>{
        const id = orgSelect.value;
        const { data, error } = await sb.from('orgs').select('id,nombre').eq('id', id).maybeSingle();
        if(error || !data){ alert('No se pudo cambiar de empresa'); return; }
        Org.set(data);
        alert('Empresa cambiada a: ' + data.nombre);
        location.hash = '#/dashboard'; await route();
      });

      orgNewBtn.addEventListener('click', async ()=>{
        const nombre = prompt('Nombre de la nueva empresa:'); if(!nombre) return;
        const { data:{ user } } = await sb.auth.getUser();
        const { data: org, error: e1 } = await sb.from('orgs').insert({ nombre, created_by: user?.id }).select().maybeSingle();
        if(e1){ alert(e1.message); return; }
        const { error: e2 } = await sb.from('org_members').insert({ org_id: org.id, user_id: user?.id });
        if(e2){ alert(e2.message); return; }
        Org.set(org);
        alert('Empresa creada y seleccionada: ' + org.nombre);
        location.hash = '#/dashboard'; await route();
      });

      backupBtn.addEventListener('click', async ()=>{
        try{
          const dump = await DB.backupAll();
          const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_inventario.json'; a.click();
        }catch(e){ alert(e.message || 'No se pudo hacer backup'); }
      });

      restoreFile.addEventListener('change', async ()=>{
        const f = restoreFile.files[0]; if(!f) return;
        try{
          const data = JSON.parse(await f.text());
          await DB.restoreAll(data);
          alert('Restauraci√≥n completa'); location.hash = '#/dashboard'; await route();
        }catch(e){ alert('Archivo inv√°lido / restauraci√≥n fall√≥'); }
        finally{ restoreFile.value = ''; }
      });

      resetBtn.addEventListener('click', async ()=>{
        if(!confirm('Esto borrar√° TODAS las piezas, movimientos e historial de la EMPRESA ACTUAL. ¬øContinuar?')) return;
        try{ await DB.wipeCurrentOrg(); alert('Datos borrados de la empresa actual'); location.hash = '#/dashboard'; await route(); }
        catch(e){ alert(e.message || 'No se pudo borrar'); }
      });
    }

    async function renderHistorial(){
      const tpl = document.getElementById('tpl-historial').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('histTbody');
      const hist = await DB.listPriceHistory();
      tbody.innerHTML = '';
      hist.forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(h.fecha)}</td>
          <td>${escapeHtml(h.codigo)}</td>
          <td>${escapeHtml(h.nombre)}</td>
          <td class="num">${fmtMoney(h.costoAntes)} ‚ûù ${fmtMoney(h.costoDespues)}</td>
          <td class="num">${fmtMoney(h.precioAntes)} ‚ûù ${fmtMoney(h.precioDespues)}</td>
          <td>${escapeHtml(h.usuario||'')}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* --------- Esc√°ner (opcional) --------- */
    async function startScan(){
      try{
        if(!('BarcodeDetector' in window)){ alert('Esc√°ner no soportado; ingrese el c√≥digo manualmente.'); return; }
        const video = document.getElementById('cam');
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
        video.srcObject = stream; await video.play();
        const det = new BarcodeDetector({formats:['code_128','ean_13','ean_8','qr_code','upc_a','upc_e']});
        const codeInput = document.querySelector('input[name="codigo"]');
        let running = true;
        const stop = ()=>{ running=false; if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); } video.srcObject=null; };
        const tick = async ()=>{
          if(!running) return;
          try{ const codes = await det.detect(video);
            if(codes.length){ codeInput.value = codes[0].rawValue || ''; stop(); alert('C√≥digo detectado: ' + codeInput.value); return; }
          }catch(e){}
          requestAnimationFrame(tick);
        };
        tick();
      }catch(err){ alert('No se pudo abrir la c√°mara'); }
    }

    // Boot
    init();
  </script>
</body>
</html>
