<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Gestión de Inventario — Autopartes</title>

  <!-- Chart.js para gráficos de Reportes -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    :root{
      --bg:#f6f7f9; --card:#ffffff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
      --primary:#1f6feb; --danger:#ef4444; --radius:12px;
      --shadow:0 1px 2px rgba(0,0,0,.04),0 6px 24px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      color:var(--text);
      background:var(--bg);
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }

    .app{display:grid; grid-template-columns:260px 1fr; min-height:100vh;}
    .app.no-sidebar{ grid-template-columns:1fr; min-height:100dvh; }
    .sidebar{border-right:1px solid var(--border); background:#fafafa; padding:16px; display:flex; flex-direction:column; gap:16px;}
    .hidden{display:none !important}

    .brand{display:flex; align-items:center; gap:12px; padding:8px 6px}
    .brand .logo{font-size:28px}
    .nav{display:flex; flex-direction:column; gap:6px}
    .nav-btn{ text-align:left; border:1px solid var(--border); background:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .nav-btn:hover{border-color:#d1d5db}
    .sidebar-foot{ margin-top:auto; display:flex; flex-direction:column; gap:8px; }
    .user-label{font-size:12px; color:var(--muted)}

    .view{padding:24px; max-width:1200px; width:100%}

    .center{
      display:flex; align-items:center; justify-content:center;
      min-height:100dvh;
      padding:clamp(16px, 5vw, 48px);
      padding-top:calc(env(safe-area-inset-top,0px) + clamp(16px, 5vw, 48px));
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + clamp(16px, 5vw, 48px));
    }
    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px;}
    .card-max{width:min(100%, 420px)}
    .title{margin:0 0 8px}
    .muted{color:var(--muted)}
    .xs{font-size:12px}

    .form{display:flex; flex-direction:column; gap:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    .field input, .field select, .input{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      background:#fff;
      width:100%;
      height:44px;
      font-size:16px;
    }
    .field input[readonly]{ background:#f8fafc; }
    .field input:focus, .field select:focus, .input:focus{outline:2px solid rgba(31,111,235,.25)}

    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:10px 14px;
      cursor:pointer;
      height:44px;
      font-size:16px;
    }
    .btn-primary{background:var(--primary); color:#fff; border-color:transparent}
    .btn-ghost{background:transparent}
    .btn-danger{background:var(--danger); color:#fff; border-color:transparent}

    .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    .toolbar .right{display:flex; gap:8px; flex-wrap:wrap}
    .stack{display:flex; flex-direction:column; gap:12px}

    .table-wrap{width:100%; overflow:auto}
    .table{width:100%; border-collapse:separate; border-spacing:0}
    .table th,.table td{padding:10px 12px; border-bottom:1px solid var(--border)}
    .table th{font-weight:600; text-align:left; white-space:nowrap}
    .table td.num,.table th.num{text-align:right}

    .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border);}
    .badge.low{background:#fff5f5; color:#b91c1c; border-color:#fecaca}

    .row-actions{display:flex; gap:8px; align-items:center}

    .grid{ display:grid; grid-template-columns:repeat(4, minmax(0, 1fr)); gap:12px; }
    .grid .field{min-width:0}

    .kpis{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
    .kpis .card h3{margin:0 0 6px; font-size:14px; color:var(--muted)}
    .kpis .card strong{font-size:20px}

    /* chips */
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }
    .chip { border:1px solid var(--border); background:#fff; border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer; }
    .chip:hover { border-color:#d1d5db }

    /* Inventario: fila compacta + drawer de lotes */
    .table.compact th, .table.compact td { padding:8px 10px; font-size:14px; }
    details.inline { display:block; }
    details.inline > summary {
      list-style: none;
      cursor: pointer;
      display:inline-flex; align-items:center; gap:6px;
      font-weight:600; color:var(--text);
    }
    details.inline > summary::before{
      content:"▸";
      display:inline-block;
      transform:translateY(1px);
    }
    details.inline[open] > summary::before{ content:"▾"; }
    .lots-list { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px }
    .lot-chip { border:1px dashed var(--border); border-radius:8px; padding:6px 8px; font-size:12px; background:#fff; }
    .lot-chip b{font-weight:700}

    /* Miniatura da peça na tabela */
    .table .thumb{
      width:32px; height:32px; object-fit:cover; border-radius:6px;
      border:1px solid var(--border); margin-right:8px; vertical-align:middle;
    }

    /* Charts compactos */
    .charts-compact canvas { max-height: 180px; }

    /* Grupo de filtros (Reportes) com maior separação visual */
    .filter-group{ display:flex; gap:14px; align-items:flex-end; flex-wrap:wrap; }
    .filter-group .field{ margin:0 }

    /* Responsivo */
    @media (max-width:1100px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width:900px){
      .app{grid-template-columns:1fr}
      .sidebar{position:sticky; top:0; z-index:10}
      .grid{grid-template-columns:repeat(2, minmax(0,1fr))}
      .charts-compact{ grid-template-columns:1fr !important; }
    }
    @media (max-width:600px){
      .view{padding:16px}
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:1fr;}
      .toolbar .right{gap:6px}
      .table.compact th, .table.compact td { padding:8px 8px; font-size:13px; }
    }

    #cam{width:1px;height:1px;position:absolute;left:-9999px;top:-9999px}
  </style>
</head>
<body>
  <div id="app" class="app no-sidebar">
    <aside id="sidebar" class="sidebar hidden" aria-hidden="true">
      <div class="brand">
        <div class="logo" aria-hidden="true">🔧</div>
        <div><strong>Autopartes</strong><small> Inventario</small></div>
      </div>
      <nav class="nav" aria-label="Navegación principal">
        <button class="nav-btn" data-route="reportes">Reportes</button>
        <button class="nav-btn" data-route="inventario">Inventario</button>
        <button class="nav-btn" data-route="movimientos">Movimientos</button>
        <button class="nav-btn" data-route="sugerencias">Sugerencias</button>
        <button class="nav-btn" data-route="historial">Historial precios</button>
        <button class="nav-btn" data-route="ajustes">Ajustes</button>
      </nav>
      <div class="sidebar-foot">
        <span id="userLabel" class="user-label"></span>
        <button id="logoutBtn" class="btn btn-ghost">Cerrar sesión</button>
      </div>
    </aside>
    <main id="view" class="view"></main>
  </div>

  <!-- Templates -->
  <template id="tpl-login">
    <section class="center">
      <div class="card card-max" role="dialog" aria-labelledby="loginTitle">
        <h1 id="loginTitle" class="title" style="text-align:center">Iniciar sesión</h1>
        <p class="muted" style="text-align:center">Acceso interno — Gestión de inventario de autopartes.</p>
        <form id="loginForm" class="form">
          <label class="field"><span>Correo</span>
            <input type="email" name="email" placeholder="admin@empresa.com" required autocomplete="username" />
          </label>
          <label class="field"><span>Contraseña</span>
            <input type="password" name="password" placeholder="********" required autocomplete="current-password" />
          </label>
          <button class="btn btn-primary" type="submit">Entrar</button>
        </form>
      </div>
    </section>
  </template>

  <template id="tpl-reportes">
    <section class="stack">
      <header class="toolbar">
        <div class="left">
          <h2>Reportes</h2>
          <p class="muted">Ventas, inventario y período filtrable.</p>
        </div>
        <div class="right">
          <div class="filter-group">
            <label class="field" style="min-width:160px">
              <span class="xs muted">Desde</span>
              <input type="date" id="repDesde" class="input" />
            </label>
            <label class="field" style="min-width:160px">
              <span class="xs muted">Hasta</span>
              <input type="date" id="repHasta" class="input" />
            </label>
            <button id="repAplicar" class="btn btn-primary">Aplicar</button>
          </div>
        </div>
      </header>

      <div class="kpis">
        <div class="card"><h3>Ventas brutas</h3><strong id="kpiBruto">—</strong></div>
        <div class="card"><h3>COGS</h3><strong id="kpiCogs">—</strong></div>
        <div class="card"><h3>Ganancia neta</h3><strong id="kpiLiquida">—</strong></div>
        <div class="card"><h3>Unidades vendidas</h3><strong id="kpiUnits">—</strong></div>
      </div>

      <div class="kpis">
        <div class="card"><h3>Valor del inventario (por lotes)</h3><strong id="kpiInvVal">—</strong></div>
        <div class="card"><h3>Días de seguridad</h3><strong id="kpiSafety">—</strong></div>
        <div class="card"><h3>SKUs</h3><strong id="kpiSkus">—</strong></div>
        <div class="card"><h3>Movimientos (período)</h3><strong id="kpiMovs">—</strong></div>
      </div>

      <div class="charts-compact" style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px">
        <div class="card">
          <h3 style="margin:0 0 8px">Top 10 vendidas (unid.)</h3>
          <canvas id="chartTop" height="150"></canvas>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px">Ingresos por día</h3>
          <canvas id="chartDia" height="150"></canvas>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-inventario">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Inventario</h2><p class="muted">Piezas registradas, lotes y estado de stock.</p></div>
        <div class="right">
          <select id="filterAlmacen" class="input" title="Filtrar por almacén"></select>
          <input id="searchParts" class="input" placeholder="Buscar por código, nombre o categoría…" />
          <label class="btn" for="importCSV">Importar CSV</label>
          <input id="importCSV" type="file" accept=".csv" style="display:none" />
          <button id="addPartBtn" class="btn btn-primary">Añadir pieza</button>
        </div>
      </header>
      <details id="partFormWrap" class="card">
        <summary id="partFormSummary">Nueva pieza</summary>
        <form id="partForm" class="grid">
          <input type="hidden" name="id" />
          <label class="field"><span>Código</span>
            <div style="display:flex; gap:8px">
              <input name="codigo" required placeholder="ABC-123" style="flex:1" />
              <button type="button" id="scanBtn" class="btn">Escanear</button>
            </div>
            <video id="cam" playsinline></video>
          </label>
          <label class="field"><span>Nombre</span><input name="nombre" required placeholder="Filtro de aceite" /></label>
          <label class="field"><span>Categoría</span><input name="categoria" placeholder="Motor, Suspensión, Frenos…" /></label>
          <label class="field"><span>Ubicación</span><input name="ubicacion" placeholder="Estante A3" /></label>

          <!-- Almacén con datalist + chips -->
          <label class="field"><span>Almacén</span>
            <input name="almacen" placeholder="Central, Sucursal 1…" list="dlAlmacenes" />
            <datalist id="dlAlmacenes"></datalist>
            <div class="chips" id="almacenChips"></div>
            <span class="xs muted">Tip: puedes escribir libremente o hacer clic en un chip.</span>
          </label>

          <!-- Proveedor con datalist + chips -->
          <label class="field"><span>Proveedor</span>
            <input name="proveedor" placeholder="Proveedor principal" list="dlProveedores" />
            <datalist id="dlProveedores"></datalist>
            <div class="chips" id="proveedorChips"></div>
          </label>

          <label class="field"><span>Tiempo de reposición (días)</span>
            <input name="leadTimeDias" type="number" min="0" step="1" value="0" />
          </label>

          <!-- AUTOMÁTICOS (solo lectura) -->
          <label class="field"><span>Consumo diario (auto)</span>
            <input name="consumoDiario" type="number" min="0" step="0.01" value="0" readonly
              title="Calculado automáticamente por movimientos (últimos 30 días)" />
          </label>
          <label class="field"><span>Stock mínimo (auto)</span>
            <input name="stockMin" type="number" min="0" step="1" value="0" readonly
              title="ceil(CD × días de seguridad)" />
          </label>

          <label class="field"><span>Stock</span><input name="stock" type="number" min="0" step="1" value="0" required /></label>
          <label class="field"><span>Costo unitario (Bs)</span><input name="costo" type="number" min="0" step="0.01" value="0" /></label>
          <label class="field"><span>Precio de venta (Bs)</span><input name="precio" type="number" min="0" step="0.01" value="0" /></label>
          <div class="row-actions">
            <button class="btn btn-primary" type="submit">Guardar</button>
            <button type="button" id="cancelEdit" class="btn btn-ghost">Cancelar</button>
          </div>
        </form>
        <p class="muted xs">
          Cálculo: CD = salidas/30d. Stock mínimo = ceil(CD × <span id="safetyDaysHint"></span>).
          Punto de pedido (ROP) = ceil(CD × (LT + <span id="safetyDaysHint2"></span>)).
        </p>
      </details>

      <div class="card">
        <div class="table-wrap">
          <table class="table compact" id="partsTable">
            <thead><tr>
              <th>Código</th><th>Nombre</th><th>Categoría</th><th>Almacén</th><th>Ubicación</th>
              <th class="num">Stock</th><th class="num">Mín</th>
              <th class="num">Costo base</th><th class="num">Precio base</th>
              <th>Lotes</th><th></th>
            </tr></thead>
            <tbody id="partsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-movimientos">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Movimientos</h2><p class="muted">Entradas y salidas que afectan el stock.</p></div>
        <div class="right">
          <select id="moveAlmacenFilter" class="input" title="Filtrar piezas por almacén"></select>
          <button id="undoLast" class="btn btn-danger">Deshacer último</button>
          <button id="exportCSV" class="btn">Exportar inventario (CSV)</button>
        </div>
      </header>

      <div class="card">
        <h3>Registrar movimiento</h3>
        <form id="moveForm" class="grid">
          <label class="field"><span>Pieza</span>
            <select name="piezaId" id="movePart" required></select>
          </label>

          <label class="field"><span>Tipo</span>
            <select name="tipo" id="moveTipo" required>
              <option value="entrada">Entrada</option>
              <option value="salida">Salida</option>
            </select>
          </label>

          <label class="field"><span>Cantidad</span>
            <input name="cantidad" type="number" min="1" step="1" required />
          </label>

          <!-- CAMPOS EXTRAS PARA ENTRADA -->
          <div id="entradaFields" class="field" style="grid-column: span 2; display:none">
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px">
              <label class="field"><span>Costo unitario (Bs)</span>
                <input id="entradaCosto" type="number" step="0.01" min="0" placeholder="Costo de este lote" />
              </label>
              <label class="field"><span>Precio unitario (Bs)</span>
                <input id="entradaPrecio" type="number" step="0.01" min="0" placeholder="Precio de este lote" />
              </label>
            </div>
            <span class="xs muted">Estos valores se guardan en el <strong>lote</strong> que está entrando y no cambian el precio/costo base de la pieza.</span>
          </div>

          <!-- CAMPOS EXTRAS PARA SALIDA -->
          <div id="salidaFields" class="field" style="grid-column: span 2; display:none">
            <label class="field"><span>Seleccionar lote para salida</span>
              <select id="salidaLote"></select>
            </label>
            <div id="salidaLotesInfo" class="muted xs"></div>
          </div>

          <label class="field"><span>Referencia</span><input name="referencia" placeholder="Factura, orden, motivo…" /></label>

          <div class="row-actions" style="grid-column: 1 / -1"><button type="submit" class="btn btn-primary">Aplicar</button></div>
        </form>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table class="table compact" id="movesTable">
            <thead><tr>
              <th>Fecha</th><th>Código</th><th>Nombre</th><th>Almacén</th><th>Tipo</th>
              <th class="num">Cantidad</th><th>Referencia</th><th>Usuario</th><th></th>
            </tr></thead>
            <tbody id="movesTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-sugerencias">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Sugerencias de compra</h2><p class="muted">Basado en CD, lead time y stock mínimo.</p></div>
        <div class="right"><select id="sugAlmacenFilter" class="input" title="Filtrar por almacén"></select></div>
      </header>
      <div class="card">
        <div class="table-wrap">
          <table class="table compact" id="sugTable">
            <thead><tr>
              <th>Código</th><th>Nombre</th><th>Proveedor</th><th>Almacén</th>
              <th class="num">Stock</th><th class="num">Mín</th><th class="num">CD</th><th class="num">LT</th>
              <th class="num">Punto pedido</th><th class="num">Sugerido</th>
            </tr></thead>
            <tbody id="sugTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-ajustes">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Ajustes</h2><p class="muted">Empresa, backup y restauración.</p></div>
        <div class="right">
          <button id="backupBtn" class="btn">Backup JSON</button>
          <label class="btn" for="restoreFile">Restaurar JSON</label>
          <input id="restoreFile" type="file" accept="application/json" style="display:none"/>
          <button id="resetBtn" class="btn btn-danger">Vaciar datos (empresa actual)</button>
        </div>
      </header>

      <div class="card" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
        <strong>Empresa actual:</strong>
        <span id="orgName">—</span>
        <select id="orgSelect" class="input"></select>
        <button id="orgNewBtn" class="btn">Nueva empresa</button>
      </div>
    </section>
  </template>

  <template id="tpl-historial">
    <section class="stack">
      <header class="toolbar">
        <div class="left"><h2>Historial de precios</h2><p class="muted">Cambios de costo y precio por pieza.</p></div>
        <div class="right"></div>
      </header>
      <div class="card">
        <div class="table-wrap">
          <table class="table compact" id="histTable">
            <thead><tr>
              <th>Fecha</th><th>Código</th><th>Nombre</th>
              <th class="num">Costo (antes ➝ después)</th><th class="num">Precio (antes ➝ después)</th><th>Usuario</th>
            </tr></thead>
            <tbody id="histTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <!-- Picker global para imagen -->
  <input id="imagePicker" type="file" accept="image/*" style="display:none" />

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    /* =======================
       CONFIG SUPABASE
    ======================= */
    const SUPABASE_URL = 'https://zbqshivafjhbghksuhkz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpicXNoaXZhZmpoYmdoa3N1aGt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3MjAzMTEsImV4cCI6MjA3NTI5NjMxMX0.t89MkdRDYHTSs8-pk7gzglZMNlXxGG-VKIQl7Hu8vtE';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Parámetros para cálculos automáticos
    const CD_WINDOW_DAYS = 30;
    const SAFETY_DAYS   = 2; // días de seguridad (buffer)

    /* ===== Utils ===== */
    const fmtMoney = (n)=> Number(n||0).toLocaleString('es-BO', {style:'currency', currency:'BOB'});
    const fmtDate  = (d)=> new Date(d).toLocaleString(undefined, {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});
    const escapeHtml = (s)=> String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const csvCell = (v)=> { const needsQuote = /[",\n]/.test(String(v)); const esc = String(v).replace(/"/g,'""'); return needsQuote ? `"${esc}"` : esc; };
    const parseCSVLine = (s)=>{ const out=[]; let cur=''; let q=false; for(let i=0;i<s.length;i++){ const c=s[i]; if(c==='"'){ if(q && s[i+1]==='"'){cur+='"'; i++;} else {q=!q;} continue; } if(c===',' && !q){ out.push(cur); cur=''; continue; } cur+=c; } out.push(cur); return out; };

    /* ===== Auth ===== */
    const Auth = (() => {
      let cache = null; // {id,email}
      function set(user){
        cache = user ? { id:user.id, email:user.email } : null;
        if(cache) localStorage.setItem('authedUser', JSON.stringify(cache));
        else localStorage.removeItem('authedUser');
      }
      async function init(){
        const { data:{ user } } = await sb.auth.getUser();
        set(user || null);
        sb.auth.onAuthStateChange((_event, session)=>{
          set(session?.user || null);
          route();
        });
      }
      const isAuthed = () => !!cache;
      const currentUser = () => cache;
      async function login(email, password){
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if(error) return { ok:false, error: error.message };
        return { ok:true };
      }
      async function logout(){ await sb.auth.signOut(); }
      return { init, isAuthed, currentUser, login, logout };
    })();

    /* ===== Org ===== */
    const Org = (() => {
      let currentId = localStorage.getItem('currentOrgId') || null;
      let currentName = localStorage.getItem('currentOrgName') || null;

      const get = () => ({ id: currentId, nombre: currentName });
      const set = (org) => {
        currentId = org?.id || null;
        currentName = org?.nombre || null;
        if (currentId) localStorage.setItem('currentOrgId', currentId); else localStorage.removeItem('currentOrgId');
        if (currentName) localStorage.setItem('currentOrgName', currentName); else localStorage.removeItem('currentOrgName');
      };

      async function myOrgs() {
        const { data:{ user } } = await sb.auth.getUser();
        const uid = user?.id;
        if(!uid) return [];
        const { data: mems, error } = await sb.from('org_members').select('org_id').eq('user_id', uid);
        if(error) throw error;
        if(!mems?.length) return [];
        const ids = mems.map(m=>m.org_id);
        const { data: orgs, error: e2 } = await sb.from('orgs').select('id, nombre').in('id', ids).order('nombre');
        if(e2) throw e2;
        return orgs;
      }

      async function ensureCurrent() {
        const orgs = await myOrgs();
        if (!orgs.length) {
          const nombre = prompt('Nombre de la empresa (crearemos una nueva ahora):');
          if(!nombre) throw new Error('Necesita crear/seleccionar una empresa para continuar.');
          const { data:{ user } } = await sb.auth.getUser();
          const { data: created, error } = await sb.from('orgs').insert({ nombre, created_by: user?.id }).select().maybeSingle();
          if (error) throw error;
          const { error: e2 } = await sb.from('org_members').insert({ org_id: created.id, user_id: user?.id });
          if (e2) throw e2;
          set(created);
          return created;
        }
        const found = orgs.find(o => o.id === currentId) || orgs[0];
        set(found);
        return found;
      }

      return { get, set, myOrgs, ensureCurrent };
    })();

    /* ===== DB (Supabase) ===== */
    const DB = (() => {
      function orgId(){ const o = Org.get(); if(!o?.id) throw new Error('Empresa no seleccionada'); return o.id; }

      // ---- Partes ----
      async function listParts(){
        const { data, error } = await sb
          .from('parts')
          .select('id, org_id, codigo, nombre, categoria, ubicacion, almacen, proveedor, lead_time_dias, consumo_diario, stock, stock_min, costo, precio, image_url, image_path')
          .eq('org_id', orgId())
          .order('nombre',{ascending:true});
        if(error) throw error;
        return (data||[]).map(r => ({
          id:r.id, codigo:r.codigo, nombre:r.nombre, categoria:r.categoria||'',
          ubicacion:r.ubicacion||'', almacen:r.almacen||'', proveedor:r.proveedor||'',
          leadTimeDias:Number(r.lead_time_dias||0), consumoDiario:Number(r.consumo_diario||0),
          stock:Number(r.stock||0), stockMin:Number(r.stock_min||0),
          costo:Number(r.costo||0), precio:Number(r.precio||0),
          imageUrl: r.image_url || null, imagePath: r.image_path || null
        }));
      }

      async function getPartById(id){
        if(!id) return null;
        const { data, error } = await sb.from('parts')
          .select('id, org_id, codigo, nombre, categoria, ubicacion, almacen, proveedor, lead_time_dias, consumo_diario, stock, stock_min, costo, precio, image_url, image_path')
          .eq('id', id).eq('org_id', orgId()).maybeSingle();
        if(error) throw error;
        if(!data) return null;
        return {
          id:data.id, codigo:data.codigo, nombre:data.nombre, categoria:data.categoria||'',
          ubicacion:data.ubicacion||'', almacen:data.almacen||'', proveedor:data.proveedor||'',
          leadTimeDias:Number(data.lead_time_dias||0), consumoDiario:Number(data.consumo_diario||0),
          stock:Number(data.stock||0), stockMin:Number(data.stock_min||0),
          costo:Number(data.costo||0), precio:Number(data.precio||0),
          imageUrl:data.image_url || null, imagePath:data.image_path || null
        };
      }

      // ---- Lotes ----
      async function listLots(partId){
        if(!partId) return [];
        const { data, error } = await sb.from('part_lots')
          .select('id, qty, costo_unit, precio_unit')
          .eq('org_id', orgId())
          .eq('part_id', partId)
          .order('id', {ascending:true});
        if(error) throw error;
        return (data||[]).filter(l => Number(l.qty||0) > 0);
      }
      async function listAllLots(limit=20000){
        const { data, error } = await sb.from('part_lots')
          .select('id, part_id, qty, costo_unit, precio_unit')
          .eq('org_id', orgId())
          .limit(limit);
        if(error) throw error;
        return data||[];
      }
      async function getInventoryValueByLots(){
        const lots = await listAllLots(50000);
        return lots.reduce((s,l)=> s + Number(l.qty||0)*Number(l.costo_unit||0), 0);
      }

      async function createLot({ partId, qty, costo_unit, precio_unit }){
        const { data, error } = await sb.from('part_lots')
          .insert({
            org_id: orgId(),
            part_id: partId,
            qty: Number(qty||0),
            costo_unit: Number(costo_unit||0),
            precio_unit: Number(precio_unit||0),
          })
          .select('id, qty, costo_unit, precio_unit')
          .maybeSingle();
        if(error) throw error;
        return data;
      }

      // Crear lote + movimiento de ENTRADA para pieza recién creada (stock inicial)
      async function createInitialLotForPart({ partRow, qty, costo, precio }) {
        const q = Number(qty || 0);
        const c = Number(costo || 0);
        const p = Number(precio || 0);
        if (!(q > 0)) return;

        const { data: lot, error: e1 } = await sb
          .from('part_lots')
          .insert({
            org_id: orgId(),
            part_id: partRow.id,
            qty: q,
            costo_unit: c,
            precio_unit: p,
          })
          .select('id')
          .maybeSingle();
        if (e1) throw e1;

        const u = Auth.currentUser();
        const { error: e2 } = await sb.from('movements').insert({
          org_id: orgId(),
          pieza_id: partRow.id,
          codigo: partRow.codigo,
          nombre: partRow.nombre,
          almacen: partRow.almacen || '',
          tipo: 'entrada',
          cantidad: q,
          referencia: 'Entrada inicial (Inventario)',
          usuario: u ? u.email : '',
          costo_unit: c,
          precio_unit: p,
          lote_id: lot.id,
        });
        if (e2) throw e2;

        const { error: e3 } = await sb
          .from('parts')
          .update({ stock: q })
          .eq('id', partRow.id)
          .eq('org_id', orgId());
        if (e3) throw e3;
      }

      // Upsert de piezas
      async function upsertPart(part){
        const base = {
          org_id: orgId(),
          codigo: part.codigo, nombre: part.nombre,
          categoria: part.categoria || null, ubicacion: part.ubicacion || null,
          almacen: part.almacen || null, proveedor: part.proveedor || null,
          lead_time_dias: Number(part.leadTimeDias||0),
          costo: Number(part.costo||0), precio: Number(part.precio||0),
        };

        if(part.id){
          const { error } = await sb.from('parts')
            .update(base)
            .eq('id', part.id).eq('org_id', orgId());
          if(error) throw error;
          return part.id;
        }else{
          const initialQty = Number(part.stock || 0);
          const rowInsert = {
            ...base,
            stock: 0,
            consumo_diario: 0,
            stock_min: 0,
          };
          const { data: created, error } = await sb
            .from('parts')
            .insert(rowInsert)
            .select('id, codigo, nombre, almacen')
            .maybeSingle();
          if(error) throw error;

          if(initialQty > 0){
            await createInitialLotForPart({
              partRow: created,
              qty: initialQty,
              costo: part.costo,
              precio: part.precio
            });
          }
          return created.id;
        }
      }

      async function deletePart(id){
        const { error } = await sb.from('parts').delete().eq('id', id).eq('org_id', orgId());
        if(error) throw error;
      }

      // ---- Movimientos ----
      async function listMoves(limit=2000){
        const { data, error } = await sb.from('movements')
          .select('id, fecha, pieza_id, codigo, nombre, almacen, tipo, cantidad, referencia, usuario, costo_unit, precio_unit, lote_id')
          .eq('org_id', orgId())
          .order('fecha',{ascending:false})
          .limit(limit);
        if(error) throw error;
        return data||[];
      }

      // Aplicar movimiento con LOTES
      async function applyMovement({piezaId, tipo, cantidad, referencia, usuarioEmail, costoUnit, precioUnit, loteId}){
        const { data: p, error: e1 } = await sb.from('parts')
          .select('id, stock, codigo, nombre, almacen, costo, precio')
          .eq('id', piezaId).eq('org_id', orgId()).maybeSingle();
        if(e1) throw e1;
        if(!p) throw new Error('Pieza no encontrada');

        const q = Number(cantidad||0);
        if(!(q>0)) throw new Error('Cantidad inválida');

        if(tipo === 'entrada'){
          const c = (costoUnit != null) ? Number(costoUnit) : Number(p.costo||0);
          const pr = (precioUnit != null) ? Number(precioUnit) : Number(p.precio||0);

          // crear nuevo lote con este costo/precio
          const lot = await createLot({ partId: p.id, qty: q, costo_unit: c, precio_unit: pr });

          // actualizar saldo de la pieza
          const { error: upErr } = await sb.from('parts')
            .update({ stock: Number(p.stock||0) + q })
            .eq('id', p.id).eq('org_id', orgId());
          if(upErr) throw upErr;

          // registrar el movimiento
          const { error: insErr } = await sb.from('movements').insert({
            org_id: orgId(),
            pieza_id: p.id, codigo: p.codigo, nombre: p.nombre,
            almacen: p.almacen || '', tipo: 'entrada', cantidad: q,
            referencia: referencia || '', usuario: usuarioEmail || '',
            costo_unit: c, precio_unit: pr, lote_id: lot.id
          });
          if(insErr) throw insErr;

        }else{ // SALIDA
          if(!loteId) throw new Error('Seleccione el lote para la salida');
          // buscar lote
          const { data: lot, error: el } = await sb.from('part_lots')
            .select('id, qty, costo_unit, precio_unit')
            .eq('org_id', orgId())
            .eq('id', loteId)
            .maybeSingle();
          if(el) throw el;
          if(!lot) throw new Error('Lote no encontrado');
          if(Number(lot.qty||0) < q) throw new Error('Cantidad supera el disponible del lote');

          // decrementar lote
          const { error: updLot } = await sb.from('part_lots')
            .update({ qty: Number(lot.qty||0) - q })
            .eq('id', lot.id).eq('org_id', orgId());
          if(updLot) throw upLot;

          // actualizar saldo de la pieza
          if(Number(p.stock||0) < q) throw new Error('Stock insuficiente para la salida');
          const { error: upErr2 } = await sb.from('parts')
            .update({ stock: Number(p.stock||0) - q })
            .eq('id', p.id).eq('org_id', orgId());
          if(upErr2) throw upErr2;

          // registrar el movimiento (con costo/precio del lote)
          const { error: insErr2 } = await sb.from('movements').insert({
            org_id: orgId(),
            pieza_id: p.id, codigo: p.codigo, nombre: p.nombre,
            almacen: p.almacen || '', tipo: 'salida', cantidad: q,
            referencia: referencia || '', usuario: usuarioEmail || '',
            costo_unit: Number(lot.costo_unit||0),
            precio_unit: Number(lot.precio_unit||0),
            lote_id: lot.id
          });
          if(insErr2) throw insErr2;
        }

        await recomputeMetrics(piezaId);
      }

      // ==== DESHACER POR ID ====
      async function undoMovementById(movId){
        const { data: m, error: e0 } = await sb.from('movements')
          .select('id, tipo, cantidad, pieza_id, lote_id')
          .eq('org_id', orgId())
          .eq('id', movId)
          .maybeSingle();
        if(e0) throw e0;
        if(!m) throw new Error('Movimiento no encontrado');

        const q = Number(m.cantidad||0);
        if(!(q>0)) throw new Error('Cantidad inválida');

        let lot = null;
        if(m.lote_id){
          const lr = await sb.from('part_lots')
            .select('id, qty, costo_unit, precio_unit, part_id')
            .eq('org_id', orgId())
            .eq('id', m.lote_id)
            .maybeSingle();
          if(lr.error) throw lr.error;
          lot = lr.data || null;
        }

        let piezaId = m.pieza_id || (lot?.part_id ?? null);

        let p = null;
        if(piezaId){
          const pr = await sb.from('parts')
            .select('id, stock')
            .eq('org_id', orgId())
            .eq('id', piezaId)
            .maybeSingle();
          if(pr.error) throw pr.error;
          p = pr.data || null;
        }

        if(m.tipo === 'entrada'){
          if(p && lot){
            if(Number(p.stock||0) < q){
              throw new Error('No se puede deshacer: el stock actual es menor que la entrada.');
            }
            if(Number(lot.qty||0) < q){
              throw new Error('No se puede deshacer: ya hubo salidas desde este lote.');
            }

            const upLot = await sb.from('part_lots')
              .update({ qty: Number(lot.qty||0) - q })
              .eq('org_id', orgId())
              .eq('id', lot.id);
            if(upLot.error) throw upLot.error;

            const upP = await sb.from('parts')
              .update({ stock: Math.max(0, Number(p.stock||0) - q) })
              .eq('org_id', orgId())
              .eq('id', p.id);
            if(upP.error) throw upP.error;

          }else{
            // huérfano: solo borrar el movimiento
          }
        }else{ // SALIDA
          if(lot){
            const upLot = await sb.from('part_lots')
              .update({ qty: Number(lot.qty||0) + q })
              .eq('org_id', orgId())
              .eq('id', lot.id);
            if(upLot.error) throw upLot.error;
          }else{
            if(p){
              throw new Error('No se puede deshacer: salida antigua sin lote asociado.');
            }
          }

          if(p){
            const upP = await sb.from('parts')
              .update({ stock: Number(p.stock||0) + q })
              .eq('org_id', orgId())
              .eq('id', p.id);
            if(upP.error) throw upP.error;
          }
        }

        const del = await sb.from('movements')
          .delete()
          .eq('org_id', orgId())
          .eq('id', m.id);
        if(del.error) throw del.error;

        if(piezaId){ await recomputeMetrics(piezaId); }
      }

      async function undoLastMovement(){
        const { data: last, error } = await sb.from('movements')
          .select('id')
          .eq('org_id', orgId())
          .order('fecha',{ascending:false})
          .limit(1).maybeSingle();
        if(error) throw error;
        if(!last) throw new Error('Sin movimientos');
        await undoMovementById(last.id);
      }

      // ---- Historial de precios ----
      async function listPriceHistory(limit=500){
        const { data, error } = await sb.from('price_history')
          .select('fecha, codigo, nombre, costo_antes, costo_despues, precio_antes, precio_despues, usuario')
          .eq('org_id', orgId())
          .order('fecha',{ascending:false})
          .limit(limit);
        if(error) throw error;
        return (data||[]).map(h=>({
          fecha:h.fecha, codigo:h.codigo, nombre:h.nombre,
          costoAntes:h.costo_antes, costoDespues:h.costo_despues,
          precioAntes:h.precio_antes, precioDespues:h.precio_despues,
          usuario:h.usuario
        }));
      }

      async function addPriceHistory(entry){
        const row = {
          org_id: orgId(),
          pieza_id: entry.piezaId || null, codigo: entry.codigo, nombre: entry.nombre,
          costo_antes: Number(entry.costoAntes||0), costo_despues: Number(entry.costoDespues||0),
          precio_antes: Number(entry.precioAntes||0), precio_despues: Number(entry.precioDespues||0),
          usuario: entry.usuario || ''
        };
        const { error } = await sb.from('price_history').insert(row);
        if(error) throw error;
      }

      // ---- Sincronizar costo/precio en lotes abiertos cuando cambia la pieza ----
      async function syncOpenLotsWithPartPricing(partId, prevCosto, prevPrecio, newCosto, newPrecio){
        const { data: lots, error } = await sb.from('part_lots')
          .select('id, qty, costo_unit, precio_unit')
          .eq('org_id', orgId())
          .eq('part_id', partId)
          .gt('qty', 0);
        if(error) throw error;

        const ids = (lots||[]).filter(l =>
          Number(l.costo_unit ?? 0) === Number(prevCosto ?? 0) &&
          Number(l.precio_unit ?? 0) === Number(prevPrecio ?? 0)
        ).map(l => l.id);

        if(ids.length){
          const { error: e2 } = await sb.from('part_lots')
            .update({
              costo_unit: Number(newCosto || 0),
              precio_unit: Number(newPrecio || 0)
            })
            .in('id', ids);
          if(e2) throw e2;
        }
      }

      // ---- Imagen de pieza (Storage) ----
      async function uploadPartImage(partId, file){
        const oid = orgId();
        const ext = (file.name||'').split('.').pop() || 'jpg';
        const safeName = (file.name||'foto').replace(/[^\w.\-]+/g,'_');
        const path = `${oid}/${partId}/${Date.now()}_${safeName}`;
        const { error: upErr } = await sb.storage.from('part_images').upload(path, file, {
          cacheControl: '3600', upsert: true, contentType: file.type || 'image/*'
        });
        if(upErr) throw upErr;
        const { data } = sb.storage.from('part_images').getPublicUrl(path);
        return { path, url: data.publicUrl };
      }

      async function deletePartImage(path){
        if(!path) return;
        await sb.storage.from('part_images').remove([path]);
      }

      async function trySetPartImage(partId, url, path){
        const { error } = await sb.from('parts')
          .update({ image_url: url, image_path: path })
          .eq('org_id', orgId())
          .eq('id', partId);
        if(error) throw error;
      }

      // ---- Backup / Restore / Wipe ----
      async function backupAll(){
        const [parts, moves, hist] = await Promise.all([
          listParts(), listMoves(10000), listPriceHistory(10000)
        ]);
        return { parts, moves, priceHistory: hist };
      }

      async function restoreAll(jsonDump){
        if(Array.isArray(jsonDump.parts)){
          for(const p of jsonDump.parts){
            await upsertPart(p);
          }
        }
      }

      async function wipeCurrentOrg(){
        const oid = orgId();
        await sb.from('price_history').delete().eq('org_id', oid);
        await sb.from('movements').delete().eq('org_id', oid);
        await sb.from('part_lots').delete().eq('org_id', oid);
        await sb.from('parts').delete().eq('org_id', oid);
      }

      // ---- Recalcular métricas ----
      async function recomputeMetrics(piezaId){
        if(!piezaId) return;
        const since = new Date(Date.now() - CD_WINDOW_DAYS*24*3600*1000).toISOString();
        const { data: outs, error } = await sb.from('movements')
          .select('cantidad')
          .eq('org_id', orgId())
          .eq('pieza_id', piezaId)
          .eq('tipo','salida')
          .gte('fecha', since);
        if(error) throw error;
        const totalOut = (outs||[]).reduce((s,m)=> s + Number(m.cantidad||0), 0);
        const cd = totalOut / CD_WINDOW_DAYS;
        const stockMin = Math.ceil(cd * SAFETY_DAYS);

        const { error: upErr } = await sb.from('parts')
          .update({ consumo_diario: cd, stock_min: stockMin })
          .eq('id', piezaId).eq('org_id', orgId());
        if(upErr) throw upErr;
      }

      return {
        listParts, getPartById, upsertPart, deletePart,
        listMoves, applyMovement, undoLastMovement, undoMovementById,
        listLots, listAllLots, getInventoryValueByLots,
        addPriceHistory, listPriceHistory,
        uploadPartImage, deletePartImage, trySetPartImage,
        backupAll, restoreAll, wipeCurrentOrg,
        recomputeMetrics,
        syncOpenLotsWithPartPricing   // <--- AÑADIDO
      };
    })();
    
        /* ===== App / Navegación ===== */
    const appEl = document.getElementById('app');
    const view = document.getElementById('view');
    const sidebar = document.getElementById('sidebar');
    const userLabel = document.getElementById('userLabel');
    const logoutBtn = document.getElementById('logoutBtn');
    const PUBLIC_ROUTES = ['login'];

    async function init(){
      await Auth.init();
      if(logoutBtn){
        logoutBtn.addEventListener('click', async () => { await Auth.logout(); location.hash = '#/login'; await route(); });
      }
      if(!Auth.isAuthed()) location.hash = '#/login';
      window.addEventListener('hashchange', route);
      await route();
    }

    function setNavActive(path){
      document.querySelectorAll('.nav-btn').forEach(btn=>{
        btn.classList.toggle('btn-primary', btn.dataset.route === path);
        btn.onclick = ()=>{ location.hash = '#/' + btn.dataset.route; };
      });
    }

    async function route(){
      const hash = location.hash || '#/login';
      const path = (hash.startsWith('#/')) ? hash.slice(2) : 'login';
      const authed = Auth.isAuthed();

      if(authed){
        try { await Org.ensureCurrent(); } catch(e){ /* noop */ }
        sidebar.classList.remove('hidden'); sidebar.setAttribute('aria-hidden','false'); appEl.classList.remove('no-sidebar');
        const u = Auth.currentUser(); const org = Org.get();
        userLabel.textContent = u ? `Conectado como: ${u.email} — Empresa: ${org?.nombre||'—'}` : '';
      }else{
        sidebar.classList.add('hidden'); sidebar.setAttribute('aria-hidden','true'); appEl.classList.add('no-sidebar');
      }

      if(!authed && !PUBLIC_ROUTES.includes(path)){ await renderLogin(); return; }

      switch(path){
        case 'login': await renderLogin(); break;
        case 'reportes': await renderReportes(); break;
        case 'inventario': await renderInventario(); break;
        case 'movimientos': await renderMovimientos(); break;
        case 'sugerencias': await renderSugerencias(); break;
        case 'ajustes': await renderAjustes(); break;
        case 'historial': await renderHistorial(); break;
        default:
          location.hash = authed ? '#/reportes' : '#/login';
          return;
      }
      if(authed) setNavActive(path);
    }

    /* ===== Vistas ===== */

    // ---- Login ----
    async function renderLogin(){
      const tpl = document.getElementById('tpl-login').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const form = document.getElementById('loginForm');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const email = fd.get('email'); const password = fd.get('password');
        const res = await Auth.login(email, password);
        if(!res.ok){ alert(res.error || 'Error al iniciar sesión'); return; }
        location.hash = '#/reportes'; await route();
      });
    }

    // ---- Reportes ----
    let chartTop = null, chartDia = null;
    async function renderReportes(){
      const tpl = document.getElementById('tpl-reportes').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      // Fechas por defecto: últimos 30 días
      const repDesde = document.getElementById('repDesde');
      const repHasta = document.getElementById('repHasta');
      const today = new Date();
      const d0 = new Date(Date.now() - 29*24*3600*1000);
      repDesde.value = d0.toISOString().slice(0,10);
      repHasta.value = today.toISOString().slice(0,10);

      const elBruto = document.getElementById('kpiBruto');
      const elCogs  = document.getElementById('kpiCogs');
      const elLiq   = document.getElementById('kpiLiquida');
      const elUnits = document.getElementById('kpiUnits');
      const elInv   = document.getElementById('kpiInvVal');
      const elSaf   = document.getElementById('kpiSafety');
      const elSkus  = document.getElementById('kpiSkus');
      const elMovs  = document.getElementById('kpiMovs');

      async function run(){
        const parts = await DB.listParts();
        const moves = await DB.listMoves(10000);

        // Filtro por período
        const dFrom = new Date(repDesde.value + 'T00:00:00');
        const dTo   = new Date(repHasta.value + 'T23:59:59');

        // Mapa de piezas
        const pmap = new Map(parts.map(p=>[p.id, p]));

        let bruto=0, cogs=0, units=0, movs=0;
        const byCode = new Map(); // codigo -> unidades
        const byDay  = new Map(); // yyyy-mm-dd -> ingresos

        for(const m of moves){
          const dt = new Date(m.fecha);
          if(dt < dFrom || dt > dTo) continue;
          movs++;
          if(m.tipo === 'salida'){
            const p = pmap.get(m.pieza_id);
            const precio = (m.precio_unit != null) ? Number(m.precio_unit) : Number(p?.precio||0);
            const costo  = (m.costo_unit  != null) ? Number(m.costo_unit ) : Number(p?.costo ||0);
            const q = Number(m.cantidad||0);
            bruto += precio * q;
            cogs  +=  costo * q;
            units += q;

            const k = (p?.codigo || m.codigo || '—');
            byCode.set(k, (byCode.get(k)||0)+q);

            const dayKey = dt.toISOString().slice(0,10);
            byDay.set(dayKey, (byDay.get(dayKey)||0) + precio*q);
          }
        }
        const liq = bruto - cogs;

        // KPIs
        elBruto.textContent = fmtMoney(bruto);
        elCogs.textContent  = fmtMoney(cogs);
        elLiq.textContent   = fmtMoney(liq);
        elUnits.textContent = String(units);
        elSaf.textContent   = String(SAFETY_DAYS);
        elSkus.textContent  = String(parts.length);
        elMovs.textContent  = String(movs);

        // Valor de inventario por lotes
        const invVal = await DB.getInventoryValueByLots();
        elInv.textContent = fmtMoney(invVal);

        // Top 10
        const topArr = Array.from(byCode.entries())
          .sort((a,b)=>b[1]-a[1]).slice(0,10);
        const topLabels = topArr.map(x=>x[0]);
        const topData   = topArr.map(x=>x[1]);

        // Ingresos por día (orden cronológico)
        const days = Array.from(byDay.keys()).sort();
        const revs = days.map(d=> byDay.get(d));

        if(chartTop) chartTop.destroy();
        if(chartDia) chartDia.destroy();

        const ctxTop = document.getElementById('chartTop');
        chartTop = new Chart(ctxTop, {
          type: 'bar',
          data: { labels: topLabels, datasets: [{ label: 'Unidades', data: topData }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }}, scales:{ x:{ ticks:{ maxRotation:0, minRotation:0 } }, y:{ beginAtZero:true, grace:'10%' } } }
        });

        const ctxDia = document.getElementById('chartDia');
        chartDia = new Chart(ctxDia, {
          type: 'line',
          data: { labels: days, datasets: [{ label: 'Ingresos', data: revs }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false }}, scales:{ y:{ beginAtZero:true, grace:'10%' } } }
        });
      }

      document.getElementById('repAplicar').addEventListener('click', run);
      await run();
    }

    // ---- Inventario (botão Imagen por fila) ----
    async function renderInventario(){
      const tpl = document.getElementById('tpl-inventario').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('partsTbody');
      const search = document.getElementById('searchParts');
      const addBtn = document.getElementById('addPartBtn');
      const formWrap = document.getElementById('partFormWrap');
      const form = document.getElementById('partForm');
      const summary = document.getElementById('partFormSummary');
      const cancelBtn = document.getElementById('cancelEdit');
      const importCSV = document.getElementById('importCSV');
      const filterAlm = document.getElementById('filterAlmacen');
      const safety1 = document.getElementById('safetyDaysHint');
      const safety2 = document.getElementById('safetyDaysHint2');
      if(safety1) safety1.textContent = SAFETY_DAYS;
      if(safety2) safety2.textContent = SAFETY_DAYS;

      const imagePicker = document.getElementById('imagePicker');
      let imageTargetPart = null;

      let parts = await DB.listParts();

      function buildFilters(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        filterAlm.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }

      function buildSuggestors(){
        const dlAlm = document.getElementById('dlAlmacenes');
        const almChips = document.getElementById('almacenChips');
        const dlProv = document.getElementById('dlProveedores');
        const provChips = document.getElementById('proveedorChips');

        const almacenes = Array.from(new Set(parts.map(p=> (p.almacen||'').trim()).filter(Boolean))).sort();
        const proveedores = Array.from(new Set(parts.map(p=> (p.proveedor||'').trim()).filter(Boolean))).sort();

        dlAlm.innerHTML = almacenes.map(a=>`<option value="${escapeHtml(a)}">`).join('');
        almChips.innerHTML = almacenes.map(a=>`<button type="button" class="chip" data-v="${escapeHtml(a)}">${escapeHtml(a)}</button>`).join('');

        dlProv.innerHTML = proveedores.map(p=>`<option value="${escapeHtml(p)}">`).join('');
        provChips.innerHTML = proveedores.map(p=>`<button type="button" class="chip" data-v="${escapeHtml(p)}">${escapeHtml(p)}</button>`).join('');

        almChips.onclick = (e)=>{ const b = e.target.closest('.chip'); if(!b) return; form.querySelector('[name="almacen"]').value = b.dataset.v; };
        provChips.onclick = (e)=>{ const b = e.target.closest('.chip'); if(!b) return; form.querySelector('[name="proveedor"]').value = b.dataset.v; };
      }

      function matchesFilters(p){
        const q = (search.value||'').toLowerCase().trim();
        const alm = filterAlm.value || '(Todos)';
        const tokens = [p.codigo, p.nombre, p.categoria, p.proveedor, p.almacen].map(x=>String(x||'').toLowerCase());
        const passQ = !q || tokens.some(t=>t.includes(q));
        const passA = alm === '(Todos)' || String(p.almacen||'').toLowerCase() === alm.toLowerCase();
        return passQ && passA;
      }

      function makeLotsDrawerCell(p){
        const cell = document.createElement('td');
        const det = document.createElement('details');
        det.className = 'inline';
        const sum = document.createElement('summary');
        sum.textContent = 'ver lotes';
        const box = document.createElement('div');
        box.className = 'lots-list';
        box.id = `lots-${p.id}`;
        det.appendChild(sum);
        det.appendChild(box);

        let loaded = false;
        det.addEventListener('toggle', async ()=>{
          if(det.open && !loaded){
            const lots = await DB.listLots(p.id);
            box.innerHTML = lots.length
              ? lots.map(l=> `<span class="lot-chip"><b>${l.qty}</b> unid · C: ${fmtMoney(l.costo_unit)} · P: ${fmtMoney(l.precio_unit)}</span>`).join('')
              : '<span class="muted xs">Sin lotes disponibles</span>';
            loaded = true;
          }
        });
        cell.appendChild(det);
        return cell;
      }

      function partNameCellHTML(p, low){
        const badge = low ? '<span class="badge low">Bajo stock</span>' : '';
        const img = p.imageUrl ? `<img class="thumb" src="${escapeHtml(p.imageUrl)}" alt="">` : '';
        return `${img}${escapeHtml(p.nombre)} ${badge}`;
      }

      async function paint(){
        tbody.innerHTML = '';
        for(const p of parts.filter(matchesFilters)){
          const low = Number(p.stock) < Number(p.stockMin);
          const tr = document.createElement('tr');

          const htmlLeft = `
            <td>${escapeHtml(p.codigo)}</td>
            <td>${partNameCellHTML(p, low)}</td>
            <td>${escapeHtml(p.categoria||'')}</td>
            <td>${escapeHtml(p.almacen||'')}</td>
            <td>${escapeHtml(p.ubicacion||'')}</td>
            <td class="num">${p.stock}</td>
            <td class="num">${p.stockMin}</td>
            <td class="num">${fmtMoney(p.costo)}</td>
            <td class="num">${fmtMoney(p.precio)}</td>
          `;

          tr.innerHTML = htmlLeft;
          tr.appendChild(makeLotsDrawerCell(p));

          const tdAct = document.createElement('td');
          tdAct.className = 'num';
          tdAct.innerHTML = `
            <div class="row-actions" style="justify-content:flex-end">
              <button class="btn" data-act="img" data-id="${p.id}">Imagen</button>
              <button class="btn btn-ghost" data-act="edit" data-id="${p.id}">Editar</button>
              <button class="btn btn-danger" data-act="del" data-id="${p.id}">Eliminar</button>
            </div>
          `;
          tr.appendChild(tdAct);

          tbody.appendChild(tr);
        }
      }

      buildFilters();
      buildSuggestors();
      await paint();

      search.addEventListener('input', paint);
      filterAlm.addEventListener('change', paint);

      const resetFormToNew = ()=>{
        form.reset();
        form.querySelector('input[name="id"]').value = '';
        summary.textContent = 'Nueva pieza';
      };

      addBtn.addEventListener('click', ()=>{
        resetFormToNew();
        formWrap.open = true;
      });
      cancelBtn.addEventListener('click', ()=>{
        resetFormToNew();
        formWrap.open = false;
      });
      document.getElementById('scanBtn').addEventListener('click', startScan);

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const part = {
          id: fd.get('id') || undefined,
          codigo: String(fd.get('codigo')).trim(),
          nombre: String(fd.get('nombre')).trim(),
          categoria: String(fd.get('categoria')||'').trim(),
          ubicacion: String(fd.get('ubicacion')||'').trim(),
          almacen: String(fd.get('almacen')||'').trim(),
          proveedor: String(fd.get('proveedor')||'').trim(),
          leadTimeDias: Number(fd.get('leadTimeDias')||0),
          stock: Number(fd.get('stock')||0), // stock inicial -> lote inicial
          costo: Number(fd.get('costo')||0),
          precio: Number(fd.get('precio')||0),
        };
        if(!part.codigo || !part.nombre){ alert('Código y nombre son obligatorios'); return; }

        let prev = null; if(part.id){ prev = parts.find(x=>x.id===part.id) || await DB.getPartById(part.id); }
        try{
          const newId = await DB.upsertPart(part);
          const finalId = part.id || newId;

          // --- HISTÓRICO + SINCRONÍA DE LOTES ABERTOS (PARCHE) ---
          if(prev && (Number(prev.costo)!==Number(part.costo) || Number(prev.precio)!==Number(part.precio))){
            const u = Auth.currentUser();
            await DB.addPriceHistory({
              piezaId: finalId,
              codigo: prev.codigo, nombre: prev.nombre,
              costoAntes: Number(prev.costo)||0, costoDespues: Number(part.costo)||0,
              precioAntes: Number(prev.precio)||0, precioDespues: Number(part.precio)||0,
              usuario: u ? u.email : ''
            });
            // Sincroniza lotes ABERTOS que ainda estejam com o custo/preço antigo
            await DB.syncOpenLotsWithPartPricing(
              finalId,
              Number(prev.costo)||0, Number(prev.precio)||0,
              Number(part.costo)||0, Number(part.precio)||0
            );
          }
          // --- fim do PARCHE ---

          parts = await DB.listParts();
          buildFilters(); buildSuggestors(); await paint();

          // Se o drawer de lotes desta peça estiver aberto, recarrega a lista para refletir custo/preço novos
          const lotsBox = document.getElementById(`lots-${finalId}`);
          const lotsDet = lotsBox ? lotsBox.closest('details') : null;
          if(lotsDet && lotsDet.open){
            const lots = await DB.listLots(finalId);
            lotsBox.innerHTML = lots.length
              ? lots.map(l=> `<span class="lot-chip"><b>${l.qty}</b> unid · C: ${fmtMoney(l.costo_unit)} · P: ${fmtMoney(l.precio_unit)}</span>`).join('')
              : '<span class="muted xs">Sin lotes disponibles</span>';
          }

          resetFormToNew();
          formWrap.open = false;
          alert('Pieza guardada');
        }catch(err){ alert(err.message || 'No se pudo guardar'); }
      });

      // Acciones por fila (Imagen/Editar/Eliminar)
      document.getElementById('partsTbody').addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-act]'); if(!btn) return;
        const id = btn.dataset.id; const act = btn.dataset.act;

        if(act === 'img'){
          imageTargetPart = parts.find(x => x.id === id) || await DB.getPartById(id);
          if(!imageTargetPart){ alert('Pieza no encontrada'); return; }
          imagePicker.value = '';
          imagePicker.click();
          return;
        }

        if(act === 'edit'){
          const p = parts.find(x => x.id === id) || await DB.getPartById(id); if(!p) return;
          formWrap.open = true; summary.textContent = `Editar: ${p.nombre}`;
          form.querySelector('input[name="id"]').value = p.id;
          form.querySelector('input[name="codigo"]').value = p.codigo;
          form.querySelector('input[name="nombre"]').value = p.nombre;
          form.querySelector('input[name="categoria"]').value = p.categoria || '';
          form.querySelector('input[name="ubicacion"]').value = p.ubicacion || '';
          form.querySelector('input[name="almacen"]').value = p.almacen || '';
          form.querySelector('input[name="proveedor"]').value = p.proveedor || '';
          form.querySelector('input[name="leadTimeDias"]').value = p.leadTimeDias || 0;
          form.querySelector('input[name="consumoDiario"]').value = p.consumoDiario || 0;
          form.querySelector('input[name="stockMin"]').value = p.stockMin || 0;
          form.querySelector('input[name="stock"]').value = p.stock;
          form.querySelector('input[name="costo"]').value = p.costo;
          form.querySelector('input[name="precio"]').value = p.precio;
        }

        if(act === 'del'){
          const p = parts.find(x => x.id === id);
          if(!confirm('¿Eliminar esta pieza? Esto borrará también sus lotes y movimientos.')) return;
          try{
            if(p?.imagePath){ try{ await DB.deletePartImage(p.imagePath); }catch(e){} }
            await DB.deletePart(id);
            parts = await DB.listParts(); buildFilters(); buildSuggestors(); await paint();
          }catch(err){ alert(err.message || 'No se pudo eliminar'); }
        }
      });

      // Upload real quando escolher arquivo
      imagePicker.addEventListener('change', async ()=>{
        const f = imagePicker.files?.[0];
        if(!f){ return; }
        if(!imageTargetPart){ alert('Pieza no seleccionada'); return; }
        try{
          const up = await DB.uploadPartImage(imageTargetPart.id, f);
          await DB.trySetPartImage(imageTargetPart.id, up.url, up.path);
          // se tinha anterior, substituir (apagar antigo)
          if(imageTargetPart.imagePath && imageTargetPart.imagePath !== up.path){
            try{ await DB.deletePartImage(imageTargetPart.imagePath); }catch(e){}
          }
          parts = await DB.listParts();
          await paint();
          alert('Imagen actualizada');
        }catch(e){
          alert(e.message || 'No se pudo subir la imagen');
        }finally{
          imageTargetPart = null;
          imagePicker.value = '';
        }
      });

      // Importador CSV
      importCSV.addEventListener('change', ()=>{
        const f = document.getElementById('importCSV').files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = async ()=>{
          try{
            const lines = String(reader.result||'').split(/\r?\n/).filter(Boolean);
            if(!lines.length){ alert('CSV vacío'); return; }
            const head = lines.shift().split(',').map(h=>h.trim());
            for(const line of lines){
              const cells = parseCSVLine(line);
              const obj = Object.fromEntries(head.map((h,i)=>[h, (cells[i]??'').trim()]));
              const part = {
                codigo: obj.codigo, nombre: obj.nombre, categoria: obj.categoria,
                ubicacion: obj.ubicacion, almacen: obj.almacen, proveedor: obj.proveedor,
                leadTimeDias: Number(obj.leadTimeDias||0),
                stock: Number(obj.stock||0),
                costo: Number(obj.costo_Bs||obj.costo||0),
                precio: Number(obj.precio_Bs||obj.precio||0)
              };
              await DB.upsertPart(part);
            }
            parts = await DB.listParts(); buildFilters(); buildSuggestors(); await paint();
            alert('Importación completa');
          }catch(e){ alert(e.message || 'Error al importar'); }
          document.getElementById('importCSV').value = '';
        };
        reader.readAsText(f);
      });
    }

    // ---- Movimientos ----
    async function renderMovimientos(){
      const tpl = document.getElementById('tpl-movimientos').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const moveForm = document.getElementById('moveForm');
      const partSel = document.getElementById('movePart');
      const tipoSel = document.getElementById('moveTipo');
      const entradaFields = document.getElementById('entradaFields');
      const entradaCosto = document.getElementById('entradaCosto');
      const entradaPrecio = document.getElementById('entradaPrecio');
      const salidaFields = document.getElementById('salidaFields');
      const salidaLoteSel = document.getElementById('salidaLote');
      const salidaLotesInfo = document.getElementById('salidaLotesInfo');
      const tbody = document.getElementById('movesTbody');
      const exportBtn = document.getElementById('exportCSV');
      const undoBtn = document.getElementById('undoLast');
      const almFilter = document.getElementById('moveAlmacenFilter');

      let parts = await DB.listParts();
      let moves = await DB.listMoves(2000);

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        almFilter.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      buildAlmacenOptions();

      function fillPartOptions(){
        const alm = almFilter.value || '(Todos)';
        const list = parts.filter(p => alm === '(Todos)' || String(p.almacen||'').toLowerCase()===alm.toLowerCase());
        partSel.innerHTML = list.map(p=>(
          `<option value="${p.id}">${escapeHtml(p.codigo)} — ${escapeHtml(p.nombre)} (${escapeHtml(p.almacen||'')})</option>`
        )).join('');
      }
      fillPartOptions();

      async function fillMoveLots(){
        if(tipoSel.value !== 'salida'){ salidaFields.style.display='none'; return; }
        const partId = partSel.value;
        if(!partId){ salidaLoteSel.innerHTML = ''; salidaLotesInfo.textContent = ''; return; }
        const lots = await DB.listLots(partId);
        if(!lots.length){
          salidaLoteSel.innerHTML = '';
          salidaLotesInfo.textContent = 'Sin lotes disponibles para esta pieza.';
          return;
        }
        salidaLoteSel.innerHTML = lots.map((l,idx)=>{
          return `<option value="${l.id}">Lote ${idx+1} — Disp: ${l.qty} — C: ${fmtMoney(l.costo_unit)} — P: ${fmtMoney(l.precio_unit)}</option>`;
        }).join('');
        const totalDisp = lots.reduce((s,x)=>s+Number(x.qty||0),0);
        salidaLotesInfo.textContent = `Lotes: ${lots.length} | Disponible total: ${totalDisp}`;
      }

      function toggleMoveFields(){
        const t = tipoSel.value;
        if(t==='entrada'){
          entradaFields.style.display = '';
          salidaFields.style.display = 'none';
        }else{
          entradaFields.style.display = 'none';
          salidaFields.style.display = '';
          fillMoveLots();
        }
      }
      toggleMoveFields();

      function paintMoves(){
        tbody.innerHTML = '';
        moves.forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${fmtDate(m.fecha)}</td>
            <td>${escapeHtml(m.codigo)}</td>
            <td>${escapeHtml(m.nombre)}</td>
            <td>${escapeHtml(m.almacen||'')}</td>
            <td>${m.tipo === 'entrada' ? 'Entrada' : 'Salida'}</td>
            <td class="num">${m.cantidad}</td>
            <td>${escapeHtml(m.referencia||'')}</td>
            <td>${escapeHtml(m.usuario||'')}</td>
            <td class="num"><button class="btn btn-danger" data-undo="${m.id}">Deshacer</button></td>`;
          tbody.appendChild(tr);
        });
      }
      paintMoves();

      almFilter.addEventListener('change', ()=>{ fillPartOptions(); if(tipoSel.value==='salida') fillMoveLots(); });
      partSel.addEventListener('change', ()=>{ if(tipoSel.value==='salida') fillMoveLots(); });
      tipoSel.addEventListener('change', toggleMoveFields);

      moveForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(moveForm);
        const piezaId = fd.get('piezaId'); const tipo = fd.get('tipo');
        const cantidad = Number(fd.get('cantidad')); const referencia = String(fd.get('referencia')||'').trim();
        if(!piezaId || !tipo || !(cantidad>0)){ alert('Complete los campos del movimiento'); return; }
        try{
          const u = Auth.currentUser();
          const payload = { piezaId, tipo, cantidad, referencia, usuarioEmail: u?u.email:'' };

          if(tipo==='entrada'){
            payload.costoUnit = (entradaCosto.value !== '') ? Number(entradaCosto.value) : null;
            payload.precioUnit = (entradaPrecio.value !== '') ? Number(entradaPrecio.value) : null;
          }else{ // salida
            const loteId = salidaLoteSel.value;
            if(!loteId){ alert('Seleccione un lote para la salida'); return; }
            payload.loteId = loteId;
          }

          await DB.applyMovement(payload);
          parts = await DB.listParts(); moves = await DB.listMoves(2000); paintMoves();
          alert('Movimiento registrado');
          moveForm.reset(); fillPartOptions(); toggleMoveFields();
        }catch(err){ alert(err.message || 'Error al aplicar movimiento'); }
      });

      tbody.addEventListener('click', async (e)=>{
        const btn = e.target.closest('button[data-undo]');
        if(!btn) return;
        const id = btn.getAttribute('data-undo');
        if(!confirm('¿Deshacer este movimiento?')) return;
        try{
          await DB.undoMovementById(id);
          moves = await DB.listMoves(2000);
          paintMoves();
          alert('Movimiento deshecho');
        }catch(err){ alert(err.message || 'No se pudo deshacer'); }
      });

      undoBtn.addEventListener('click', async ()=>{
        try{ await DB.undoLastMovement(); moves = await DB.listMoves(2000); paintMoves(); alert('Movimiento deshecho'); }
        catch(e){ alert(e.message || 'No se pudo deshacer'); }
      });

      exportBtn.addEventListener('click', async ()=>{
        const p = await DB.listParts();
        const head = ['id','codigo','nombre','categoria','almacen','proveedor','leadTimeDias','consumoDiario','ubicacion','stock','stockMin','costo_Bs','precio_Bs'];
        const rows = p.map(pt=>{
          const row = { id:pt.id, codigo:pt.codigo, nombre:pt.nombre, categoria:pt.categoria, almacen:pt.almacen, proveedor:pt.proveedor, leadTimeDias:pt.leadTimeDias, consumoDiario:pt.consumoDiario, ubicacion:pt.ubicacion, stock:pt.stock, stockMin:pt.stockMin, costo_Bs:pt.costo, precio_Bs:pt.precio };
          return head.map(k=>csvCell(row[k] ?? '')).join(',');
        });
        const csv = head.join(',') + '\n' + rows.join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = url; a.download = `inventario_${stamp}.csv`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
      });
    }

    // ---- Sugerencias ----
    async function renderSugerencias(){
      const tpl = document.getElementById('tpl-sugerencias').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('sugTbody');
      const almFilter = document.getElementById('sugAlmacenFilter');
      let parts = await DB.listParts();

      function buildAlmacenOptions(){
        const set = new Set(['(Todos)']); parts.forEach(p=>{ if(p.almacen && p.almacen.trim()) set.add(p.almacen.trim()); });
        almFilter.innerHTML = Array.from(set).sort().map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
      }
      buildAlmacenOptions();

      function calcularSugerencias(){
        const alm = almFilter.value || '(Todos)';
        const base = parts.filter(p => alm === '(Todos)' || String(p.almacen||'').toLowerCase()===alm.toLowerCase());
        return base.map(p=>{
          const cd = Number(p.consumoDiario||0);
          const lt = Number(p.leadTimeDias||0);
          const stk = Number(p.stock||0);
          const rop = Math.ceil(cd * (lt + SAFETY_DAYS));
          const sug = Math.max(0, rop - stk);
          return {...p, rop, sugerido:sug};
        }).filter(x=>x.sugerido>0);
      }

      function paint(){
        const list = calcularSugerencias();
        tbody.innerHTML = '';
        list.forEach(p=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(p.codigo)}</td>
            <td>${escapeHtml(p.nombre)}</td>
            <td>${escapeHtml(p.proveedor||'')}</td>
            <td>${escapeHtml(p.almacen||'')}</td>
            <td class="num">${p.stock}</td>
            <td class="num">${p.stockMin}</td>
            <td class="num">${p.consumoDiario||0}</td>
            <td class="num">${p.leadTimeDias||0}</td>
            <td class="num">${p.rop}</td>
            <td class="num">${p.sugerido}</td>`;
          tbody.appendChild(tr);
        });
      }
      almFilter.addEventListener('change', paint); paint();
    }

    // ---- Ajustes ----
    async function renderAjustes(){
      const tpl = document.getElementById('tpl-ajustes').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const backupBtn = document.getElementById('backupBtn');
      const restoreFile = document.getElementById('restoreFile');
      const resetBtn = document.getElementById('resetBtn');

      const orgName = document.getElementById('orgName');
      const orgSelect = document.getElementById('orgSelect');
      const orgNewBtn = document.getElementById('orgNewBtn');

      (async ()=>{
        const orgs = await Org.myOrgs();
        const cur = Org.get();
        orgName.textContent = cur?.nombre || '—';
        orgSelect.innerHTML = orgs.map(o => `<option value="${o.id}" ${o.id===cur.id?'selected':''}>${escapeHtml(o.nombre)}</option>`).join('');
      })();

      orgSelect.addEventListener('change', async ()=>{
        const id = orgSelect.value;
        const { data, error } = await sb.from('orgs').select('id,nombre').eq('id', id).maybeSingle();
        if(error || !data){ alert('No se pudo cambiar de empresa'); return; }
        Org.set(data);
        alert('Empresa cambiada a: ' + data.nombre);
        location.hash = '#/reportes'; await route();
      });

      orgNewBtn.addEventListener('click', async ()=>{
        const nombre = prompt('Nombre de la nueva empresa:'); if(!nombre) return;
        const { data:{ user } } = await sb.auth.getUser();
        const { data: org, error: e1 } = await sb.from('orgs').insert({ nombre, created_by: user?.id }).select().maybeSingle();
        if(e1){ alert(e1.message); return; }
        const { error: e2 } = await sb.from('org_members').insert({ org_id: org.id, user_id: user?.id });
        if(e2){ alert(e2.message); return; }
        Org.set(org);
        alert('Empresa creada y seleccionada: ' + org.nombre);
        location.hash = '#/reportes'; await route();
      });

      backupBtn.addEventListener('click', async ()=>{
        try{
          const dump = await DB.backupAll();
          const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_inventario.json'; a.click();
        }catch(e){ alert(e.message || 'No se pudo hacer backup'); }
      });

      restoreFile.addEventListener('change', async ()=>{
        const f = restoreFile.files[0]; if(!f) return;
        try{
          const data = JSON.parse(await f.text());
          await DB.restoreAll(data);
          alert('Restauración completa'); location.hash = '#/reportes'; await route();
        }catch(e){ alert('Archivo inválido / restauración falló'); }
        finally{ restoreFile.value = ''; }
      });

      resetBtn.addEventListener('click', async ()=>{
        if(!confirm('Esto borrará TODAS las piezas, lotes, movimientos e historial de la EMPRESA ACTUAL. ¿Continuar?')) return;
        try{ await DB.wipeCurrentOrg(); alert('Datos borrados de la empresa actual'); location.hash = '#/reportes'; await route(); }
        catch(e){ alert(e.message || 'No se pudo borrar'); }
      });
    }

    // ---- Historial ----
    async function renderHistorial(){
      const tpl = document.getElementById('tpl-historial').content.cloneNode(true);
      view.innerHTML = ''; view.appendChild(tpl);

      const tbody = document.getElementById('histTbody');
      const hist = await DB.listPriceHistory();
      tbody.innerHTML = '';
      hist.forEach(h=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(h.fecha)}</td>
          <td>${escapeHtml(h.codigo)}</td>
          <td>${escapeHtml(h.nombre)}</td>
          <td class="num">${fmtMoney(h.costoAntes)} ➝ ${fmtMoney(h.costoDespues)}</td>
          <td class="num">${fmtMoney(h.precioAntes)} ➝ ${fmtMoney(h.precioDespues)}</td>
          <td>${escapeHtml(h.usuario||'')}</td>`;
        tbody.appendChild(tr);
      });
    }

    /* --------- Escáner (opcional) --------- */
    async function startScan(){
      try{
        if(!('BarcodeDetector' in window)){ alert('Escáner no soportado; ingrese el código manualmente.'); return; }
        const video = document.getElementById('cam');
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
        video.srcObject = stream; await video.play();
        const det = new BarcodeDetector({formats:['code_128','ean_13','ean_8','qr_code','upc_a','upc_e']});
        const codeInput = document.querySelector('input[name="codigo"]');
        let running = true;
        const stop = ()=>{ running=false; if(video.srcObject){ video.srcObject.getTracks().forEach(t=>t.stop()); } video.srcObject=null; };
        const tick = async ()=>{
          if(!running) return;
          try{ const codes = await det.detect(video);
            if(codes.length){ codeInput.value = codes[0].rawValue || ''; stop(); alert('Código detectado: ' + codeInput.value); return; }
          }catch(e){}
          requestAnimationFrame(tick);
        };
        tick();
      }catch(err){ alert('No se pudo abrir la cámara'); }
    }

    // Boot
    init();
  </script>
</body>
</html>